cscope 15 $HOME/xv6-public               0000169061
	@asm.h

5 
	#SEG_NULLASM
 \

6 .
w‹d
 0, 0; \

7 .
byã
 0, 0, 0, 0

	)

11 
	#SEG_ASM
(
ty≥
, 
ba£
, 
lim
) \

12 .
	`w‹d
(((
lim
Ë>> 12Ë& 0xffff), ((
ba£
)&0xffff); \

13 .
	`byã
(((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

14 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

16 
	#STA_X
 0x8

17 
	#STA_W
 0x2

18 
	#STA_R
 0x2

	@bio.c

21 
	~"ty≥s.h
"

22 
	~"defs.h
"

23 
	~"∑øm.h
"

24 
	~"•ölock.h
"

25 
	~"¶ì∂ock.h
"

26 
	~"fs.h
"

27 
	~"buf.h
"

31 
•ölock
 
	mlock
;

32 
buf
 
	mbuf
[
NBUF
];

36 
buf
 
	mhód
;

37 } 
	gbˇche
;

39 
	$böô
()

41 
buf
 *
b
;

43 
	`öôlock
(&
bˇche
.
lock
, "bcache");

47 
bˇche
.
hód
.
¥ev
 = &bcache.head;

48 
bˇche
.
hód
.
√xt
 = &bcache.head;

49 
b
 = 
bˇche
.
buf
; b < bˇche.bu‡+ 
NBUF
; b++)

51 
b
->
√xt
 = 
bˇche
.
hód
.next;

52 
b
->
¥ev
 = &
bˇche
.
hód
;

53 
	`öô¶ì∂ock
(&
b
->
lock
, "buffer");

54 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

55 
bˇche
.
hód
.
√xt
 = 
b
;

57 
	}
}

62 
buf
 *

63 
	$bgë
(
uöt
 
dev
, uöà
blockno
)

65 
buf
 *
b
;

67 
	`acquúe
(&
bˇche
.
lock
);

70 
b
 = 
bˇche
.
hód
.
√xt
; b != &bcache.head; b = b->next)

72 i‡(
b
->
dev
 =dev && b->
blockno
 == blockno)

74 
b
->
ªf˙t
++;

75 
	`ªÀa£
(&
bˇche
.
lock
);

76 
	`acquúe¶ìp
(&
b
->
lock
);

77  
b
;

84 
b
 = 
bˇche
.
hód
.
¥ev
; b != &bcache.head; b = b->prev)

86 i‡(
b
->
ªf˙t
 =0 && (b->
Êags
 & 
B_DIRTY
) == 0)

88 
b
->
dev
 = dev;

89 
b
->
blockno
 = blockno;

90 
b
->
Êags
 = 0;

91 
b
->
ªf˙t
 = 1;

92 
	`ªÀa£
(&
bˇche
.
lock
);

93 
	`acquúe¶ìp
(&
b
->
lock
);

94  
b
;

97 
	`∑nic
("bget:Ço buffers");

98 
	}
}

101 
buf
 *

102 
	$bªad
(
uöt
 
dev
, uöà
blockno
)

104 
buf
 *
b
;

106 
b
 = 
	`bgë
(
dev
, 
blockno
);

107 i‡((
b
->
Êags
 & 
B_VALID
) == 0)

109 
	`idîw
(
b
);

111  
b
;

112 
	}
}

115 
	$bwrôe
(
buf
 *
b
)

117 i‡(!
	`hﬁdög¶ìp
(&
b
->
lock
))

118 
	`∑nic
("bwrite");

119 
b
->
Êags
 |
B_DIRTY
;

120 
	`idîw
(
b
);

121 
	}
}

125 
	$bªl£
(
buf
 *
b
)

127 i‡(!
	`hﬁdög¶ìp
(&
b
->
lock
))

128 
	`∑nic
("brelse");

130 
	`ªÀa£¶ìp
(&
b
->
lock
);

132 
	`acquúe
(&
bˇche
.
lock
);

133 
b
->
ªf˙t
--;

134 i‡(
b
->
ªf˙t
 == 0)

137 
b
->
√xt
->
¥ev
 = b->prev;

138 
b
->
¥ev
->
√xt
 = b->next;

139 
b
->
√xt
 = 
bˇche
.
hód
.next;

140 
b
->
¥ev
 = &
bˇche
.
hód
;

141 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

142 
bˇche
.
hód
.
√xt
 = 
b
;

145 
	`ªÀa£
(&
bˇche
.
lock
);

146 
	}
}

	@bootasm.S

1 
	~"asm.h
"

2 
	~"memœyout.h
"

3 
	~"mmu.h
"

5 #Sèπ 
the
 
fú°
 
CPU
: 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
, 
jump
 
öto
 
C
.

6 #Thê
BIOS
 
lﬂds
 
this
 
code
 
‰om
 
the
 
fú°
 
£˘‹
 
of
Åhê
h¨d
 
disk
 
öto


7 #mem‹y 
©
 
physiˇl
 
addªss
 0x7c00 
™d
 
°¨ts
 
executög
 
ö
 
ªÆ
 
mode


8 #wôh %
cs
=0 %
ù
=7c00.

10 .
	gcode16
 #As£mbÀ 16-
bô
 
	gmode


11 .
globl
 
°¨t


12 
	g°¨t
:

13 
˛i
 #BIOS 
íabÀd
 
öãºu±s
; 
	gdißbÀ


15 #Zîÿ
d©a
 
£gmít
 
ªgi°îs
 
DS
, 
ES
, 
™d
 
SS
.

16 
	gx‹w
 %
	gax
,%ax #Së %
ax
 
to
 
zîo


17 
	gmovw
 %
	gax
,%
	gds
 #-> 
D©a
 
Segmít


18 
	gmovw
 %
	gax
,%
	ges
 #-> 
Exåa
 
Segmít


19 
	gmovw
 %
	gax
,%
	gss
 #-> 
Sèck
 
	gSegmít


21 #Physiˇ»
addªss
 
löe
 
A20
 
is
 
tõd
 
to
 
zîo
 
so
 
th©
 
the
 
fú°
 
PCs


22 #wôh 2 
MB
 
would
 
run
 
so·w¨e
 
th©
 
assumed
 1 MB. 
Undo
Åhat.

23 
	g£è20
.1:

24 
öb
 
$0x64
,%
	gÆ
 #Waô 
nŸ
 
busy


25 
ã°b
 
	g$0x2
,%
Æ


26 
jnz
 
	g£è20
.1

28 
movb
 
	g$0xd1
,%
	gÆ
 #0
	gxd1
 -> 
	gp‹t
 0x64

29 
	goutb
 %
	gÆ
,
$0x64


31 
	g£è20
.2:

32 
öb
 
$0x64
,%
	gÆ
 #Waô 
nŸ
 
busy


33 
ã°b
 
	g$0x2
,%
Æ


34 
jnz
 
	g£è20
.2

36 
movb
 
	g$0xdf
,%
	gÆ
 #0
	gxdf
 -> 
	gp‹t
 0x60

37 
	goutb
 %
	gÆ
,
	g$0x60


39 #Swôch 
‰om
 
ªÆ
 
to
 
¥Ÿe˘ed
 
mode
. 
U£
 
a
 
boŸ°øp
 
GDT
 
th©
 
makes


40 #vútuÆ 
addªs£s
 
m≠
 
dúe˘ly
 
to
 
physiˇl
áddªs£†
so
 
th©
 
the


41 #ef„˘ivê
mem‹y
 
m≠
 
d€¢
't change duringÅheÅransition.

42 
lgdt
 
gdtdesc


43 
	gmovl
 %
	g¸0
, %
óx


44 
‹l
 
	g$CR0_PE
, %
óx


45 
	gmovl
 %
	góx
, %
	g¸0


48 #Com∂ëê
the
 
å™sôi⁄
 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
 
by
 
usög
 
a
 
jmp


49 #tÿ
ªlﬂd
 %
cs
 
™d
 %
eù
. 
The
 
£gmít
 
des¸ùt‹s
 
¨e
 
£t
 
up
 
wôh
 
no


50 #å™¶©i⁄, 
so
 
th©
 
the
 
m≠pög
 
is
 
°ûl
Åhê
idítôy
 mapping.

51 
ljmp
 
$
(
SEG_KCODE
<<3), 
	g$°¨t32


53 .
	gcode32
 #Tñ»
as£mbÀr
 
to
 
	ggíî©e
 32-
bô
 
code
 
	gnow
.

54 
	g°¨t32
:

55 #Së 
up
 
the
 
¥Ÿe˘ed
-
mode
 
d©a
 
£gmít
 
ªgi°îs


56 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ou∏
d©a
 
£gmít
 
£À˘‹


57 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
D©a
 
Segmít


58 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exåa
 
Segmít


59 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sèck
 
Segmít


60 
movw
 
$0
, %
	gax
 #Zîÿ
£gmíts
 
nŸ
 
ªady
 
u£


61 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


62 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


64 #Së 
up
 
the
 
°ack
 
poöãr
 
™d
 
ˇŒ
 
öto
 
C
.

65 
movl
 
	g$°¨t
, %
e•


66 
ˇŒ
 
	gboŸmaö


68 #I‡
boŸmaö
 
ªtu∫s
 (
ô
 
shouldn
't),Åriggerá Bochs

69 #bªakpoöà
ru¬ög
 
undî
 
Bochs
, 
thí
 
lo›
.

70 
movw
 
$0x8a00
, %
ax
 #0
x8a00
 -> 
p‹t
 0x8a00

71 
movw
 %
ax
, %
dx


72 
outw
 %
ax
, %
dx


73 
movw
 
$0x8´0
, %
ax
 #0
x8´0
 -> 
p‹t
 0x8a00

74 
outw
 %
ax
, %
dx


75 
•ö
:

76 
jmp
 
•ö


78 #BoŸ°ø∞
GDT


79 .
p2Æign
 2 #f‹˚ 4 
byã
 
Æignmít


80 
gdt
:

81 
SEG_NULLASM
 #nuŒ 
£g


82 
SEG_ASM
(
STA_X
|
STA_R
, 0x0, 0xffffffffË#codê
£g


83 
	$SEG_ASM
(
STA_W
, 0x0, 0xffffffffË#d©®
£g


85 
gdtdesc
:

86 .
	`w‹d
 (
gdtdesc
 - 
gdt
 - 1) #sizeof(gdt) - 1

87 .
gdt
 #address gdt

	@bootmain.c

8 
	~"ty≥s.h
"

9 
	~"ñf.h
"

10 
	~"x86.h
"

11 
	~"memœyout.h
"

13 
	#SECTSIZE
 512

	)

15 
ªad£g
(
uch¨
 *, 
uöt
, uint);

17 
	$boŸmaö
()

19 
ñfhdr
 *
ñf
;

20 
¥oghdr
 *
ph
, *
ïh
;

21 (*
íåy
)();

22 
uch¨
 *
∑
;

24 
ñf
 = (
ñfhdr
 *)0x10000;

27 
	`ªad£g
((
uch¨
 *)
ñf
, 4096, 0);

30 i‡(
ñf
->
magic
 !
ELF_MAGIC
)

34 
ph
 = (
¥oghdr
 *)((
uch¨
 *)
ñf
 +Élf->
phoff
);

35 
ïh
 = 
ph
 + 
ñf
->
phnum
;

36 ; 
ph
 < 
ïh
;Öh++)

38 
∑
 = (
uch¨
 *)
ph
->
∑ddr
;

39 
	`ªad£g
(
∑
, 
ph
->
fûesz
,Öh->
off
);

40 i‡(
ph
->
memsz
 >Öh->
fûesz
)

41 
	`°osb
(
∑
 + 
ph
->
fûesz
, 0,Öh->
memsz
 -Öh->filesz);

46 
íåy
 = ((*)())(
ñf
->entry);

47 
	`íåy
();

48 
	}
}

50 
	$waôdisk
()

53 (
	`öb
(0x1F7) & 0xC0) != 0x40)

55 
	}
}

58 
	$ªad£˘
(*
d°
, 
uöt
 
off£t
)

61 
	`waôdisk
();

62 
	`outb
(0x1F2, 1);

63 
	`outb
(0x1F3, 
off£t
);

64 
	`outb
(0x1F4, 
off£t
 >> 8);

65 
	`outb
(0x1F5, 
off£t
 >> 16);

66 
	`outb
(0x1F6, (
off£t
 >> 24) | 0xE0);

67 
	`outb
(0x1F7, 0x20);

70 
	`waôdisk
();

71 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
 / 4);

72 
	}
}

76 
	$ªad£g
(
uch¨
 *
∑
, 
uöt
 
cou¡
, uöà
off£t
)

78 
uch¨
 *
ïa
;

80 
ïa
 = 
∑
 + 
cou¡
;

83 
∑
 -
off£t
 % 
SECTSIZE
;

86 
off£t
 = (off£à/ 
SECTSIZE
) + 1;

91 ; 
∑
 < 
ïa
;Ö®+
SECTSIZE
, 
off£t
++)

92 
	`ªad£˘
(
∑
, 
off£t
);

93 
	}
}

	@buf.h

1 
	sbuf


3 
	mÊags
;

4 
uöt
 
	mdev
;

5 
uöt
 
	mblockno
;

6 
¶ì∂ock
 
	mlock
;

7 
uöt
 
	mªf˙t
;

8 
buf
 *
	m¥ev
;

9 
buf
 *
	m√xt
;

10 
buf
 *
	mq√xt
;

11 
uch¨
 
	md©a
[
BSIZE
];

13 
	#B_VALID
 0x2

14 
	#B_DIRTY
 0x4

	@cat.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	gbuf
[512];

7 
	$ˇt
(
fd
)

9 
n
;

11 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

13 i‡(
	`wrôe
(1, 
buf
, 
n
) !=Ç)

15 
	`¥ötf
(1, "cat: writeÉrror\n");

16 
	`exô
();

19 i‡(
n
 < 0)

21 
	`¥ötf
(1, "cat:ÑeadÉrror\n");

22 
	`exô
();

24 
	}
}

26 
	$maö
(
¨gc
, *
¨gv
[])

28 
fd
, 
i
;

30 i‡(
¨gc
 <= 1)

32 
	`ˇt
(0);

33 
	`exô
();

36 
i
 = 1; i < 
¨gc
; i++)

38 i‡((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0)

40 
	`¥ötf
(1, "ˇt: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

41 
	`exô
();

43 
	`ˇt
(
fd
);

44 
	`˛o£
(
fd
);

46 
	`exô
();

47 
	}
}

	@console.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"å≠s.h
"

9 
	~"•ölock.h
"

10 
	~"¶ì∂ock.h
"

11 
	~"fs.h
"

12 
	~"fûe.h
"

13 
	~"memœyout.h
"

14 
	~"mmu.h
"

15 
	~"¥oc.h
"

16 
	~"x86.h
"

18 
c⁄•utc
();

20 
	g∑nicked
 = 0;

24 
•ölock
 
	mlock
;

25 
	mlockög
;

26 } 
	gc⁄s
;

29 
	$¥ötöt
(
xx
, 
ba£
, 
sign
)

31 
digôs
[] = "0123456789abcdef";

32 
buf
[16];

33 
i
;

34 
uöt
 
x
;

36 i‡(
sign
 && (sig¿
xx
 < 0))

37 
x
 = -
xx
;

39 
x
 = 
xx
;

41 
i
 = 0;

44 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

45 } (
x
 /
ba£
) != 0);

47 i‡(
sign
)

48 
buf
[
i
++] = '-';

50 --
i
 >= 0)

51 
	`c⁄•utc
(
buf
[
i
]);

52 
	}
}

56 
	$˝rötf
(*
fmt
, ...)

58 
i
, 
c
, 
lockög
;

59 
uöt
 *
¨gp
;

60 *
s
;

62 
lockög
 = 
c⁄s
.locking;

63 i‡(
lockög
)

64 
	`acquúe
(&
c⁄s
.
lock
);

66 i‡(
fmt
 == 0)

67 
	`∑nic
("null fmt");

69 
¨gp
 = (
uöt
 *)(*)(&
fmt
 + 1);

70 
i
 = 0; (
c
 = 
fmt
[i] & 0xff) != 0; i++)

72 i‡(
c
 != '%')

74 
	`c⁄•utc
(
c
);

77 
c
 = 
fmt
[++
i
] & 0xff;

78 i‡(
c
 == 0)

80 
c
)

83 
	`¥ötöt
(*
¨gp
++, 10, 1);

87 
	`¥ötöt
(*
¨gp
++, 16, 0);

90 i‡((
s
 = (*)*
¨gp
++) == 0)

91 
s
 = "(null)";

92 ; *
s
; s++)

93 
	`c⁄•utc
(*
s
);

96 
	`c⁄•utc
('%');

100 
	`c⁄•utc
('%');

101 
	`c⁄•utc
(
c
);

106 i‡(
lockög
)

107 
	`ªÀa£
(&
c⁄s
.
lock
);

108 
	}
}

110 
	$∑nic
(*
s
)

112 
i
;

113 
uöt
 
pcs
[10];

115 
	`˛i
();

116 
c⁄s
.
lockög
 = 0;

118 
	`˝rötf
("œpicid %d:Ö™ic: ", 
	`œpicid
());

119 
	`˝rötf
(
s
);

120 
	`˝rötf
("\n");

121 
	`gëˇŒîpcs
(&
s
, 
pcs
);

122 
i
 = 0; i < 10; i++)

123 
	`˝rötf
(" %p", 
pcs
[
i
]);

124 
∑nicked
 = 1;

127 
	}
}

130 
	#BACKSPACE
 0x100

	)

131 
	#CRTPORT
 0x3d4

	)

132 
ush‹t
 *
	g¸t
 = (ush‹à*)
P2V
(0xb8000);

135 
	$cg≠utc
(
c
)

137 
pos
;

140 
	`outb
(
CRTPORT
, 14);

141 
pos
 = 
	`öb
(
CRTPORT
 + 1) << 8;

142 
	`outb
(
CRTPORT
, 15);

143 
pos
 |
	`öb
(
CRTPORT
 + 1);

145 i‡(
c
 == '\n')

146 
pos
 += 80 -Öos % 80;

147 i‡(
c
 =
BACKSPACE
)

149 i‡(
pos
 > 0)

150 --
pos
;

153 
¸t
[
pos
++] = (
c
 & 0xff) | 0x0700;

155 i‡(
pos
 < 0 ||Öos > 25 * 80)

156 
	`∑nic
("pos under/overflow");

158 i‡((
pos
 / 80) >= 24)

160 
	`memmove
(
¸t
, crt + 80, (crt[0]) * 23 * 80);

161 
pos
 -= 80;

162 
	`mem£t
(
¸t
 + 
pos
, 0, (crt[0]) * (24 * 80 -Öos));

165 
	`outb
(
CRTPORT
, 14);

166 
	`outb
(
CRTPORT
 + 1, 
pos
 >> 8);

167 
	`outb
(
CRTPORT
, 15);

168 
	`outb
(
CRTPORT
 + 1, 
pos
);

169 
¸t
[
pos
] = ' ' | 0x0700;

170 
	}
}

172 
	$c⁄•utc
(
c
)

174 i‡(
∑nicked
)

176 
	`˛i
();

181 i‡(
c
 =
BACKSPACE
)

183 
	`u¨çutc
('\b');

184 
	`u¨çutc
(' ');

185 
	`u¨çutc
('\b');

188 
	`u¨çutc
(
c
);

189 
	`cg≠utc
(
c
);

190 
	}
}

192 
	#INPUT_BUF
 128

	)

195 
	mbuf
[
INPUT_BUF
];

196 
uöt
 
	mr
;

197 
uöt
 
	mw
;

198 
uöt
 
	me
;

199 } 
	göput
;

201 
	#C
(
x
) ((x) - '@')

202 

	)

203 
c⁄sﬁeöå
((*
gëc
)())

205 
c
, 
d›rocdump
 = 0;

207 
	`acquúe
(&
c⁄s
.
lock
);

208 (
c
 = 
	`gëc
()) >= 0)

210 
c
)

212 
	`C
('P'):

214 
d›rocdump
 = 1;

216 
	`C
('U'):

217 
öput
.
e
 !öput.
w
 &&

218 
öput
.
buf
[(öput.
e
 - 1Ë% 
INPUT_BUF
] != '\n')

220 
öput
.
e
--;

221 
	`c⁄•utc
(
BACKSPACE
);

224 
	`C
('H'):

226 i‡(
öput
.
e
 !öput.
w
)

228 
öput
.
e
--;

229 
	`c⁄•utc
(
BACKSPACE
);

233 i‡(
c
 !0 && 
öput
.
e
 - i≈ut.
r
 < 
INPUT_BUF
)

235 
c
 = (c == '\r') ? '\n' : c;

236 
öput
.
buf
[öput.
e
++ % 
INPUT_BUF
] = 
c
;

237 
	`c⁄•utc
(
c
);

238 i‡(
c
 ='\n' || c =
	`C
('D'Ë|| 
öput
.
e
 =öput.
r
 + 
INPUT_BUF
)

240 
öput
.
w
 = i≈ut.
e
;

241 
	`wakeup
(&
öput
.
r
);

247 
	`ªÀa£
(&
c⁄s
.
lock
);

248 i‡(
d›rocdump
)

250 
	`¥ocdump
();

252 
	}
}

254 
	$c⁄sﬁîód
(
öode
 *
ù
, *
d°
, 
n
)

256 
uöt
 
èrgë
;

257 
c
;

259 
	`iu∆ock
(
ù
);

260 
èrgë
 = 
n
;

261 
	`acquúe
(&
c⁄s
.
lock
);

262 
n
 > 0)

264 
öput
.
r
 =öput.
w
)

266 i‡(
	`my¥oc
()->
kûÀd
)

268 
	`ªÀa£
(&
c⁄s
.
lock
);

269 
	`ûock
(
ù
);

272 
	`¶ìp
(&
öput
.
r
, &
c⁄s
.
lock
);

274 
c
 = 
öput
.
buf
[öput.
r
++ % 
INPUT_BUF
];

275 i‡(
c
 =
	`C
('D'))

277 i‡(
n
 < 
èrgë
)

281 
öput
.
r
--;

285 *
d°
++ = 
c
;

286 --
n
;

287 i‡(
c
 == '\n')

290 
	`ªÀa£
(&
c⁄s
.
lock
);

291 
	`ûock
(
ù
);

293  
èrgë
 - 
n
;

294 
	}
}

296 
	$c⁄sﬁewrôe
(
öode
 *
ù
, *
buf
, 
n
)

298 
i
;

300 
	`iu∆ock
(
ù
);

301 
	`acquúe
(&
c⁄s
.
lock
);

302 
i
 = 0; i < 
n
; i++)

303 
	`c⁄•utc
(
buf
[
i
] & 0xff);

304 
	`ªÀa£
(&
c⁄s
.
lock
);

305 
	`ûock
(
ù
);

307  
n
;

308 
	}
}

310 
	$c⁄sﬁeöô
()

312 
	`öôlock
(&
c⁄s
.
lock
, "console");

314 
devsw
[
CONSOLE
].
wrôe
 = 
c⁄sﬁewrôe
;

315 
devsw
[
CONSOLE
].
ªad
 = 
c⁄sﬁîód
;

316 
c⁄s
.
lockög
 = 1;

318 
	`iﬂpi˚«bÀ
(
IRQ_KBD
, 0);

319 
	}
}

	@date.h

1 
	sπcd©e


3 
uöt
 
	m£c⁄d
;

4 
uöt
 
	mmöuã
;

5 
uöt
 
	mhour
;

6 
uöt
 
	mday
;

7 
uöt
 
	mm⁄th
;

8 
uöt
 
	myór
;

	@defs.h

1 
	gbuf
;

2 
	gc⁄ãxt
;

3 
	gfûe
;

4 
	göode
;

5 
	gpùe
;

6 
	g¥oc
;

7 
	gπcd©e
;

8 
	g•ölock
;

9 
	g¶ì∂ock
;

10 
	g°©
;

11 
	gsu≥rblock
;

14 
böô
();

15 
buf
 *
bªad
(
uöt
, uint);

16 
bªl£
(
buf
 *);

17 
bwrôe
(
buf
 *);

20 
c⁄sﬁeöô
();

21 
˝rötf
(*, ...);

22 
c⁄sﬁeöå
((*)());

23 
	$∑nic
(*Ë
	`__©åibuã__
((
n‹ëu∫
));

26 
	`exec
(*, **);

29 
fûe
 *
	`fûóŒoc
();

30 
	`fûe˛o£
(
fûe
 *);

31 
fûe
 *
	`fûedup
(file *);

32 
	`fûeöô
();

33 
	`fûîód
(
fûe
 *, *, 
n
);

34 
	`fûe°©
(
fûe
 *, 
°©
 *);

35 
	`fûewrôe
(
fûe
 *, *, 
n
);

38 
	`ªadsb
(
dev
, 
su≥rblock
 *
sb
);

39 
	`dúlök
(
öode
 *, *, 
uöt
);

40 
öode
 *
	`dúlookup
(öodê*, *, 
uöt
 *);

41 
öode
 *
	`üŒoc
(
uöt
, );

42 
öode
 *
	`idup
(inode *);

43 
	`iöô
(
dev
);

44 
	`ûock
(
öode
 *);

45 
	`ùut
(
öode
 *);

46 
	`iu∆ock
(
öode
 *);

47 
	`iu∆ockput
(
öode
 *);

48 
	`iupd©e
(
öode
 *);

49 
	`«mecmp
(const *, const *);

50 
öode
 *
	`«mei
(*);

51 
öode
 *
	`«meù¨ít
(*, *);

52 
	`ªadi
(
öode
 *, *, 
uöt
, uint);

53 
	`°©i
(
öode
 *, 
°©
 *);

54 
	`wrôei
(
öode
 *, *, 
uöt
, uint);

57 
	`ideöô
();

58 
	`ideöå
();

59 
	`idîw
(
buf
 *);

62 
	`iﬂpi˚«bÀ
(
úq
, 
˝u
);

63 
uch¨
 
iﬂpicid
;

64 
	`iﬂpicöô
();

67 *
	`kÆloc
();

68 
	`k‰ì
(*);

69 
	`köô1
(*, *);

70 
	`köô2
(*, *);

73 
	`kbdöå
();

76 
	`cmo°ime
(
πcd©e
 *
r
);

77 
	`œpicid
();

78 vﬁ©ûê
uöt
 *
œpic
;

79 
	`œpi˚oi
();

80 
	`œpicöô
();

81 
	`œpic°¨èp
(
uch¨
, 
uöt
);

82 
	`mi¸odñay
();

85 
	`öôlog
(
dev
);

86 
	`log_wrôe
(
buf
 *);

87 
	`begö_›
();

88 
	`íd_›
();

91 
ismp
;

92 
	`mpöô
();

95 
	`pi˚«bÀ
();

96 
	`picöô
();

99 
	`pùóŒoc
(
fûe
 **, file **);

100 
	`pùe˛o£
(
pùe
 *, );

101 
	`pùîód
(
pùe
 *, *, );

102 
	`pùewrôe
(
pùe
 *, *, );

106 
	`˝uid
();

107 
	`exô
();

108 
	`f‹k
();

109 
	`grow¥oc
();

110 
	`kûl
();

111 
˝u
 *
	`my˝u
();

112 
¥oc
 *
	`my¥oc
();

113 
	`pöô
();

114 
	`¥ocdump
();

115 
	$scheduÀr
(Ë
	`__©åibuã__
((
n‹ëu∫
));

116 
	`sched
();

117 
	`£çroc
(
¥oc
 *);

118 
	`¶ìp
(*, 
•ölock
 *);

119 
	`u£röô
();

120 
	`waô
();

121 
	`wakeup
(*);

122 
	`yõld
();

125 
	`swtch
(
c⁄ãxt
 **, context *);

128 
	`acquúe
(
•ölock
 *);

129 
	`gëˇŒîpcs
(*, 
uöt
 *);

130 
	`hﬁdög
(
•ölock
 *);

131 
	`öôlock
(
•ölock
 *, *);

132 
	`ªÀa£
(
•ölock
 *);

133 
	`push˛i
();

134 
	`p›˛i
();

137 
	`acquúe¶ìp
(
¶ì∂ock
 *);

138 
	`ªÀa£¶ìp
(
¶ì∂ock
 *);

139 
	`hﬁdög¶ìp
(
¶ì∂ock
 *);

140 
	`öô¶ì∂ock
(
¶ì∂ock
 *, *);

143 
	`memcmp
(c⁄° *, c⁄° *, 
uöt
);

144 *
	`memmove
(*, c⁄° *, 
uöt
);

145 *
	`mem£t
(*, , 
uöt
);

146 *
	`ß„°r˝y
(*, const *, );

147 
	`°æí
(const *);

148 
	`°∫cmp
(c⁄° *, c⁄° *, 
uöt
);

149 *
	`°∫˝y
(*, const *, );

152 
	`¨göt
(, *);

153 
	`¨g±r
(, **, );

154 
	`¨g°r
(, **);

155 
	`„tchöt
(
uöt
, *);

156 
	`„tch°r
(
uöt
, **);

157 
	`sysˇŒ
();

160 
	`timîöô
();

163 
	`idtöô
();

164 
uöt
 
ticks
;

165 
	`tvöô
();

166 
•ölock
 
tick¶ock
;

169 
	`u¨töô
();

170 
	`u¨töå
();

171 
	`u¨çutc
();

174 
	`£göô
();

175 
	`kvmÆloc
();

176 
pde_t
 *
	`£tupkvm
();

177 *
	`uva2ka
(
pde_t
 *, *);

178 
	`Ælocuvm
(
pde_t
 *, 
uöt
, uint);

179 
	`dóŒocuvm
(
pde_t
 *, 
uöt
, uint);

180 
	`‰ìvm
(
pde_t
 *);

181 
	`öôuvm
(
pde_t
 *, *, 
uöt
);

182 
	`lﬂduvm
(
pde_t
 *, *, 
öode
 *, 
uöt
, uint);

183 
pde_t
 *
	`c›yuvm
’de_à*, 
uöt
);

184 
	`swôchuvm
(
¥oc
 *);

185 
	`swôchkvm
();

186 
	`c›yout
(
pde_t
 *, 
uöt
, *, uint);

187 
	`˛óΩãu
(
pde_t
 *
pgdú
, *
uva
);

190 
	#NELEM
(
x
Ë((xË/ ((x)[0]))

	)

	@echo.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
i
;

9 
i
 = 1; i < 
¨gc
; i++)

10 
	`¥ötf
(1, "%s%s", 
¨gv
[
i
], i + 1 < 
¨gc
 ? " " : "\n");

11 
	`exô
();

12 
	}
}

	@elf.h

3 
	#ELF_MAGIC
 0x464C457FU

4 

	)

6 
	sñfhdr


8 
uöt
 
	mmagic
;

9 
uch¨
 
	mñf
[12];

10 
ush‹t
 
	mty≥
;

11 
ush‹t
 
	mmachöe
;

12 
uöt
 
	mvîsi⁄
;

13 
uöt
 
	míåy
;

14 
uöt
 
	mphoff
;

15 
uöt
 
	mshoff
;

16 
uöt
 
	mÊags
;

17 
ush‹t
 
	mehsize
;

18 
ush‹t
 
	mphítsize
;

19 
ush‹t
 
	mphnum
;

20 
ush‹t
 
	mshítsize
;

21 
ush‹t
 
	mshnum
;

22 
ush‹t
 
	msh°∫dx
;

26 
	s¥oghdr


28 
uöt
 
	mty≥
;

29 
uöt
 
	moff
;

30 
uöt
 
	mvaddr
;

31 
uöt
 
	m∑ddr
;

32 
uöt
 
	mfûesz
;

33 
uöt
 
	mmemsz
;

34 
uöt
 
	mÊags
;

35 
uöt
 
	mÆign
;

39 
	#ELF_PROG_LOAD
 1

	)

42 
	#ELF_PROG_FLAG_EXEC
 1

	)

43 
	#ELF_PROG_FLAG_WRITE
 2

	)

44 
	#ELF_PROG_FLAG_READ
 4

	)

	@entry.S

1 #Thê
xv6
 
kî√l
 
°¨ts
 
executög
 
ö
 
this
 
fûe
. 
This
 fûê
is
 
löked
 
wôh


2 #thê
kî√l
 
C
 
code
, 
so
 
ô
 
ˇn
 
ª„r
 
to
 kî√»
symbﬁs
 
such
 
as
 
maö
().

3 #Thê
boŸ
 
block
 (
boŸasm
.
S
 
™d
 
boŸmaö
.
c
Ë
jumps
 
to
 
íåy
 
bñow
.

5 #Mu…iboŸ 
hódî
, 
mu…iboŸ
 
boŸ
 
lﬂdîs
 
like
 
GNU
 
Grub
.

7 #
#Usög 
GRUB
 2, 
you
 
ˇn
 
boŸ
 
xv6
 
‰om
 
a
 
fûe
 
°‹ed
 
ö
á

9 #Löux 
fûe
 
sy°em
 
by
 
c›yög
 
kî√l
 
‹
 
kî√lmemfs
 
to
 /
boŸ


10 #™d 
thí
 
addög
 
this
 
míu
 
íåy
:

13 #ösmod 
ext2


14 #£à
roŸ
='(hd0,msdos1)'

15 #£à
kî√l
='/boot/kernel'

17 #mu…iboŸ 
$
{
kî√l
} ${kernel}

21 
	~"asm.h
"

22 
	~"memœyout.h
"

23 
	~"mmu.h
"

24 
	~"∑øm.h
"

26 #Mu…iboŸ 
hódî
. 
D©a
 
to
 
dúe˘
 
mu…iboŸ
 
lﬂdî
.

27 .
	gp2Æign
 2

28 .
	gãxt


29 .
globl
 
mu…iboŸ_hódî


30 
	gmu…iboŸ_hódî
:

31 
	#magic
 0x1badb002

	)

32 
	#Êags
 0

	)

33 .
magic


34 .
Êags


35 .(-
magic
-
Êags
)

37 #By 
c⁄víti⁄
, 
the
 
_°¨t
 
symbﬁ
 
•ecifõs
Åhê
ELF
 
íåy
 
poöt
.

38 #Sö˚ 
we
 
haví
't set up virtual memory yet, ourÉntryÖoint is

39 #thê
physiˇl
 
addªss
 
of
 'entry'.

40 .
globl
 
_°¨t


41 
	g_°¨t
 = 
V2P_WO
(
íåy
)

43 #E¡îög 
xv6
 
⁄
 
boŸ
 
¥o˚ss‹
, 
wôh
 
∑gög
 
off
.

44 .
globl
 
íåy


45 
	gíåy
:

46 #Tu∫ 
⁄
 
∑ge
 
size
 
exãnsi⁄
 4
Mbyã
 
∑ges


47 
movl
 %
¸4
, %
óx


48 
‹l
 
$
(
CR4_PSE
), %
óx


49 
	gmovl
 %
	góx
, %
	g¸4


50 #Së 
∑ge
 
dúe˘‹y


51 
movl
 
$
(
V2P_WO
(
íåypgdú
)), %
óx


52 
	gmovl
 %
	góx
, %
	g¸3


53 #Tu∫ 
⁄
 
∑gög
.

54 
	gmovl
 %
	g¸0
, %
óx


55 
‹l
 
$
(
CR0_PG
|
CR0_WP
), %
óx


56 
	gmovl
 %
	góx
, %
	g¸0


58 #Së 
up
 
the
 
°ack
 
poöãr
.

59 
movl
 
$
(
°ack
 + 
KSTACKSIZE
), %
	ge•


61 #Jum∞
to
 
maö
(), 
™d
 tÿ
executög
 
©


62 #high 
addªs£s
. 
The
 
ödúe˘
 
ˇŒ
 
is
 
√eded
 
beˇu£


63 #thê
as£mbÀr
 
¥odu˚s
 
a
 
PC
-
ªœtive
 
ö°ru˘i⁄


64 #f‹ 
a
 
dúe˘
 
jump
.

65 
mov
 
	g$maö
, %
óx


66 
	gjmp
 *%
	góx


68 .
comm
 
	g°ack
, 
	gKSTACKSIZE


	@entryother.S

1 
	~"asm.h
"

2 
	~"memœyout.h
"

3 
	~"mmu.h
"

5 #Each 
n⁄
-
boŸ
 
CPU
 ("AP"Ë
is
 
°¨ãd
 
up
 
ö
 
ª•⁄£
 
to
 
a
 
STARTUP


6 #IPI 
‰om
 
the
 
boŸ
 
CPU
. 
Se˘i⁄
 
B
.4.2 
of
Åhê
Mu…i
-
Pro˚ss‹


7 #S≥cifiˇti⁄ 
ßys
 
th©
 
the
 
AP
 
wûl
 
°¨t
 
ö
 
ªÆ
 
mode
 
wôh
 
CS
:
IP


8 #£à
to
 
XY00
:0000, 
whîe
 
XY
 
is
 
™
 8-
bô
 
vÆue
 
£¡
 
wôh
 
the


9 #STARTUP. 
Thus
 
this
 
code
 
mu°
 
°¨t
 
©
 
a
 4096-
byã
 
bound¨y
.

10 #
#Beˇu£ 
this
 
code
 
£ts
 
DS
 
to
 
zîo
, 
ô
 
mu°
 
sô


12 #© 
™
 
addªss
 
ö
 
the
 
low
 2^16 
byãs
.

13 #
#SèπŸhî†(
ö
 
maö
.
c
Ë
£nds
 
the
 
STARTUPs
 
⁄e
 
©
 
a
 
time
.

15 #Ià
c›õs
 
this
 
code
 (
°¨t
Ë
©
 0x7000. 
It
 
puts
 
the
 
addªss
 
of


16 #®
√wly
 
Æloˇãd
 
≥r
-
c‹e
 
°ack
 
ö
 
°¨t
-4,
the
 
addªss
 
of
Åhe

17 #∂a˚ 
to
 
jump
Åÿ(
m≥¡î
Ë
ö
 
°¨t
-8, 
™d
 
the
 
physiˇl
 
addªss


18 #o‡
íåypgdú
 
ö
 
°¨t
-12.

19 #
#Thi†
code
 
comböes
 
ñemíts
 
of
 
boŸasm
.
S
 
™d
 
íåy
.S.

22 .
	gcode16


23 .
globl
 
°¨t


24 
	g°¨t
:

25 
˛i


27 #Zîÿ
d©a
 
£gmít
 
ªgi°îs
 
DS
, 
ES
, 
™d
 
SS
.

28 
	gx‹w
 %
	gax
,%
ax


29 
	gmovw
 %
	gax
,%
ds


30 
	gmovw
 %
	gax
,%
es


31 
	gmovw
 %
	gax
,%
	gss


33 #Swôch 
‰om
 
ªÆ
 
to
 
¥Ÿe˘ed
 
mode
. 
U£
 
a
 
boŸ°øp
 
GDT
 
th©
 
makes


34 #vútuÆ 
addªs£s
 
m≠
 
dúe˘ly
 
to
 
physiˇl
áddªs£†
so
 
th©
 
the


35 #ef„˘ivê
mem‹y
 
m≠
 
d€¢
't change duringÅheÅransition.

36 
lgdt
 
gdtdesc


37 
	gmovl
 %
	g¸0
, %
óx


38 
‹l
 
	g$CR0_PE
, %
óx


39 
	gmovl
 %
	góx
, %
	g¸0


41 #Com∂ëê
the
 
å™sôi⁄
 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
 
by
 
usög
 
a
 
jmp


42 #tÿ
ªlﬂd
 %
cs
 
™d
 %
eù
. 
The
 
£gmít
 
des¸ùt‹s
 
¨e
 
£t
 
up
 
wôh
 
no


43 #å™¶©i⁄, 
so
 
th©
 
the
 
m≠pög
 
is
 
°ûl
Åhê
idítôy
 mapping.

44 
ljm∂
 
$
(
SEG_KCODE
<<3), $(
°¨t32
)

47 .
	gcode32
 #Tñ»
as£mbÀr
 
to
 
	ggíî©e
 32-
bô
 
code
 
	gnow
.

48 
	g°¨t32
:

49 #Së 
up
 
the
 
¥Ÿe˘ed
-
mode
 
d©a
 
£gmít
 
ªgi°îs


50 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ou∏
d©a
 
£gmít
 
£À˘‹


51 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
D©a
 
Segmít


52 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exåa
 
Segmít


53 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sèck
 
Segmít


54 
movw
 
$0
, %
	gax
 #Zîÿ
£gmíts
 
nŸ
 
ªady
 
u£


55 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


56 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


58 #Tu∫ 
⁄
 
∑ge
 
size
 
exãnsi⁄
 4
Mbyã
 
∑ges


59 
	gmovl
 %
	g¸4
, %
óx


60 
‹l
 
$
(
CR4_PSE
), %
óx


61 
	gmovl
 %
	góx
, %
	g¸4


62 #U£ 
íåypgdú
 
as
 
our
 
öôül
 
∑ge
 
èbÀ


63 
movl
 (
°¨t
-12), %
óx


64 
	gmovl
 %
	góx
, %
	g¸3


65 #Tu∫ 
⁄
 
∑gög
.

66 
	gmovl
 %
	g¸0
, %
óx


67 
‹l
 
$
(
CR0_PE
|
CR0_PG
|
CR0_WP
), %
óx


68 
	gmovl
 %
	góx
, %
	g¸0


70 #Swôch 
to
 
the
 
°ack
 
Æloˇãd
 
by
 
°¨tŸhîs
()

71 
movl
 (
°¨t
-4), %
	ge•


72 #CÆ»
m≥¡î
()

73 
	gˇŒ
 *(
	g°¨t
-8)

75 
movw
 
	g$0x8a00
, %
ax


76 
	gmovw
 %
	gax
, %
dx


77 
	goutw
 %
	gax
, %
dx


78 
movw
 
	g$0x8´0
, %
ax


79 
	goutw
 %
	gax
, %
dx


80 
	g•ö
:

81 
jmp
 
•ö


83 .
p2Æign
 2

84 
gdt
:

85 
SEG_NULLASM


86 
SEG_ASM
(
STA_X
|
STA_R
, 0, 0xffffffff)

87 
	$SEG_ASM
(
STA_W
, 0, 0xffffffff)

90 
gdtdesc
:

91 .
	`w‹d
 (
gdtdesc
 - 
gdt
 - 1)

92 .
gdt


	@exec.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"mmu.h
"

5 
	~"¥oc.h
"

6 
	~"defs.h
"

7 
	~"x86.h
"

8 
	~"ñf.h
"

10 
	$exec
(*
∑th
, **
¨gv
)

12 *
s
, *
œ°
;

13 
i
, 
off
;

14 
uöt
 
¨gc
, 
sz
, 
•
, 
u°ack
[3 + 
MAXARG
 + 1];

15 
ñfhdr
 
ñf
;

16 
öode
 *
ù
;

17 
¥oghdr
 
ph
;

18 
pde_t
 *
pgdú
, *
ﬁdpgdú
;

19 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

21 
	`begö_›
();

23 i‡((
ù
 = 
	`«mei
(
∑th
)) == 0)

25 
	`íd_›
();

26 
	`˝rötf
("exec: fail\n");

29 
	`ûock
(
ù
);

30 
pgdú
 = 0;

33 i‡(
	`ªadi
(
ù
, (*)&
ñf
, 0, (elf)) != (elf))

34 
bad
;

35 i‡(
ñf
.
magic
 !
ELF_MAGIC
)

36 
bad
;

38 i‡((
pgdú
 = 
	`£tupkvm
()) == 0)

39 
bad
;

42 
sz
 = 0;

43 
i
 = 0, 
off
 = 
ñf
.
phoff
; i <Élf.
phnum
; i++, of‡+(
ph
))

45 i‡(
	`ªadi
(
ù
, (*)&
ph
, 
off
, (ph)) != (ph))

46 
bad
;

47 i‡(
ph
.
ty≥
 !
ELF_PROG_LOAD
)

49 i‡(
ph
.
memsz
 <Öh.
fûesz
)

50 
bad
;

51 i‡(
ph
.
vaddr
 +Öh.
memsz
 <Öh.vaddr)

52 
bad
;

53 i‡((
sz
 = 
	`Ælocuvm
(
pgdú
, sz, 
ph
.
vaddr
 +Öh.
memsz
)) == 0)

54 
bad
;

55 i‡(
ph
.
vaddr
 % 
PGSIZE
 != 0)

56 
bad
;

57 i‡(
	`lﬂduvm
(
pgdú
, (*)
ph
.
vaddr
, 
ù
,Öh.
off
,Öh.
fûesz
) < 0)

58 
bad
;

60 
	`iu∆ockput
(
ù
);

61 
	`íd_›
();

62 
ù
 = 0;

66 
sz
 = 
	`PGROUNDUP
(sz);

67 i‡((
sz
 = 
	`Ælocuvm
(
pgdú
, sz, sz + 2 * 
PGSIZE
)) == 0)

68 
bad
;

69 
	`˛óΩãu
(
pgdú
, (*)(
sz
 - 2 * 
PGSIZE
));

70 
•
 = 
sz
;

73 
¨gc
 = 0; 
¨gv
[argc];árgc++)

75 i‡(
¨gc
 >
MAXARG
)

76 
bad
;

77 
•
 = (• - (
	`°æí
(
¨gv
[
¨gc
]) + 1)) & ~3;

78 i‡(
	`c›yout
(
pgdú
, 
•
, 
¨gv
[
¨gc
], 
	`°æí
(argv[argc]) + 1) < 0)

79 
bad
;

80 
u°ack
[3 + 
¨gc
] = 
•
;

82 
u°ack
[3 + 
¨gc
] = 0;

84 
u°ack
[0] = 0xffffffff;

85 
u°ack
[1] = 
¨gc
;

86 
u°ack
[2] = 
•
 - (
¨gc
 + 1) * 4;

88 
•
 -(3 + 
¨gc
 + 1) * 4;

89 i‡(
	`c›yout
(
pgdú
, 
•
, 
u°ack
, (3 + 
¨gc
 + 1) * 4) < 0)

90 
bad
;

93 
œ°
 = 
s
 = 
∑th
; *s; s++)

94 i‡(*
s
 == '/')

95 
œ°
 = 
s
 + 1;

96 
	`ß„°r˝y
(
cuΩroc
->
«me
, 
œ°
, (curproc->name));

99 
ﬁdpgdú
 = 
cuΩroc
->
pgdú
;

100 
cuΩroc
->
pgdú
 =Ögdir;

101 
cuΩroc
->
sz
 = sz;

102 
cuΩroc
->
tf
->
eù
 = 
ñf
.
íåy
;

103 
cuΩroc
->
tf
->
e•
 = 
•
;

104 
	`swôchuvm
(
cuΩroc
);

105 
	`‰ìvm
(
ﬁdpgdú
);

108 
bad
:

109 i‡(
pgdú
)

110 
	`‰ìvm
(
pgdú
);

111 i‡(
ù
)

113 
	`iu∆ockput
(
ù
);

114 
	`íd_›
();

117 
	}
}

	@fcntl.h

1 
	#O_RDONLY
 0x000

	)

2 
	#O_WRONLY
 0x001

	)

3 
	#O_RDWR
 0x002

	)

4 
	#O_CREATE
 0x200

	)

	@file.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"fs.h
"

9 
	~"•ölock.h
"

10 
	~"¶ì∂ock.h
"

11 
	~"fûe.h
"

13 
devsw
 
	gdevsw
[
NDEV
];

16 
•ölock
 
	mlock
;

17 
fûe
 
	mfûe
[
NFILE
];

18 } 
	g·abÀ
;

20 
	$fûeöô
()

22 
	`öôlock
(&
·abÀ
.
lock
, "ftable");

23 
	}
}

26 
fûe
 *

27 
	$fûóŒoc
()

29 
fûe
 *
f
;

31 
	`acquúe
(&
·abÀ
.
lock
);

32 
f
 = 
·abÀ
.
fûe
; f < fèbÀ.fûê+ 
NFILE
; f++)

34 i‡(
f
->
ªf
 == 0)

36 
f
->
ªf
 = 1;

37 
	`ªÀa£
(&
·abÀ
.
lock
);

38  
f
;

41 
	`ªÀa£
(&
·abÀ
.
lock
);

43 
	}
}

46 
fûe
 *

47 
	$fûedup
(
fûe
 *
f
)

49 
	`acquúe
(&
·abÀ
.
lock
);

50 i‡(
f
->
ªf
 < 1)

51 
	`∑nic
("filedup");

52 
f
->
ªf
++;

53 
	`ªÀa£
(&
·abÀ
.
lock
);

54  
f
;

55 
	}
}

58 
	$fûe˛o£
(
fûe
 *
f
)

60 
fûe
 
ff
;

62 
	`acquúe
(&
·abÀ
.
lock
);

63 i‡(
f
->
ªf
 < 1)

64 
	`∑nic
("fileclose");

65 i‡(--
f
->
ªf
 > 0)

67 
	`ªÀa£
(&
·abÀ
.
lock
);

70 
ff
 = *
f
;

71 
f
->
ªf
 = 0;

72 
f
->
ty≥
 = 
FD_NONE
;

73 
	`ªÀa£
(&
·abÀ
.
lock
);

75 i‡(
ff
.
ty≥
 =
FD_PIPE
)

76 
	`pùe˛o£
(
ff
.
pùe
, ff.
wrôabÀ
);

77 i‡(
ff
.
ty≥
 =
FD_INODE
)

79 
	`begö_›
();

80 
	`ùut
(
ff
.
ù
);

81 
	`íd_›
();

83 
	}
}

86 
	$fûe°©
(
fûe
 *
f
, 
°©
 *
°
)

88 i‡(
f
->
ty≥
 =
FD_INODE
)

90 
	`ûock
(
f
->
ù
);

91 
	`°©i
(
f
->
ù
, 
°
);

92 
	`iu∆ock
(
f
->
ù
);

96 
	}
}

99 
	$fûîód
(
fûe
 *
f
, *
addr
, 
n
)

101 
r
;

103 i‡(
f
->
ªadabÀ
 == 0)

105 i‡(
f
->
ty≥
 =
FD_PIPE
)

106  
	`pùîód
(
f
->
pùe
, 
addr
, 
n
);

107 i‡(
f
->
ty≥
 =
FD_INODE
)

109 
	`ûock
(
f
->
ù
);

110 i‡((
r
 = 
	`ªadi
(
f
->
ù
, 
addr
, f->
off
, 
n
)) > 0)

111 
f
->
off
 +
r
;

112 
	`iu∆ock
(
f
->
ù
);

113  
r
;

115 
	`∑nic
("fileread");

116 
	}
}

120 
	$fûewrôe
(
fûe
 *
f
, *
addr
, 
n
)

122 
r
;

124 i‡(
f
->
wrôabÀ
 == 0)

126 i‡(
f
->
ty≥
 =
FD_PIPE
)

127  
	`pùewrôe
(
f
->
pùe
, 
addr
, 
n
);

128 i‡(
f
->
ty≥
 =
FD_INODE
)

136 
max
 = ((
MAXOPBLOCKS
 - 1 - 1 - 2) / 2) * 512;

137 
i
 = 0;

138 
i
 < 
n
)

140 
n1
 = 
n
 - 
i
;

141 i‡(
n1
 > 
max
)

142 
n1
 = 
max
;

144 
	`begö_›
();

145 
	`ûock
(
f
->
ù
);

146 i‡((
r
 = 
	`wrôei
(
f
->
ù
, 
addr
 + 
i
, f->
off
, 
n1
)) > 0)

147 
f
->
off
 +
r
;

148 
	`iu∆ock
(
f
->
ù
);

149 
	`íd_›
();

151 i‡(
r
 < 0)

153 i‡(
r
 !
n1
)

154 
	`∑nic
("short filewrite");

155 
i
 +
r
;

157  
i
 =
n
 ?Ç : -1;

159 
	`∑nic
("filewrite");

160 
	}
}

	@file.h

1 
	sfûe


5 
	mFD_NONE
,

6 
	mFD_PIPE
,

7 
	mFD_INODE


8 } 
	mty≥
;

9 
	mªf
;

10 
	mªadabÀ
;

11 
	mwrôabÀ
;

12 
pùe
 *
	mpùe
;

13 
öode
 *
	mù
;

14 
uöt
 
	moff
;

18 
	söode


20 
uöt
 
	mdev
;

21 
uöt
 
	möum
;

22 
	mªf
;

23 
¶ì∂ock
 
	mlock
;

24 
	mvÆid
;

26 
	mty≥
;

27 
	mmaj‹
;

28 
	mmö‹
;

29 
	m∆ök
;

30 
uöt
 
	msize
;

31 
uöt
 
	maddrs
[
NDIRECT
 + 1];

36 
	sdevsw


38 (*
	mªad
)(
	möode
 *, *, );

39 (*
	mwrôe
)(
	möode
 *, *, );

42 
devsw
 devsw[];

44 
	#CONSOLE
 1

	)

	@forktest.c

4 
	~"ty≥s.h
"

5 
	~"°©.h
"

6 
	~"u£r.h
"

8 
	#N
 1000

	)

10 
	$¥ötf
(
fd
, c⁄° *
s
, ...)

12 
	`wrôe
(
fd
, 
s
, 
	`°æí
(s));

13 
	}
}

15 
	$f‹kã°
()

17 
n
, 
pid
;

19 
	`¥ötf
(1, "forkÅest\n");

21 
n
 = 0;Ç < 
N
;Ç++)

23 
pid
 = 
	`f‹k
();

24 i‡(
pid
 < 0)

26 i‡(
pid
 == 0)

27 
	`exô
();

30 i‡(
n
 =
N
)

32 
	`¥ötf
(1, "f‹k cœimedÅÿw‹k NÅimes!\n", 
N
);

33 
	`exô
();

36 ; 
n
 > 0;Ç--)

38 i‡(
	`waô
() < 0)

40 
	`¥ötf
(1, "wait stoppedÉarly\n");

41 
	`exô
();

45 i‡(
	`waô
() != -1)

47 
	`¥ötf
(1, "wait gotÅoo many\n");

48 
	`exô
();

51 
	`¥ötf
(1, "forkÅest OK\n");

52 
	}
}

54 
	$maö
()

56 
	`f‹kã°
();

57 
	`exô
();

58 
	}
}

	@fs.c

12 
	~"ty≥s.h
"

13 
	~"defs.h
"

14 
	~"∑øm.h
"

15 
	~"°©.h
"

16 
	~"mmu.h
"

17 
	~"¥oc.h
"

18 
	~"•ölock.h
"

19 
	~"¶ì∂ock.h
"

20 
	~"fs.h
"

21 
	~"buf.h
"

22 
	~"fûe.h
"

24 
	#mö
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

25 
ôrunc
(
öode
 *);

28 
su≥rblock
 
	gsb
;

31 
	$ªadsb
(
dev
, 
su≥rblock
 *
sb
)

33 
buf
 *
bp
;

35 
bp
 = 
	`bªad
(
dev
, 1);

36 
	`memmove
(
sb
, 
bp
->
d©a
, (*sb));

37 
	`bªl£
(
bp
);

38 
	}
}

42 
	$bzîo
(
dev
, 
bno
)

44 
buf
 *
bp
;

46 
bp
 = 
	`bªad
(
dev
, 
bno
);

47 
	`mem£t
(
bp
->
d©a
, 0, 
BSIZE
);

48 
	`log_wrôe
(
bp
);

49 
	`bªl£
(
bp
);

50 
	}
}

55 
uöt


56 
	$bÆloc
(
uöt
 
dev
)

58 
b
, 
bi
, 
m
;

59 
buf
 *
bp
;

61 
bp
 = 0;

62 
b
 = 0; b < 
sb
.
size
; b +
BPB
)

64 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

65 
bi
 = 0; bò< 
BPB
 && 
b
 + bò< 
sb
.
size
; bi++)

67 
m
 = 1 << (
bi
 % 8);

68 i‡((
bp
->
d©a
[
bi
 / 8] & 
m
) == 0)

70 
bp
->
d©a
[
bi
 / 8] |
m
;

71 
	`log_wrôe
(
bp
);

72 
	`bªl£
(
bp
);

73 
	`bzîo
(
dev
, 
b
 + 
bi
);

74  
b
 + 
bi
;

77 
	`bªl£
(
bp
);

79 
	`∑nic
("balloc: out of blocks");

80 
	}
}

84 
	$b‰ì
(
dev
, 
uöt
 
b
)

86 
buf
 *
bp
;

87 
bi
, 
m
;

89 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

90 
bi
 = 
b
 % 
BPB
;

91 
m
 = 1 << (
bi
 % 8);

92 i‡((
bp
->
d©a
[
bi
 / 8] & 
m
) == 0)

93 
	`∑nic
("freeing free block");

94 
bp
->
d©a
[
bi
 / 8] &~
m
;

95 
	`log_wrôe
(
bp
);

96 
	`bªl£
(
bp
);

97 
	}
}

170 
•ölock
 
	mlock
;

171 
öode
 
	möode
[
NINODE
];

172 } 
	giˇche
;

174 
	$iöô
(
dev
)

176 
i
 = 0;

178 
	`öôlock
(&
iˇche
.
lock
, "icache");

179 
i
 = 0; i < 
NINODE
; i++)

181 
	`öô¶ì∂ock
(&
iˇche
.
öode
[
i
].
lock
, "inode");

184 
	`ªadsb
(
dev
, &
sb
);

185 
	`˝rötf
("sb: size %dÇblocks %dÇinodes %dÇlog %dÜogstart %d\
 %d bmap start %d\n",

187 
sb
.
size
, sb.
nblocks
,

188 
sb
.
nöodes
, sb.
∆og
, sb.
log°¨t
, sb.
öode°¨t
,

189 
sb
.
bm≠°¨t
);

190 
	}
}

192 
öode
 *
igë
(
uöt
 
dev
, uöà
öum
);

198 
öode
 *

199 
	$üŒoc
(
uöt
 
dev
, 
ty≥
)

201 
öum
;

202 
buf
 *
bp
;

203 
döode
 *
dù
;

205 
öum
 = 1; inum < 
sb
.
nöodes
; inum++)

207 
bp
 = 
	`bªad
(
dev
, 
	`IBLOCK
(
öum
, 
sb
));

208 
dù
 = (
döode
 *)
bp
->
d©a
 + 
öum
 % 
IPB
;

209 i‡(
dù
->
ty≥
 == 0)

211 
	`mem£t
(
dù
, 0, (*dip));

212 
dù
->
ty≥
 =Åype;

213 
	`log_wrôe
(
bp
);

214 
	`bªl£
(
bp
);

215  
	`igë
(
dev
, 
öum
);

217 
	`bªl£
(
bp
);

219 
	`∑nic
("ialloc:Ço inodes");

220 
	}
}

226 
	$iupd©e
(
öode
 *
ù
)

228 
buf
 *
bp
;

229 
döode
 *
dù
;

231 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

232 
dù
 = (
döode
 *)
bp
->
d©a
 + 
ù
->
öum
 % 
IPB
;

233 
dù
->
ty≥
 = 
ù
->type;

234 
dù
->
maj‹
 = 
ù
->major;

235 
dù
->
mö‹
 = 
ù
->minor;

236 
dù
->
∆ök
 = 
ù
->nlink;

237 
dù
->
size
 = 
ù
->size;

238 
	`memmove
(
dù
->
addrs
, 
ù
->addrs, (ip->addrs));

239 
	`log_wrôe
(
bp
);

240 
	`bªl£
(
bp
);

241 
	}
}

246 
öode
 *

247 
	$igë
(
uöt
 
dev
, uöà
öum
)

249 
öode
 *
ù
, *
em±y
;

251 
	`acquúe
(&
iˇche
.
lock
);

254 
em±y
 = 0;

255 
ù
 = &
iˇche
.
öode
[0]; i∞< &iˇche.öode[
NINODE
]; ip++)

257 i‡(
ù
->
ªf
 > 0 && ip->
dev
 =dev && ip->
öum
 == inum)

259 
ù
->
ªf
++;

260 
	`ªÀa£
(&
iˇche
.
lock
);

261  
ù
;

263 i‡(
em±y
 =0 && 
ù
->
ªf
 == 0)

264 
em±y
 = 
ù
;

268 i‡(
em±y
 == 0)

269 
	`∑nic
("iget:Ço inodes");

271 
ù
 = 
em±y
;

272 
ù
->
dev
 = dev;

273 
ù
->
öum
 = inum;

274 
ù
->
ªf
 = 1;

275 
ù
->
vÆid
 = 0;

276 
	`ªÀa£
(&
iˇche
.
lock
);

278  
ù
;

279 
	}
}

283 
öode
 *

284 
	$idup
(
öode
 *
ù
)

286 
	`acquúe
(&
iˇche
.
lock
);

287 
ù
->
ªf
++;

288 
	`ªÀa£
(&
iˇche
.
lock
);

289  
ù
;

290 
	}
}

294 
	$ûock
(
öode
 *
ù
)

296 
buf
 *
bp
;

297 
döode
 *
dù
;

299 i‡(
ù
 =0 || ip->
ªf
 < 1)

300 
	`∑nic
("ilock");

302 
	`acquúe¶ìp
(&
ù
->
lock
);

304 i‡(
ù
->
vÆid
 == 0)

306 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

307 
dù
 = (
döode
 *)
bp
->
d©a
 + 
ù
->
öum
 % 
IPB
;

308 
ù
->
ty≥
 = 
dù
->type;

309 
ù
->
maj‹
 = 
dù
->major;

310 
ù
->
mö‹
 = 
dù
->minor;

311 
ù
->
∆ök
 = 
dù
->nlink;

312 
ù
->
size
 = 
dù
->size;

313 
	`memmove
(
ù
->
addrs
, 
dù
->addrs, (ip->addrs));

314 
	`bªl£
(
bp
);

315 
ù
->
vÆid
 = 1;

316 i‡(
ù
->
ty≥
 == 0)

317 
	`∑nic
("ilock:ÇoÅype");

319 
	}
}

322 
	$iu∆ock
(
öode
 *
ù
)

324 i‡(
ù
 =0 || !
	`hﬁdög¶ìp
(&ù->
lock
Ë|| ip->
ªf
 < 1)

325 
	`∑nic
("iunlock");

327 
	`ªÀa£¶ìp
(&
ù
->
lock
);

328 
	}
}

337 
	$ùut
(
öode
 *
ù
)

339 
	`acquúe¶ìp
(&
ù
->
lock
);

340 i‡(
ù
->
vÆid
 && ip->
∆ök
 == 0)

342 
	`acquúe
(&
iˇche
.
lock
);

343 
r
 = 
ù
->
ªf
;

344 
	`ªÀa£
(&
iˇche
.
lock
);

345 i‡(
r
 == 1)

348 
	`ôrunc
(
ù
);

349 
ù
->
ty≥
 = 0;

350 
	`iupd©e
(
ù
);

351 
ù
->
vÆid
 = 0;

354 
	`ªÀa£¶ìp
(&
ù
->
lock
);

356 
	`acquúe
(&
iˇche
.
lock
);

357 
ù
->
ªf
--;

358 
	`ªÀa£
(&
iˇche
.
lock
);

359 
	}
}

362 
	$iu∆ockput
(
öode
 *
ù
)

364 
	`iu∆ock
(
ù
);

365 
	`ùut
(
ù
);

366 
	}
}

378 
uöt


379 
	$bm≠
(
öode
 *
ù
, 
uöt
 
bn
)

381 
uöt
 
addr
, *
a
;

382 
buf
 *
bp
;

384 i‡(
bn
 < 
NDIRECT
)

386 i‡((
addr
 = 
ù
->
addrs
[
bn
]) == 0)

387 
ù
->
addrs
[
bn
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

388  
addr
;

390 
bn
 -
NDIRECT
;

392 i‡(
bn
 < 
NINDIRECT
)

395 i‡((
addr
 = 
ù
->
addrs
[
NDIRECT
]) == 0)

396 
ù
->
addrs
[
NDIRECT
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

397 
bp
 = 
	`bªad
(
ù
->
dev
, 
addr
);

398 
a
 = (
uöt
 *)
bp
->
d©a
;

399 i‡((
addr
 = 
a
[
bn
]) == 0)

401 
a
[
bn
] = 
addr
 = 
	`bÆloc
(
ù
->
dev
);

402 
	`log_wrôe
(
bp
);

404 
	`bªl£
(
bp
);

405  
addr
;

408 
	`∑nic
("bmap: out ofÑange");

409 
	}
}

417 
	$ôrunc
(
öode
 *
ù
)

419 
i
, 
j
;

420 
buf
 *
bp
;

421 
uöt
 *
a
;

423 
i
 = 0; i < 
NDIRECT
; i++)

425 i‡(
ù
->
addrs
[
i
])

427 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
i
]);

428 
ù
->
addrs
[
i
] = 0;

432 i‡(
ù
->
addrs
[
NDIRECT
])

434 
bp
 = 
	`bªad
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

435 
a
 = (
uöt
 *)
bp
->
d©a
;

436 
j
 = 0; j < 
NINDIRECT
; j++)

438 i‡(
a
[
j
])

439 
	`b‰ì
(
ù
->
dev
, 
a
[
j
]);

441 
	`bªl£
(
bp
);

442 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

443 
ù
->
addrs
[
NDIRECT
] = 0;

446 
ù
->
size
 = 0;

447 
	`iupd©e
(
ù
);

448 
	}
}

452 
	$°©i
(
öode
 *
ù
, 
°©
 *
°
)

454 
°
->
dev
 = 
ù
->dev;

455 
°
->
öo
 = 
ù
->
öum
;

456 
°
->
ty≥
 = 
ù
->type;

457 
°
->
∆ök
 = 
ù
->nlink;

458 
°
->
size
 = 
ù
->size;

459 
	}
}

464 
	$ªadi
(
öode
 *
ù
, *
d°
, 
uöt
 
off
, uöà
n
)

466 
uöt
 
tŸ
, 
m
;

467 
buf
 *
bp
;

469 i‡(
ù
->
ty≥
 =
T_DEV
)

471 i‡(
ù
->
maj‹
 < 0 || ip->maj‹ >
NDEV
 || !
devsw
[ù->maj‹].
ªad
)

473  
devsw
[
ù
->
maj‹
].
	`ªad
(ù, 
d°
, 
n
);

476 i‡(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

478 i‡(
off
 + 
n
 > 
ù
->
size
)

479 
n
 = 
ù
->
size
 - 
off
;

481 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
, 
off
 +m, 
d°
 += m)

483 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
 / 
BSIZE
));

484 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
 % BSIZE);

485 
	`memmove
(
d°
, 
bp
->
d©a
 + 
off
 % 
BSIZE
, 
m
);

486 
	`bªl£
(
bp
);

488  
n
;

489 
	}
}

494 
	$wrôei
(
öode
 *
ù
, *
§c
, 
uöt
 
off
, uöà
n
)

496 
uöt
 
tŸ
, 
m
;

497 
buf
 *
bp
;

499 i‡(
ù
->
ty≥
 =
T_DEV
)

501 i‡(
ù
->
maj‹
 < 0 || ip->maj‹ >
NDEV
 || !
devsw
[ù->maj‹].
wrôe
)

503  
devsw
[
ù
->
maj‹
].
	`wrôe
(ù, 
§c
, 
n
);

506 i‡(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

508 i‡(
off
 + 
n
 > 
MAXFILE
 * 
BSIZE
)

511 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
, 
off
 +m, 
§c
 += m)

513 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
 / 
BSIZE
));

514 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
 % BSIZE);

515 
	`memmove
(
bp
->
d©a
 + 
off
 % 
BSIZE
, 
§c
, 
m
);

516 
	`log_wrôe
(
bp
);

517 
	`bªl£
(
bp
);

520 i‡(
n
 > 0 && 
off
 > 
ù
->
size
)

522 
ù
->
size
 = 
off
;

523 
	`iupd©e
(
ù
);

525  
n
;

526 
	}
}

531 
	$«mecmp
(c⁄° *
s
, c⁄° *
t
)

533  
	`°∫cmp
(
s
, 
t
, 
DIRSIZ
);

534 
	}
}

538 
öode
 *

539 
	$dúlookup
(
öode
 *
dp
, *
«me
, 
uöt
 *
poff
)

541 
uöt
 
off
, 
öum
;

542 
dúít
 
de
;

544 i‡(
dp
->
ty≥
 !
T_DIR
)

545 
	`∑nic
("dirlookupÇot DIR");

547 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
))

549 i‡(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

550 
	`∑nic
("dirlookupÑead");

551 i‡(
de
.
öum
 == 0)

553 i‡(
	`«mecmp
(
«me
, 
de
.name) == 0)

556 i‡(
poff
)

557 *
poff
 = 
off
;

558 
öum
 = 
de
.inum;

559  
	`igë
(
dp
->
dev
, 
öum
);

564 
	}
}

567 
	$dúlök
(
öode
 *
dp
, *
«me
, 
uöt
 
öum
)

569 
off
;

570 
dúít
 
de
;

571 
öode
 *
ù
;

574 i‡((
ù
 = 
	`dúlookup
(
dp
, 
«me
, 0)) != 0)

576 
	`ùut
(
ù
);

581 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
))

583 i‡(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

584 
	`∑nic
("dirlinkÑead");

585 i‡(
de
.
öum
 == 0)

589 
	`°∫˝y
(
de
.
«me
,Çame, 
DIRSIZ
);

590 
de
.
öum
 = inum;

591 i‡(
	`wrôei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

592 
	`∑nic
("dirlink");

595 
	}
}

613 
	$skùñem
(*
∑th
, *
«me
)

615 *
s
;

616 
Àn
;

618 *
∑th
 == '/')

619 
∑th
++;

620 i‡(*
∑th
 == 0)

622 
s
 = 
∑th
;

623 *
∑th
 != '/' && *path != 0)

624 
∑th
++;

625 
Àn
 = 
∑th
 - 
s
;

626 i‡(
Àn
 >
DIRSIZ
)

627 
	`memmove
(
«me
, 
s
, 
DIRSIZ
);

630 
	`memmove
(
«me
, 
s
, 
Àn
);

631 
«me
[
Àn
] = 0;

633 *
∑th
 == '/')

634 
∑th
++;

635  
∑th
;

636 
	}
}

642 
öode
 *

643 
	$«mex
(*
∑th
, 
«meù¨ít
, *
«me
)

645 
öode
 *
ù
, *
√xt
;

647 i‡(*
∑th
 == '/')

648 
ù
 = 
	`igë
(
ROOTDEV
, 
ROOTINO
);

650 
ù
 = 
	`idup
(
	`my¥oc
()->
cwd
);

652 (
∑th
 = 
	`skùñem
’©h, 
«me
)) != 0)

654 
	`ûock
(
ù
);

655 i‡(
ù
->
ty≥
 !
T_DIR
)

657 
	`iu∆ockput
(
ù
);

660 i‡(
«meù¨ít
 && *
∑th
 == '\0')

663 
	`iu∆ock
(
ù
);

664  
ù
;

666 i‡((
√xt
 = 
	`dúlookup
(
ù
, 
«me
, 0)) == 0)

668 
	`iu∆ockput
(
ù
);

671 
	`iu∆ockput
(
ù
);

672 
ù
 = 
√xt
;

674 i‡(
«meù¨ít
)

676 
	`ùut
(
ù
);

679  
ù
;

680 
	}
}

682 
öode
 *

683 
	$«mei
(*
∑th
)

685 
«me
[
DIRSIZ
];

686  
	`«mex
(
∑th
, 0, 
«me
);

687 
	}
}

689 
öode
 *

690 
	$«meù¨ít
(*
∑th
, *
«me
)

692  
	`«mex
(
∑th
, 1, 
«me
);

693 
	}
}

	@fs.h

4 
	#ROOTINO
 1

5 
	#BSIZE
 512

6 

	)

13 
	ssu≥rblock


15 
uöt
 
	msize
;

16 
uöt
 
	mnblocks
;

17 
uöt
 
	mnöodes
;

18 
uöt
 
	m∆og
;

19 
uöt
 
	mlog°¨t
;

20 
uöt
 
	möode°¨t
;

21 
uöt
 
	mbm≠°¨t
;

24 
	#NDIRECT
 12

	)

25 
	#NINDIRECT
 (
BSIZE
 / (
uöt
))

	)

26 
	#MAXFILE
 (
NDIRECT
 + 
NINDIRECT
)

	)

29 
	sdöode


31 
	mty≥
;

32 
	mmaj‹
;

33 
	mmö‹
;

34 
	m∆ök
;

35 
uöt
 
	msize
;

36 
uöt
 
	maddrs
[
NDIRECT
 + 1];

40 
	#IPB
 (
BSIZE
 / (
döode
))

	)

43 
	#IBLOCK
(
i
, 
sb
Ë((iË/ 
IPB
 + sb.
öode°¨t
)

	)

46 
	#BPB
 (
BSIZE
 * 8)

	)

49 
	#BBLOCK
(
b
, 
sb
Ë(b / 
BPB
 + sb.
bm≠°¨t
)

	)

52 
	#DIRSIZ
 14

	)

54 
	sdúít


56 
ush‹t
 
	möum
;

57 
	m«me
[
DIRSIZ
];

	@grep.c

3 
	~"ty≥s.h
"

4 
	~"°©.h
"

5 
	~"u£r.h
"

7 
	gbuf
[1024];

8 
m©ch
(*, *);

10 
	$gªp
(*
∑âîn
, 
fd
)

12 
n
, 
m
;

13 *
p
, *
q
;

15 
m
 = 0;

16 (
n
 = 
	`ªad
(
fd
, 
buf
 + 
m
, (buf) - m - 1)) > 0)

18 
m
 +
n
;

19 
buf
[
m
] = '\0';

20 
p
 = 
buf
;

21 (
q
 = 
	`°rchr
(
p
, '\n')) != 0)

23 *
q
 = 0;

24 i‡(
	`m©ch
(
∑âîn
, 
p
))

26 *
q
 = '\n';

27 
	`wrôe
(1, 
p
, 
q
 + 1 -Ö);

29 
p
 = 
q
 + 1;

31 i‡(
p
 =
buf
)

32 
m
 = 0;

33 i‡(
m
 > 0)

35 
m
 -
p
 - 
buf
;

36 
	`memmove
(
buf
, 
p
, 
m
);

39 
	}
}

41 
	$maö
(
¨gc
, *
¨gv
[])

43 
fd
, 
i
;

44 *
∑âîn
;

46 i‡(
¨gc
 <= 1)

48 
	`¥ötf
(2, "usage: grepÖattern [file ...]\n");

49 
	`exô
();

51 
∑âîn
 = 
¨gv
[1];

53 i‡(
¨gc
 <= 2)

55 
	`gªp
(
∑âîn
, 0);

56 
	`exô
();

59 
i
 = 2; i < 
¨gc
; i++)

61 i‡((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0)

63 
	`¥ötf
(1, "gªp: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

64 
	`exô
();

66 
	`gªp
(
∑âîn
, 
fd
);

67 
	`˛o£
(
fd
);

69 
	`exô
();

70 
	}
}

75 
m©chhîe
(*, *);

76 
m©ch°¨
(, *, *);

78 
	$m©ch
(*
ª
, *
ãxt
)

80 i‡(
ª
[0] == '^')

81  
	`m©chhîe
(
ª
 + 1, 
ãxt
);

84 i‡(
	`m©chhîe
(
ª
, 
ãxt
))

86 } *
ãxt
++ != '\0');

88 
	}
}

91 
	$m©chhîe
(*
ª
, *
ãxt
)

93 i‡(
ª
[0] == '\0')

95 i‡(
ª
[1] == '*')

96  
	`m©ch°¨
(
ª
[0],Ñê+ 2, 
ãxt
);

97 i‡(
ª
[0] == '$' &&Ñe[1] == '\0')

98  *
ãxt
 == '\0';

99 i‡(*
ãxt
 !'\0' && (
ª
[0] == '.' ||Ñe[0] == *text))

100  
	`m©chhîe
(
ª
 + 1, 
ãxt
 + 1);

102 
	}
}

105 
	$m©ch°¨
(
c
, *
ª
, *
ãxt
)

109 i‡(
	`m©chhîe
(
ª
, 
ãxt
))

111 } *
ãxt
 !'\0' && (*ãxt++ =
c
 || c == '.'));

113 
	}
}

	@ide.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"memœyout.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

9 
	~"x86.h
"

10 
	~"å≠s.h
"

11 
	~"•ölock.h
"

12 
	~"¶ì∂ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
	#SECTOR_SIZE
 512

	)

17 
	#IDE_BSY
 0x80

	)

18 
	#IDE_DRDY
 0x40

	)

19 
	#IDE_DF
 0x20

	)

20 
	#IDE_ERR
 0x01

	)

22 
	#IDE_CMD_READ
 0x20

	)

23 
	#IDE_CMD_WRITE
 0x30

	)

24 
	#IDE_CMD_RDMUL
 0xc4

	)

25 
	#IDE_CMD_WRMUL
 0xc5

	)

31 
•ölock
 
	gidñock
;

32 
buf
 *
	gidequeue
;

34 
	ghavedisk1
;

35 
ide°¨t
(
buf
 *);

39 
	$idewaô
(
checkîr
)

41 
r
;

43 ((
r
 = 
	`öb
(0x1f7)Ë& (
IDE_BSY
 | 
IDE_DRDY
)) != IDE_DRDY)

45 i‡(
checkîr
 && (
r
 & (
IDE_DF
 | 
IDE_ERR
)) != 0)

48 
	}
}

50 
	$ideöô
()

52 
i
;

54 
	`öôlock
(&
idñock
, "ide");

55 
	`iﬂpi˚«bÀ
(
IRQ_IDE
, 
n˝u
 - 1);

56 
	`idewaô
(0);

59 
	`outb
(0x1f6, 0xe0 | (1 << 4));

60 
i
 = 0; i < 1000; i++)

62 i‡(
	`öb
(0x1f7) != 0)

64 
havedisk1
 = 1;

70 
	`outb
(0x1f6, 0xe0 | (0 << 4));

71 
	}
}

75 
	$ide°¨t
(
buf
 *
b
)

77 i‡(
b
 == 0)

78 
	`∑nic
("idestart");

79 i‡(
b
->
blockno
 >
FSSIZE
)

80 
	`∑nic
("incorrect blockno");

81 
£˘‹_≥r_block
 = 
BSIZE
 / 
SECTOR_SIZE
;

82 
£˘‹
 = 
b
->
blockno
 * 
£˘‹_≥r_block
;

83 
ªad_cmd
 = (
£˘‹_≥r_block
 =1Ë? 
IDE_CMD_READ
 : 
IDE_CMD_RDMUL
;

84 
wrôe_cmd
 = (
£˘‹_≥r_block
 =1Ë? 
IDE_CMD_WRITE
 : 
IDE_CMD_WRMUL
;

86 i‡(
£˘‹_≥r_block
 > 7)

87 
	`∑nic
("idestart");

89 
	`idewaô
(0);

90 
	`outb
(0x3f6, 0);

91 
	`outb
(0x1f2, 
£˘‹_≥r_block
);

92 
	`outb
(0x1f3, 
£˘‹
 & 0xff);

93 
	`outb
(0x1f4, (
£˘‹
 >> 8) & 0xff);

94 
	`outb
(0x1f5, (
£˘‹
 >> 16) & 0xff);

95 
	`outb
(0x1f6, 0xe0 | ((
b
->
dev
 & 1Ë<< 4Ë| ((
£˘‹
 >> 24) & 0x0f));

96 i‡(
b
->
Êags
 & 
B_DIRTY
)

98 
	`outb
(0x1f7, 
wrôe_cmd
);

99 
	`out¶
(0x1f0, 
b
->
d©a
, 
BSIZE
 / 4);

103 
	`outb
(0x1f7, 
ªad_cmd
);

105 
	}
}

108 
	$ideöå
()

110 
buf
 *
b
;

113 
	`acquúe
(&
idñock
);

115 i‡((
b
 = 
idequeue
) == 0)

117 
	`ªÀa£
(&
idñock
);

120 
idequeue
 = 
b
->
q√xt
;

123 i‡(!(
b
->
Êags
 & 
B_DIRTY
Ë&& 
	`idewaô
(1) >= 0)

124 
	`ö¶
(0x1f0, 
b
->
d©a
, 
BSIZE
 / 4);

127 
b
->
Êags
 |
B_VALID
;

128 
b
->
Êags
 &~
B_DIRTY
;

129 
	`wakeup
(
b
);

132 i‡(
idequeue
 != 0)

133 
	`ide°¨t
(
idequeue
);

135 
	`ªÀa£
(&
idñock
);

136 
	}
}

142 
	$idîw
(
buf
 *
b
)

144 
buf
 **
µ
;

146 i‡(!
	`hﬁdög¶ìp
(&
b
->
lock
))

147 
	`∑nic
("iderw: bufÇotÜocked");

148 i‡((
b
->
Êags
 & (
B_VALID
 | 
B_DIRTY
)) == B_VALID)

149 
	`∑nic
("iderw:ÇothingÅo do");

150 i‡(
b
->
dev
 !0 && !
havedisk1
)

151 
	`∑nic
("iderw: ide disk 1ÇotÖresent");

153 
	`acquúe
(&
idñock
);

156 
b
->
q√xt
 = 0;

157 
µ
 = &
idequeue
; *µ;Ö∞&(*µ)->
q√xt
)

159 *
µ
 = 
b
;

162 i‡(
idequeue
 =
b
)

163 
	`ide°¨t
(
b
);

166 (
b
->
Êags
 & (
B_VALID
 | 
B_DIRTY
)) != B_VALID)

168 
	`¶ìp
(
b
, &
idñock
);

171 
	`ªÀa£
(&
idñock
);

172 
	}
}

	@init.c

3 
	~"ty≥s.h
"

4 
	~"°©.h
"

5 
	~"u£r.h
"

6 
	~"f˙é.h
"

8 *
	g¨gv
[] = {"sh", 0};

10 
	$maö
()

12 
pid
, 
wpid
;

14 i‡(
	`›í
("c⁄sﬁe", 
O_RDWR
) < 0)

16 
	`mknod
("console", 1, 1);

17 
	`›í
("c⁄sﬁe", 
O_RDWR
);

19 
	`dup
(0);

20 
	`dup
(0);

24 
	`¥ötf
(1, "init: starting sh\n");

25 
pid
 = 
	`f‹k
();

26 i‡(
pid
 < 0)

28 
	`¥ötf
(1, "init: fork failed\n");

29 
	`exô
();

31 i‡(
pid
 == 0)

33 
	`exec
("sh", 
¨gv
);

34 
	`¥ötf
(1, "init:Éxec sh failed\n");

35 
	`exô
();

37 (
wpid
 = 
	`waô
()Ë>0 && wpid !
pid
)

38 
	`¥ötf
(1, "zombie!\n");

40 
	}
}

	@initcode.S

1 #Inôü»
¥o˚ss
 
execs
 /
öô
.

2 #Thi†
code
 
runs
 
ö
 
u£r
 
•a˚
.

4 
	~"sysˇŒ.h
"

5 
	~"å≠s.h
"

8 #exec(
öô
, 
¨gv
)

9 .
globl
 
°¨t


10 
	g°¨t
:

11 
pushl
 
$¨gv


12 
pushl
 
$öô


13 
pushl
 
$0


14 
movl
 
$SYS_exec
, %
óx


15 
	g$T_SYSCALL


17 #f‹(;;Ë
exô
();

18 
	gexô
:

19 
movl
 
$SYS_exô
, %
óx


20 
$T_SYSCALL


21 
jmp
 
	gexô


23 #ch¨ 
öô
[] = "/init\0";

24 
	göô
:

25 .
°rög
 "/init\0"

27 #ch¨ *
¨gv
[] = { 
öô
, 0 };

28 .
	gp2Æign
 2

29 
	g¨gv
:

30 .
öô


	@ioapic.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"å≠s.h
"

9 
	#IOAPIC
 0xFEC00000

10 

	)

11 
	#REG_ID
 0x00

12 
	#REG_VER
 0x01

13 
	#REG_TABLE
 0x10

14 

	)

20 
	#INT_DISABLED
 0x00010000

21 
	#INT_LEVEL
 0x00008000

22 
	#INT_ACTIVELOW
 0x00002000

23 
	#INT_LOGICAL
 0x00000800

24 

	)

25 vﬁ©ûê
iﬂpic
 *
	giﬂpic
;

28 
	siﬂpic


30 
uöt
 
	mªg
;

31 
uöt
 
	m∑d
[3];

32 
uöt
 
	md©a
;

35 
uöt


36 
	$iﬂpi¸ód
(
ªg
)

38 
iﬂpic
->
ªg
 =Ñeg;

39  
iﬂpic
->
d©a
;

40 
	}
}

43 
	$iﬂpicwrôe
(
ªg
, 
uöt
 
d©a
)

45 
iﬂpic
->
ªg
 =Ñeg;

46 
iﬂpic
->
d©a
 = data;

47 
	}
}

49 
	$iﬂpicöô
()

51 
i
, 
id
, 
maxöå
;

53 
iﬂpic
 = (vﬁ©ûêiﬂpi¯*)
IOAPIC
;

54 
maxöå
 = (
	`iﬂpi¸ód
(
REG_VER
) >> 16) & 0xFF;

55 
id
 = 
	`iﬂpi¸ód
(
REG_ID
) >> 24;

56 i‡(
id
 !
iﬂpicid
)

57 
	`˝rötf
("ioapicinit: id isn'tÉqualÅo ioapicid;Çotá MP\n");

61 
i
 = 0; i <
maxöå
; i++)

63 
	`iﬂpicwrôe
(
REG_TABLE
 + 2 * 
i
, 
INT_DISABLED
 | (
T_IRQ0
 + i));

64 
	`iﬂpicwrôe
(
REG_TABLE
 + 2 * 
i
 + 1, 0);

66 
	}
}

68 
	$iﬂpi˚«bÀ
(
úq
, 
˝unum
)

73 
	`iﬂpicwrôe
(
REG_TABLE
 + 2 * 
úq
, 
T_IRQ0
 + irq);

74 
	`iﬂpicwrôe
(
REG_TABLE
 + 2 * 
úq
 + 1, 
˝unum
 << 24);

75 
	}
}

	@kalloc.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"memœyout.h
"

9 
	~"mmu.h
"

10 
	~"•ölock.h
"

12 
‰ìønge
(*
v°¨t
, *
víd
);

13 
íd
[];

16 
	srun


18 
run
 *
	m√xt
;

23 
•ölock
 
	mlock
;

24 
	mu£_lock
;

25 
run
 *
	m‰ìli°
;

26 } 
	gkmem
;

33 
	$köô1
(*
v°¨t
, *
víd
)

35 
	`öôlock
(&
kmem
.
lock
, "kmem");

36 
kmem
.
u£_lock
 = 0;

37 
	`‰ìønge
(
v°¨t
, 
víd
);

38 
	}
}

40 
	$köô2
(*
v°¨t
, *
víd
)

42 
	`‰ìønge
(
v°¨t
, 
víd
);

43 
kmem
.
u£_lock
 = 1;

44 
	}
}

46 
	$‰ìønge
(*
v°¨t
, *
víd
)

48 *
p
;

49 
p
 = (*)
	`PGROUNDUP
((
uöt
)
v°¨t
);

50 ; 
p
 + 
PGSIZE
 <(*)
víd
;Ö += PGSIZE)

51 
	`k‰ì
(
p
);

52 
	}
}

58 
	$k‰ì
(*
v
)

60 
run
 *
r
;

62 i‡((
uöt
)
v
 % 
PGSIZE
 || v < 
íd
 || 
	`V2P
(vË>
PHYSTOP
)

63 
	`∑nic
("kfree");

66 
	`mem£t
(
v
, 1, 
PGSIZE
);

68 i‡(
kmem
.
u£_lock
)

69 
	`acquúe
(&
kmem
.
lock
);

70 
r
 = (
run
 *)
v
;

71 
r
->
√xt
 = 
kmem
.
‰ìli°
;

72 
kmem
.
‰ìli°
 = 
r
;

73 i‡(
kmem
.
u£_lock
)

74 
	`ªÀa£
(&
kmem
.
lock
);

75 
	}
}

81 
	$kÆloc
()

83 
run
 *
r
;

85 i‡(
kmem
.
u£_lock
)

86 
	`acquúe
(&
kmem
.
lock
);

87 
r
 = 
kmem
.
‰ìli°
;

88 i‡(
r
)

89 
kmem
.
‰ìli°
 = 
r
->
√xt
;

90 i‡(
kmem
.
u£_lock
)

91 
	`ªÀa£
(&
kmem
.
lock
);

92  (*)
r
;

93 
	}
}

	@kbd.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"kbd.h
"

6 
	$kbdgëc
()

8 
uöt
 
shi·
;

9 
uch¨
 *
ch¨code
[4] = {

10 
n‹mÆm≠
, 
shi·m≠
, 
˘lm≠
, ctlmap};

11 
uöt
 
°
, 
d©a
, 
c
;

13 
°
 = 
	`öb
(
KBSTATP
);

14 i‡((
°
 & 
KBS_DIB
) == 0)

16 
d©a
 = 
	`öb
(
KBDATAP
);

18 i‡(
d©a
 == 0xE0)

20 
shi·
 |
E0ESC
;

23 i‡(
d©a
 & 0x80)

26 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

27 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

30 i‡(
shi·
 & 
E0ESC
)

33 
d©a
 |= 0x80;

34 
shi·
 &~
E0ESC
;

37 
shi·
 |
shi·code
[
d©a
];

38 
shi·
 ^
toggÀcode
[
d©a
];

39 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

40 i‡(
shi·
 & 
CAPSLOCK
)

42 i‡('a' <
c
 && c <= 'z')

43 
c
 += 'A' - 'a';

44 i‡('A' <
c
 && c <= 'Z')

45 
c
 += 'a' - 'A';

47  
c
;

48 
	}
}

50 
	$kbdöå
()

52 
	`c⁄sﬁeöå
(
kbdgëc
);

53 
	}
}

	@kbd.h

3 
	#KBSTATP
 0x64

4 
	#KBS_DIB
 0x01

5 
	#KBDATAP
 0x60

6 

	)

7 
	#NO
 0

	)

9 
	#SHIFT
 (1 << 0)

	)

10 
	#CTL
 (1 << 1)

	)

11 
	#ALT
 (1 << 2)

	)

13 
	#CAPSLOCK
 (1 << 3)

	)

14 
	#NUMLOCK
 (1 << 4)

	)

15 
	#SCROLLLOCK
 (1 << 5)

	)

17 
	#E0ESC
 (1 << 6)

	)

20 
	#KEY_HOME
 0xE0

	)

21 
	#KEY_END
 0xE1

	)

22 
	#KEY_UP
 0xE2

	)

23 
	#KEY_DN
 0xE3

	)

24 
	#KEY_LF
 0xE4

	)

25 
	#KEY_RT
 0xE5

	)

26 
	#KEY_PGUP
 0xE6

	)

27 
	#KEY_PGDN
 0xE7

	)

28 
	#KEY_INS
 0xE8

	)

29 
	#KEY_DEL
 0xE9

	)

32 
	#C
(
x
Ë(x - '@')

	)

34 
uch¨
 
	gshi·code
[256] =

36 [0x1D] 
CTL
,

37 [0x2A] 
SHIFT
,

38 [0x36] 
SHIFT
,

39 [0x38] 
ALT
,

40 [0x9D] 
CTL
,

41 [0xB8] 
ALT
};

43 
uch¨
 
	gtoggÀcode
[256] =

45 [0x3A] 
CAPSLOCK
,

46 [0x45] 
NUMLOCK
,

47 [0x46] 
SCROLLLOCK
};

49 
uch¨
 
	gn‹mÆm≠
[256] =

51 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

54 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

56 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

57 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

58 
NO
, ' ', NO, NO, NO, NO, NO, NO,

59 
NO
, NO, NO, NO, NO, NO, NO, '7',

61 '2', '3', '0', '.', 
NO
, NO, NO, NO,

64 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

65 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

66 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

67 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

68 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL
};

70 
uch¨
 
	gshi·m≠
[256] =

72 
NO
, 033, '!', '@', '#', '$', '%', '^',

75 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

77 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

78 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

79 
NO
, ' ', NO, NO, NO, NO, NO, NO,

80 
NO
, NO, NO, NO, NO, NO, NO, '7',

82 '2', '3', '0', '.', 
NO
, NO, NO, NO,

85 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

86 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

87 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

88 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

89 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL
};

91 
uch¨
 
	g˘lm≠
[256] =

93 
NO
, NO, NO, NO, NO, NO, NO, NO,

94 
NO
, NO, NO, NO, NO, NO, NO, NO,

95 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

96 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

97 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

98 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

99 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

101 [0xB5] 
C
('/'),

102 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

103 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

104 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

105 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

106 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL
};

	@kill.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, **
¨gv
)

8 
i
;

10 if(
¨gc
 < 2){

11 
	`¥ötf
(2, "usage: killÖid...\n");

12 
	`exô
();

14 
i
=1; i<
¨gc
; i++)

15 
	`kûl
(
	`©oi
(
¨gv
[
i
]));

16 
	`exô
();

17 
	}
}

	@lapic.c

4 
	~"∑øm.h
"

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"d©e.h
"

8 
	~"memœyout.h
"

9 
	~"å≠s.h
"

10 
	~"mmu.h
"

11 
	~"x86.h
"

14 
	#ID
 (0x0020 / 4)

15 
	#VER
 (0x0030 / 4)

16 
	#TPR
 (0x0080 / 4)

17 
	#EOI
 (0x00B0 / 4)

18 
	#SVR
 (0x00F0 / 4)

19 
	#ENABLE
 0x00000100

20 
	#ESR
 (0x0280 / 4)

21 
	#ICRLO
 (0x0300 / 4)

22 
	#INIT
 0x00000500

23 
	#STARTUP
 0x00000600

24 
	#DELIVS
 0x00001000

25 
	#ASSERT
 0x00004000

26 
	#DEASSERT
 0x00000000

	)

27 
	#LEVEL
 0x00008000

28 
	#BCAST
 0x00080000

29 
	#BUSY
 0x00001000

	)

30 
	#FIXED
 0x00000000

	)

31 
	#ICRHI
 (0x0310 / 4)

32 
	#TIMER
 (0x0320 / 4)

33 
	#X1
 0x0000000B

34 
	#PERIODIC
 0x00020000

35 
	#PCINT
 (0x0340 / 4)

36 
	#LINT0
 (0x0350 / 4)

37 
	#LINT1
 (0x0360 / 4)

38 
	#ERROR
 (0x0370 / 4)

39 
	#MASKED
 0x00010000

40 
	#TICR
 (0x0380 / 4)

41 
	#TCCR
 (0x0390 / 4)

42 
	#TDCR
 (0x03E0 / 4)

43 

	)

44 vﬁ©ûê
uöt
 *
	gœpic
;

48 
	$œpicw
(
ödex
, 
vÆue
)

50 
œpic
[
ödex
] = 
vÆue
;

51 
œpic
[
ID
];

52 
	}
}

54 
	$œpicöô
()

56 i‡(!
œpic
)

60 
	`œpicw
(
SVR
, 
ENABLE
 | (
T_IRQ0
 + 
IRQ_SPURIOUS
));

66 
	`œpicw
(
TDCR
, 
X1
);

67 
	`œpicw
(
TIMER
, 
PERIODIC
 | (
T_IRQ0
 + 
IRQ_TIMER
));

68 
	`œpicw
(
TICR
, 10000000);

71 
	`œpicw
(
LINT0
, 
MASKED
);

72 
	`œpicw
(
LINT1
, 
MASKED
);

76 i‡(((
œpic
[
VER
] >> 16) & 0xFF) >= 4)

77 
	`œpicw
(
PCINT
, 
MASKED
);

80 
	`œpicw
(
ERROR
, 
T_IRQ0
 + 
IRQ_ERROR
);

83 
	`œpicw
(
ESR
, 0);

84 
	`œpicw
(
ESR
, 0);

87 
	`œpicw
(
EOI
, 0);

90 
	`œpicw
(
ICRHI
, 0);

91 
	`œpicw
(
ICRLO
, 
BCAST
 | 
INIT
 | 
LEVEL
);

92 
œpic
[
ICRLO
] & 
DELIVS
)

96 
	`œpicw
(
TPR
, 0);

97 
	}
}

99 
	$œpicid
()

101 i‡(!
œpic
)

103  
œpic
[
ID
] >> 24;

104 
	}
}

107 
	$œpi˚oi
()

109 i‡(
œpic
)

110 
	`œpicw
(
EOI
, 0);

111 
	}
}

115 
	$mi¸odñay
(
us
)

117 
	}
}

119 
	#CMOS_PORT
 0x70

	)

120 
	#CMOS_RETURN
 0x71

	)

124 
	$œpic°¨èp
(
uch¨
 
≠icid
, 
uöt
 
addr
)

126 
i
;

127 
ush‹t
 *
wrv
;

132 
	`outb
(
CMOS_PORT
, 0xF);

133 
	`outb
(
CMOS_PORT
 + 1, 0x0A);

134 
wrv
 = (
ush‹t
 *)
	`P2V
((0x40 << 4 | 0x67));

135 
wrv
[0] = 0;

136 
wrv
[1] = 
addr
 >> 4;

140 
	`œpicw
(
ICRHI
, 
≠icid
 << 24);

141 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
 | 
ASSERT
);

142 
	`mi¸odñay
(200);

143 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
);

144 
	`mi¸odñay
(100);

151 
i
 = 0; i < 2; i++)

153 
	`œpicw
(
ICRHI
, 
≠icid
 << 24);

154 
	`œpicw
(
ICRLO
, 
STARTUP
 | (
addr
 >> 12));

155 
	`mi¸odñay
(200);

157 
	}
}

159 
	#CMOS_STATA
 0x0a

	)

160 
	#CMOS_STATB
 0x0b

	)

161 
	#CMOS_UIP
 (1 << 7)

162 

	)

163 
	#SECS
 0x00

	)

164 
	#MINS
 0x02

	)

165 
	#HOURS
 0x04

	)

166 
	#DAY
 0x07

	)

167 
	#MONTH
 0x08

	)

168 
	#YEAR
 0x09

	)

170 
uöt


171 
	$cmos_ªad
(
uöt
 
ªg
)

173 
	`outb
(
CMOS_PORT
, 
ªg
);

174 
	`mi¸odñay
(200);

176  
	`öb
(
CMOS_RETURN
);

177 
	}
}

180 
	$fûl_πcd©e
(
πcd©e
 *
r
)

182 
r
->
£c⁄d
 = 
	`cmos_ªad
(
SECS
);

183 
r
->
möuã
 = 
	`cmos_ªad
(
MINS
);

184 
r
->
hour
 = 
	`cmos_ªad
(
HOURS
);

185 
r
->
day
 = 
	`cmos_ªad
(
DAY
);

186 
r
->
m⁄th
 = 
	`cmos_ªad
(
MONTH
);

187 
r
->
yór
 = 
	`cmos_ªad
(
YEAR
);

188 
	}
}

191 
	$cmo°ime
(
πcd©e
 *
r
)

193 
πcd©e
 
t1
, 
t2
;

194 
sb
, 
bcd
;

196 
sb
 = 
	`cmos_ªad
(
CMOS_STATB
);

198 
bcd
 = (
sb
 & (1 << 2)) == 0;

203 
	`fûl_πcd©e
(&
t1
);

204 i‡(
	`cmos_ªad
(
CMOS_STATA
Ë& 
CMOS_UIP
)

206 
	`fûl_πcd©e
(&
t2
);

207 i‡(
	`memcmp
(&
t1
, &
t2
, (t1)) == 0)

212 i‡(
bcd
)

214 
	#CONV
(
x
Ë(
t1
.x = (—1.x >> 4Ë* 10Ë+ (t1.x & 0xf))

	)

215 
	`CONV
(
£c⁄d
);

216 
	`CONV
(
möuã
);

217 
	`CONV
(
hour
);

218 
	`CONV
(
day
);

219 
	`CONV
(
m⁄th
);

220 
	`CONV
(
yór
);

221 #unde‡
CONV


224 *
r
 = 
t1
;

225 
r
->
yór
 += 2000;

226 
	}
}

	@ln.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 i‡(
¨gc
 != 3)

9 
	`¥ötf
(2, "Usage:Ün oldÇew\n");

10 
	`exô
();

12 i‡(
	`lök
(
¨gv
[1],árgv[2]) < 0)

13 
	`¥ötf
(2, "lök %†%s: faûed\n", 
¨gv
[1],árgv[2]);

14 
	`exô
();

15 
	}
}

	@log.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"•ölock.h
"

5 
	~"¶ì∂ock.h
"

6 
	~"fs.h
"

7 
	~"buf.h
"

34 
	sloghódî


36 
	mn
;

37 
	mblock
[
LOGSIZE
];

40 
	slog


42 
•ölock
 
	mlock
;

43 
	m°¨t
;

44 
	msize
;

45 
	mout°™dög
;

46 
	mcommôtög
;

47 
	mdev
;

48 
loghódî
 
	mlh
;

50 
log
 
	glog
;

52 
ªcovî_‰om_log
();

53 
commô
();

55 
	$öôlog
(
dev
)

57 i‡((
loghódî
Ë>
BSIZE
)

58 
	`∑nic
("initlog:Åoo bigÜogheader");

60 
su≥rblock
 
sb
;

61 
	`öôlock
(&
log
.
lock
, "log");

62 
	`ªadsb
(
dev
, &
sb
);

63 
log
.
°¨t
 = 
sb
.
log°¨t
;

64 
log
.
size
 = 
sb
.
∆og
;

65 
log
.
dev
 = dev;

66 
	`ªcovî_‰om_log
();

67 
	}
}

71 
	$ö°Æl_å™s
()

73 
èû
;

75 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++)

77 
buf
 *
lbuf
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
 + 
èû
 + 1);

78 
buf
 *
dbuf
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

79 
	`memmove
(
dbuf
->
d©a
, 
lbuf
->d©a, 
BSIZE
);

80 
	`bwrôe
(
dbuf
);

81 
	`bªl£
(
lbuf
);

82 
	`bªl£
(
dbuf
);

84 
	}
}

88 
	$ªad_hód
()

90 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

91 
loghódî
 *
lh
 = (loghódî *)(
buf
->
d©a
);

92 
i
;

93 
log
.
lh
.
n
 =Üh->n;

94 
i
 = 0; i < 
log
.
lh
.
n
; i++)

96 
log
.
lh
.
block
[
i
] =Üh->block[i];

98 
	`bªl£
(
buf
);

99 
	}
}

105 
	$wrôe_hód
()

107 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

108 
loghódî
 *
hb
 = (loghódî *)(
buf
->
d©a
);

109 
i
;

110 
hb
->
n
 = 
log
.
lh
.n;

111 
i
 = 0; i < 
log
.
lh
.
n
; i++)

113 
hb
->
block
[
i
] = 
log
.
lh
.block[i];

115 
	`bwrôe
(
buf
);

116 
	`bªl£
(
buf
);

117 
	}
}

120 
	$ªcovî_‰om_log
()

122 
	`ªad_hód
();

123 
	`ö°Æl_å™s
();

124 
log
.
lh
.
n
 = 0;

125 
	`wrôe_hód
();

126 
	}
}

129 
	$begö_›
()

131 
	`acquúe
(&
log
.
lock
);

134 i‡(
log
.
commôtög
)

136 
	`¶ìp
(&
log
, &log.
lock
);

138 i‡(
log
.
lh
.
n
 + (log.
out°™dög
 + 1Ë* 
MAXOPBLOCKS
 > 
LOGSIZE
)

141 
	`¶ìp
(&
log
, &log.
lock
);

145 
log
.
out°™dög
 += 1;

146 
	`ªÀa£
(&
log
.
lock
);

150 
	}
}

154 
	$íd_›
()

156 
do_commô
 = 0;

158 
	`acquúe
(&
log
.
lock
);

159 
log
.
out°™dög
 -= 1;

160 i‡(
log
.
commôtög
)

161 
	`∑nic
("log.committing");

162 i‡(
log
.
out°™dög
 == 0)

164 
do_commô
 = 1;

165 
log
.
commôtög
 = 1;

172 
	`wakeup
(&
log
);

174 
	`ªÀa£
(&
log
.
lock
);

176 i‡(
do_commô
)

180 
	`commô
();

181 
	`acquúe
(&
log
.
lock
);

182 
log
.
commôtög
 = 0;

183 
	`wakeup
(&
log
);

184 
	`ªÀa£
(&
log
.
lock
);

186 
	}
}

190 
	$wrôe_log
()

192 
èû
;

194 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++)

196 
buf
 *
to
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
 + 
èû
 + 1);

197 
buf
 *
‰om
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

198 
	`memmove
(
to
->
d©a
, 
‰om
->d©a, 
BSIZE
);

199 
	`bwrôe
(
to
);

200 
	`bªl£
(
‰om
);

201 
	`bªl£
(
to
);

203 
	}
}

206 
	$commô
()

208 i‡(
log
.
lh
.
n
 > 0)

210 
	`wrôe_log
();

211 
	`wrôe_hód
();

212 
	`ö°Æl_å™s
();

213 
log
.
lh
.
n
 = 0;

214 
	`wrôe_hód
();

216 
	}
}

227 
	$log_wrôe
(
buf
 *
b
)

229 
i
;

231 i‡(
log
.
lh
.
n
 >
LOGSIZE
 ||Üog.lh.¿>log.
size
 - 1)

232 
	`∑nic
("too bigáÅransaction");

233 i‡(
log
.
out°™dög
 < 1)

234 
	`∑nic
("log_write outside ofÅrans");

236 
	`acquúe
(&
log
.
lock
);

237 
i
 = 0; i < 
log
.
lh
.
n
; i++)

239 i‡(
log
.
lh
.
block
[
i
] =
b
->
blockno
)

242 
log
.
lh
.
block
[
i
] = 
b
->
blockno
;

243 i‡(
i
 =
log
.
lh
.
n
)

244 
log
.
lh
.
n
++;

245 
b
->
Êags
 |
B_DIRTY
;

246 
	`ªÀa£
(&
log
.
lock
);

247 
	}
}

	@ls.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

4 
	~"fs.h
"

7 
	$fmäame
(*
∑th
)

9 
buf
[
DIRSIZ
 + 1];

10 *
p
;

13 
p
 = 
∑th
 + 
	`°æí
(path);Ö >=Öath && *p != '/';Ö--)

15 
p
++;

18 i‡(
	`°æí
(
p
Ë>
DIRSIZ
)

19  
p
;

20 
	`memmove
(
buf
, 
p
, 
	`°æí
(p));

21 
	`mem£t
(
buf
 + 
	`°æí
(
p
), ' ', 
DIRSIZ
 - strlen(p));

22  
buf
;

23 
	}
}

25 
	$ls
(*
∑th
)

27 
buf
[512], *
p
;

28 
fd
;

29 
dúít
 
de
;

30 
°©
 
°
;

32 i‡((
fd
 = 
	`›í
(
∑th
, 0)) < 0)

34 
	`¥ötf
(2, "ls: c™nŸ o≥¿%s\n", 
∑th
);

38 i‡(
	`f°©
(
fd
, &
°
) < 0)

40 
	`¥ötf
(2, "ls: c™nŸ sèà%s\n", 
∑th
);

41 
	`˛o£
(
fd
);

45 
°
.
ty≥
)

47 
T_FILE
:

48 
	`¥ötf
(1, "%†%d %d %d\n", 
	`fmäame
(
∑th
), 
°
.
ty≥
, st.
öo
, st.
size
);

51 
T_DIR
:

52 i‡(
	`°æí
(
∑th
Ë+ 1 + 
DIRSIZ
 + 1 >  
buf
)

54 
	`¥ötf
(1, "ls:ÖathÅooÜong\n");

57 
	`°r˝y
(
buf
, 
∑th
);

58 
p
 = 
buf
 + 
	`°æí
(buf);

59 *
p
++ = '/';

60 
	`ªad
(
fd
, &
de
, (de)) == (de))

62 i‡(
de
.
öum
 == 0)

64 
	`memmove
(
p
, 
de
.
«me
, 
DIRSIZ
);

65 
p
[
DIRSIZ
] = 0;

66 i‡(
	`°©
(
buf
, &
°
) < 0)

68 
	`¥ötf
(1, "ls: c™nŸ sèà%s\n", 
buf
);

71 
	`¥ötf
(1, "%†%d %d %d\n", 
	`fmäame
(
buf
), 
°
.
ty≥
, st.
öo
, st.
size
);

75 
	`˛o£
(
fd
);

76 
	}
}

78 
	$maö
(
¨gc
, *
¨gv
[])

80 
i
;

82 i‡(
¨gc
 < 2)

84 
	`ls
(".");

85 
	`exô
();

87 
i
 = 1; i < 
¨gc
; i++)

88 
	`ls
(
¨gv
[
i
]);

89 
	`exô
();

90 
	}
}

	@main.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

9 
°¨tŸhîs
();

10 
	$mpmaö
(Ë
	`__©åibuã__
((
n‹ëu∫
));

11 
pde_t
 *
kpgdú
;

12 
íd
[];

17 
	$maö
()

19 
	`köô1
(
íd
, 
	`P2V
(4 * 1024 * 1024));

20 
	`kvmÆloc
();

21 
	`mpöô
();

22 
	`œpicöô
();

23 
	`£göô
();

24 
	`picöô
();

25 
	`iﬂpicöô
();

26 
	`c⁄sﬁeöô
();

27 
	`u¨töô
();

28 
	`pöô
();

29 
	`tvöô
();

30 
	`böô
();

31 
	`fûeöô
();

32 
	`ideöô
();

33 
	`°¨tŸhîs
();

34 
	`köô2
(
	`P2V
(4 * 1024 * 1024), P2V(
PHYSTOP
));

35 
	`u£röô
();

36 
	`mpmaö
();

37 
	}
}

41 
	$m≥¡î
()

43 
	`swôchkvm
();

44 
	`£göô
();

45 
	`œpicöô
();

46 
	`mpmaö
();

47 
	}
}

51 
	$mpmaö
()

53 
	`˝rötf
("˝u%d: sèπög %d\n", 
	`˝uid
(), cpuid());

54 
	`idtöô
();

55 
	`xchg
(&(
	`my˝u
()->
°¨ãd
), 1);

56 
	`scheduÀr
();

57 
	}
}

59 
pde_t
 
	gíåypgdú
[];

63 
	$°¨tŸhîs
()

65 
uch¨
 
_bö¨y_íåyŸhî_°¨t
[], 
_bö¨y_íåyŸhî_size
[];

66 
uch¨
 *
code
;

67 
˝u
 *
c
;

68 *
°ack
;

73 
code
 = 
	`P2V
(0x7000);

74 
	`memmove
(
code
, 
_bö¨y_íåyŸhî_°¨t
, (
uöt
)
_bö¨y_íåyŸhî_size
);

76 
c
 = 
˝us
; c < cpu†+ 
n˝u
; c++)

78 i‡(
c
 =
	`my˝u
())

84 
°ack
 = 
	`kÆloc
();

85 *(**)(
code
 - 4Ë
°ack
 + 
KSTACKSIZE
;

86 *((**)())(
code
 - 8Ë
m≥¡î
;

87 *(**)(
code
 - 12Ë(*)
	`V2P
(
íåypgdú
);

89 
	`œpic°¨èp
(
c
->
≠icid
, 
	`V2P
(
code
));

92 
c
->
°¨ãd
 == 0)

95 
	}
}

102 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

103 
pde_t
 
íåypgdú
[
NPDENTRIES
] = {

105 [0] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

107 [
KERNBASE
 >>

108 
PDXSHIFT
] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

109 
	}
};

	@memide.c

4 
	~"ty≥s.h
"

5 
	~"defs.h
"

6 
	~"∑øm.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

9 
	~"x86.h
"

10 
	~"å≠s.h
"

11 
	~"•ölock.h
"

12 
	~"¶ì∂ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
uch¨
 
_bö¨y_fs_img_°¨t
[], 
_bö¨y_fs_img_size
[];

18 
	gdisksize
;

19 
uch¨
 *
	gmemdisk
;

21 
	$ideöô
()

23 
memdisk
 = 
_bö¨y_fs_img_°¨t
;

24 
disksize
 = (
uöt
)
_bö¨y_fs_img_size
 / 
BSIZE
;

25 
	}
}

28 
	$ideöå
()

31 
	}
}

36 
	$idîw
(
buf
 *
b
)

38 
uch¨
 *
p
;

40 i‡(!
	`hﬁdög¶ìp
(&
b
->
lock
))

41 
	`∑nic
("iderw: bufÇotÜocked");

42 i‡((
b
->
Êags
 & (
B_VALID
 | 
B_DIRTY
)) == B_VALID)

43 
	`∑nic
("iderw:ÇothingÅo do");

44 i‡(
b
->
dev
 != 1)

45 
	`∑nic
("iderw:ÑequestÇot for disk 1");

46 i‡(
b
->
blockno
 >
disksize
)

47 
	`∑nic
("iderw: block out ofÑange");

49 
p
 = 
memdisk
 + 
b
->
blockno
 * 
BSIZE
;

51 i‡(
b
->
Êags
 & 
B_DIRTY
)

53 
b
->
Êags
 &~
B_DIRTY
;

54 
	`memmove
(
p
, 
b
->
d©a
, 
BSIZE
);

57 
	`memmove
(
b
->
d©a
, 
p
, 
BSIZE
);

58 
b
->
Êags
 |
B_VALID
;

59 
	}
}

	@memlayout.h

3 
	#EXTMEM
 0x100000

4 
	#PHYSTOP
 0xE000000

5 
	#DEVSPACE
 0xFE000000

6 

	)

8 
	#KERNBASE
 0x80000000

9 
	#KERNLINK
 (
KERNBASE
 + 
EXTMEM
)

10 

	)

11 
	#V2P
(
a
Ë(((
uöt
)◊)Ë- 
KERNBASE
)

	)

12 
	#P2V
(
a
Ë((*)(((*)◊)Ë+ 
KERNBASE
))

	)

14 
	#V2P_WO
(
x
Ë((x)-
KERNBASE
)

15 
	#P2V_WO
(
x
Ë((xË+ 
KERNBASE
)

	@mkdir.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
i
;

9 i‡(
¨gc
 < 2)

11 
	`¥ötf
(2, "Usage: mkdir files...\n");

12 
	`exô
();

15 
i
 = 1; i < 
¨gc
; i++)

17 i‡(
	`mkdú
(
¨gv
[
i
]) < 0)

19 
	`¥ötf
(2, "mkdú: %†ÁûedÅÿ¸óã\n", 
¨gv
[
i
]);

24 
	`exô
();

25 
	}
}

	@mkfs.c

1 
	~<°dio.h
>

2 
	~<uni°d.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<f˙é.h
>

6 
	~<as£π.h
>

8 
	#°©
 
xv6_°©


9 
	~"ty≥s.h
"

	)

10 
	~"fs.h
"

11 
	~"°©.h
"

12 
	~"∑øm.h
"

14 #i‚de‡
°©ic_as£π


15 
	#°©ic_as£π
(
a
, 
b
) \

20 (
a
):; \

21 } 0)

	)

24 
	#NINODES
 200

	)

29 
	gnbôm≠
 = 
FSSIZE
 / (
BSIZE
 * 8) + 1;

30 
	gnöodeblocks
 = 
NINODES
 / 
IPB
 + 1;

31 
	g∆og
 = 
LOGSIZE
;

32 
	gnmëa
;

33 
	gnblocks
;

35 
	gfsfd
;

36 
su≥rblock
 
	gsb
;

37 
	gzî€s
[
BSIZE
];

38 
uöt
 
	g‰ìöode
 = 1;

39 
uöt
 
	g‰ìblock
;

41 
bÆloc
();

42 
w£˘
(
uöt
, *);

43 
wöode
(
uöt
, 
döode
 *);

44 
röode
(
uöt
 
öum
, 
döode
 *
ù
);

45 
r£˘
(
uöt
 
£c
, *
buf
);

46 
uöt
 
üŒoc
(
ush‹t
 
ty≥
);

47 
üµíd
(
uöt
 
öum
, *
p
, 
n
);

50 
ush‹t


51 
	$xsh‹t
(
ush‹t
 
x
)

53 
ush‹t
 
y
;

54 
uch¨
 *
a
 = (uch¨ *)&
y
;

55 
a
[0] = 
x
;

56 
a
[1] = 
x
 >> 8;

57  
y
;

58 
	}
}

60 
uöt
 
	$xöt
(
uöt
 
x
)

62 
uöt
 
y
;

63 
uch¨
 *
a
 = (uch¨ *)&
y
;

64 
a
[0] = 
x
;

65 
a
[1] = 
x
 >> 8;

66 
a
[2] = 
x
 >> 16;

67 
a
[3] = 
x
 >> 24;

68  
y
;

69 
	}
}

71 
	$maö
(
¨gc
, *
¨gv
[])

73 
i
, 
cc
, 
fd
;

74 
uöt
 
roŸöo
, 
öum
, 
off
;

75 
dúít
 
de
;

76 
buf
[
BSIZE
];

77 
döode
 
dö
;

79 
	`°©ic_as£π
(() == 4, "Integers must be 4 bytes!");

81 i‡(
¨gc
 < 2)

83 
	`Ârötf
(
°dîr
, "Usage: mkfs fs.img files...\n");

84 
	`exô
(1);

87 
	`as£π
((
BSIZE
 % (
döode
)) == 0);

88 
	`as£π
((
BSIZE
 % (
dúít
)) == 0);

90 
fsfd
 = 
	`›í
(
¨gv
[1], 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 0666);

91 i‡(
fsfd
 < 0)

93 
	`≥º‹
(
¨gv
[1]);

94 
	`exô
(1);

98 
nmëa
 = 2 + 
∆og
 + 
nöodeblocks
 + 
nbôm≠
;

99 
nblocks
 = 
FSSIZE
 - 
nmëa
;

101 
sb
.
size
 = 
	`xöt
(
FSSIZE
);

102 
sb
.
nblocks
 = 
	`xöt
(nblocks);

103 
sb
.
nöodes
 = 
	`xöt
(
NINODES
);

104 
sb
.
∆og
 = 
	`xöt
(nlog);

105 
sb
.
log°¨t
 = 
	`xöt
(2);

106 
sb
.
öode°¨t
 = 
	`xöt
(2 + 
∆og
);

107 
sb
.
bm≠°¨t
 = 
	`xöt
(2 + 
∆og
 + 
nöodeblocks
);

109 
	`¥ötf
("nmeta %d (boot, super,Üog blocks %u inode blocks %u, bitmap blocks %u) blocks %dÅotal %d\n",

110 
nmëa
, 
∆og
, 
nöodeblocks
, 
nbôm≠
, 
nblocks
, 
FSSIZE
);

112 
‰ìblock
 = 
nmëa
;

114 
i
 = 0; i < 
FSSIZE
; i++)

115 
	`w£˘
(
i
, 
zî€s
);

117 
	`mem£t
(
buf
, 0, (buf));

118 
	`memmove
(
buf
, &
sb
, (sb));

119 
	`w£˘
(1, 
buf
);

121 
roŸöo
 = 
	`üŒoc
(
T_DIR
);

122 
	`as£π
(
roŸöo
 =
ROOTINO
);

124 
	`bzîo
(&
de
, (de));

125 
de
.
öum
 = 
	`xsh‹t
(
roŸöo
);

126 
	`°r˝y
(
de
.
«me
, ".");

127 
	`üµíd
(
roŸöo
, &
de
, (de));

129 
	`bzîo
(&
de
, (de));

130 
de
.
öum
 = 
	`xsh‹t
(
roŸöo
);

131 
	`°r˝y
(
de
.
«me
, "..");

132 
	`üµíd
(
roŸöo
, &
de
, (de));

134 
i
 = 2; i < 
¨gc
; i++)

136 
	`as£π
(
	`ödex
(
¨gv
[
i
], '/') == 0);

138 i‡((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0)

140 
	`≥º‹
(
¨gv
[
i
]);

141 
	`exô
(1);

148 i‡(
¨gv
[
i
][0] == '_')

149 ++
¨gv
[
i
];

151 
öum
 = 
	`üŒoc
(
T_FILE
);

153 
	`bzîo
(&
de
, (de));

154 
de
.
öum
 = 
	`xsh‹t
(inum);

155 
	`°∫˝y
(
de
.
«me
, 
¨gv
[
i
], 
DIRSIZ
);

156 
	`üµíd
(
roŸöo
, &
de
, (de));

158 (
cc
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

159 
	`üµíd
(
öum
, 
buf
, 
cc
);

161 
	`˛o£
(
fd
);

165 
	`röode
(
roŸöo
, &
dö
);

166 
off
 = 
	`xöt
(
dö
.
size
);

167 
off
 = ((of‡/ 
BSIZE
) + 1) * BSIZE;

168 
dö
.
size
 = 
	`xöt
(
off
);

169 
	`wöode
(
roŸöo
, &
dö
);

171 
	`bÆloc
(
‰ìblock
);

173 
	`exô
(0);

174 
	}
}

176 
	$w£˘
(
uöt
 
£c
, *
buf
)

178 i‡(
	`l£ek
(
fsfd
, 
£c
 * 
BSIZE
, 0) != sec * BSIZE)

180 
	`≥º‹
("lseek");

181 
	`exô
(1);

183 i‡(
	`wrôe
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE)

185 
	`≥º‹
("write");

186 
	`exô
(1);

188 
	}
}

190 
	$wöode
(
uöt
 
öum
, 
döode
 *
ù
)

192 
buf
[
BSIZE
];

193 
uöt
 
bn
;

194 
döode
 *
dù
;

196 
bn
 = 
	`IBLOCK
(
öum
, 
sb
);

197 
	`r£˘
(
bn
, 
buf
);

198 
dù
 = ((
döode
 *)
buf
Ë+ (
öum
 % 
IPB
);

199 *
dù
 = *
ù
;

200 
	`w£˘
(
bn
, 
buf
);

201 
	}
}

203 
	$röode
(
uöt
 
öum
, 
döode
 *
ù
)

205 
buf
[
BSIZE
];

206 
uöt
 
bn
;

207 
döode
 *
dù
;

209 
bn
 = 
	`IBLOCK
(
öum
, 
sb
);

210 
	`r£˘
(
bn
, 
buf
);

211 
dù
 = ((
döode
 *)
buf
Ë+ (
öum
 % 
IPB
);

212 *
ù
 = *
dù
;

213 
	}
}

215 
	$r£˘
(
uöt
 
£c
, *
buf
)

217 i‡(
	`l£ek
(
fsfd
, 
£c
 * 
BSIZE
, 0) != sec * BSIZE)

219 
	`≥º‹
("lseek");

220 
	`exô
(1);

222 i‡(
	`ªad
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE)

224 
	`≥º‹
("read");

225 
	`exô
(1);

227 
	}
}

229 
uöt
 
	$üŒoc
(
ush‹t
 
ty≥
)

231 
uöt
 
öum
 = 
‰ìöode
++;

232 
döode
 
dö
;

234 
	`bzîo
(&
dö
, (din));

235 
dö
.
ty≥
 = 
	`xsh‹t
(type);

236 
dö
.
∆ök
 = 
	`xsh‹t
(1);

237 
dö
.
size
 = 
	`xöt
(0);

238 
	`wöode
(
öum
, &
dö
);

239  
öum
;

240 
	}
}

242 
	$bÆloc
(
u£d
)

244 
uch¨
 
buf
[
BSIZE
];

245 
i
;

247 
	`¥ötf
("bÆloc: fú° %d block†havêbì¿Æloˇãd\n", 
u£d
);

248 
	`as£π
(
u£d
 < 
BSIZE
 * 8);

249 
	`bzîo
(
buf
, 
BSIZE
);

250 
i
 = 0; i < 
u£d
; i++)

252 
buf
[
i
 / 8] = buf[i / 8] | (0x1 << (i % 8));

254 
	`¥ötf
("bÆloc: wrôêbôm≠ blockáà£˘‹ %d\n", 
sb
.
bm≠°¨t
);

255 
	`w£˘
(
sb
.
bm≠°¨t
, 
buf
);

256 
	}
}

258 
	#mö
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

260 
	$üµíd
(
uöt
 
öum
, *
xp
, 
n
)

262 *
p
 = (*)
xp
;

263 
uöt
 
fbn
, 
off
, 
n1
;

264 
döode
 
dö
;

265 
buf
[
BSIZE
];

266 
uöt
 
ödúe˘
[
NINDIRECT
];

267 
uöt
 
x
;

269 
	`röode
(
öum
, &
dö
);

270 
off
 = 
	`xöt
(
dö
.
size
);

272 
n
 > 0)

274 
fbn
 = 
off
 / 
BSIZE
;

275 
	`as£π
(
fbn
 < 
MAXFILE
);

276 i‡(
fbn
 < 
NDIRECT
)

278 i‡(
	`xöt
(
dö
.
addrs
[
fbn
]) == 0)

280 
dö
.
addrs
[
fbn
] = 
	`xöt
(
‰ìblock
++);

282 
x
 = 
	`xöt
(
dö
.
addrs
[
fbn
]);

286 i‡(
	`xöt
(
dö
.
addrs
[
NDIRECT
]) == 0)

288 
dö
.
addrs
[
NDIRECT
] = 
	`xöt
(
‰ìblock
++);

290 
	`r£˘
(
	`xöt
(
dö
.
addrs
[
NDIRECT
]), (*)
ödúe˘
);

291 i‡(
ödúe˘
[
fbn
 - 
NDIRECT
] == 0)

293 
ödúe˘
[
fbn
 - 
NDIRECT
] = 
	`xöt
(
‰ìblock
++);

294 
	`w£˘
(
	`xöt
(
dö
.
addrs
[
NDIRECT
]), (*)
ödúe˘
);

296 
x
 = 
	`xöt
(
ödúe˘
[
fbn
 - 
NDIRECT
]);

298 
n1
 = 
	`mö
(
n
, (
fbn
 + 1Ë* 
BSIZE
 - 
off
);

299 
	`r£˘
(
x
, 
buf
);

300 
	`bc›y
(
p
, 
buf
 + 
off
 - (
fbn
 * 
BSIZE
), 
n1
);

301 
	`w£˘
(
x
, 
buf
);

302 
n
 -
n1
;

303 
off
 +
n1
;

304 
p
 +
n1
;

306 
dö
.
size
 = 
	`xöt
(
off
);

307 
	`wöode
(
öum
, &
dö
);

308 
	}
}

	@mmu.h

5 
	#FL_IF
 0x00000200

6 

	)

8 
	#CR0_PE
 0x00000001

9 
	#CR0_WP
 0x00010000

10 
	#CR0_PG
 0x80000000

11 

	)

12 
	#CR4_PSE
 0x00000010

13 

	)

15 
	#SEG_KCODE
 1

16 
	#SEG_KDATA
 2

17 
	#SEG_UCODE
 3

18 
	#SEG_UDATA
 4

19 
	#SEG_TSS
 5

20 

	)

22 
	#NSEGS
 6

	)

24 #i‚de‡
__ASSEMBLER__


26 
	s£gdesc


28 
uöt
 
	mlim_15_0
 : 16;

29 
uöt
 
	mba£_15_0
 : 16;

30 
uöt
 
	mba£_23_16
 : 8;

31 
uöt
 
	mty≥
 : 4;

32 
uöt
 
	ms
 : 1;

33 
uöt
 
	md∂
 : 2;

34 
uöt
 
	mp
 : 1;

35 
uöt
 
	mlim_19_16
 : 4;

36 
uöt
 
	mavl
 : 1;

37 
uöt
 
	mrsv1
 : 1;

38 
uöt
 
	mdb
 : 1;

39 
uöt
 
	mg
 : 1;

40 
uöt
 
	mba£_31_24
 : 8;

44 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
) \

45 (
£gdesc
) \

47 ((
lim
Ë>> 12Ë& 0xffff, (
uöt
)(
ba£
)&0xffff, \

48 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 1, 
d∂
, 1, \

49 (
uöt
)(
lim
Ë>> 28, 0, 0, 1, 1, (uöt)(
ba£
) >> 24 \

50 }

	)

51 
	#SEG16
(
ty≥
, 
ba£
, 
lim
, 
d∂
) \

52 (
£gdesc
) \

54 (
lim
Ë& 0xffff, (
uöt
)(
ba£
)&0xffff, \

55 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 1, 
d∂
, 1, \

56 (
uöt
)(
lim
Ë>> 16, 0, 0, 1, 0, (uöt)(
ba£
) >> 24 \

57 }

	)

60 
	#DPL_USER
 0x3

61 

	)

63 
	#STA_X
 0x8

64 
	#STA_W
 0x2

65 
	#STA_R
 0x2

66 

	)

68 
	#STS_T32A
 0x9

69 
	#STS_IG32
 0xE

70 
	#STS_TG32
 0xF

71 

	)

81 
	#PDX
(
va
Ë(((
uöt
)(vaË>> 
PDXSHIFT
Ë& 0x3FF)

	)

84 
	#PTX
(
va
Ë(((
uöt
)(vaË>> 
PTXSHIFT
Ë& 0x3FF)

	)

87 
	#PGADDR
(
d
, 
t
, 
o
Ë((
uöt
)((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

90 
	#NPDENTRIES
 1024

91 
	#NPTENTRIES
 1024

92 
	#PGSIZE
 4096

93 

	)

94 
	#PTXSHIFT
 12

95 
	#PDXSHIFT
 22

96 

	)

97 
	#PGROUNDUP
(
sz
Ë(((szË+ 
PGSIZE
 - 1Ë& ~(PGSIZE - 1))

	)

98 
	#PGROUNDDOWN
(
a
Ë((◊)Ë& ~(
PGSIZE
 - 1))

	)

101 
	#PTE_P
 0x001

102 
	#PTE_W
 0x002

103 
	#PTE_U
 0x004

104 
	#PTE_PS
 0x080

105 

	)

107 
	#PTE_ADDR
(
±e
Ë((
uöt
)’ãË& ~0xFFF)

	)

108 
	#PTE_FLAGS
(
±e
Ë((
uöt
)’ã)&0xFFF)

	)

110 #i‚de‡
__ASSEMBLER__


111 
uöt
 
	t±e_t
;

114 
	sèsk°©e


116 
uöt
 
	mlök
;

117 
uöt
 
	me•0
;

118 
ush‹t
 
	mss0
;

119 
ush‹t
 
	m∑ddög1
;

120 
uöt
 *
	me•1
;

121 
ush‹t
 
	mss1
;

122 
ush‹t
 
	m∑ddög2
;

123 
uöt
 *
	me•2
;

124 
ush‹t
 
	mss2
;

125 
ush‹t
 
	m∑ddög3
;

126 *
	m¸3
;

127 
uöt
 *
	meù
;

128 
uöt
 
	meÊags
;

129 
uöt
 
	móx
;

130 
uöt
 
	mecx
;

131 
uöt
 
	medx
;

132 
uöt
 
	mebx
;

133 
uöt
 *
	me•
;

134 
uöt
 *
	mebp
;

135 
uöt
 
	mesi
;

136 
uöt
 
	medi
;

137 
ush‹t
 
	mes
;

138 
ush‹t
 
	m∑ddög4
;

139 
ush‹t
 
	mcs
;

140 
ush‹t
 
	m∑ddög5
;

141 
ush‹t
 
	mss
;

142 
ush‹t
 
	m∑ddög6
;

143 
ush‹t
 
	mds
;

144 
ush‹t
 
	m∑ddög7
;

145 
ush‹t
 
	mfs
;

146 
ush‹t
 
	m∑ddög8
;

147 
ush‹t
 
	mgs
;

148 
ush‹t
 
	m∑ddög9
;

149 
ush‹t
 
	mldt
;

150 
ush‹t
 
	m∑ddög10
;

151 
ush‹t
 
	mt
;

152 
ush‹t
 
	miomb
;

156 
	sg©edesc


158 
uöt
 
	moff_15_0
 : 16;

159 
uöt
 
	mcs
 : 16;

160 
uöt
 
	m¨gs
 : 5;

161 
uöt
 
	mrsv1
 : 3;

162 
uöt
 
	mty≥
 : 4;

163 
uöt
 
	ms
 : 1;

164 
uöt
 
	md∂
 : 2;

165 
uöt
 
	mp
 : 1;

166 
uöt
 
	moff_31_16
 : 16;

177 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d
) \

179 (
g©e
).
off_15_0
 = (
uöt
)(
off
)&0xffff; \

180 (
g©e
).
cs
 = (
£l
); \

181 (
g©e
).
¨gs
 = 0; \

182 (
g©e
).
rsv1
 = 0; \

183 (
g©e
).
ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

184 (
g©e
).
s
 = 0; \

185 (
g©e
).
d∂
 = (
d
); \

186 (
g©e
).
p
 = 1; \

187 (
g©e
).
off_31_16
 = (
uöt
)(
off
) >> 16; \

188 }

	)

	@mp.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"memœyout.h
"

9 
	~"mp.h
"

10 
	~"x86.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

14 
˝u
 
	g˝us
[
NCPU
];

15 
	gn˝u
;

16 
uch¨
 
	giﬂpicid
;

18 
uch¨


19 
	$sum
(
uch¨
 *
addr
, 
Àn
)

21 
i
, 
sum
;

23 
sum
 = 0;

24 
i
 = 0; i < 
Àn
; i++)

25 
sum
 +
addr
[
i
];

26  
sum
;

27 
	}
}

30 
mp
 *

31 
	$mp£¨ch1
(
uöt
 
a
, 
Àn
)

33 
uch¨
 *
e
, *
p
, *
addr
;

35 
addr
 = 
	`P2V
(
a
);

36 
e
 = 
addr
 + 
Àn
;

37 
p
 = 
addr
;Ö < 
e
;Ö +(
mp
))

38 i‡(
	`memcmp
(
p
, "_MP_", 4Ë=0 && 
	`sum
’, (
mp
)) == 0)

39  (
mp
 *)
p
;

41 
	}
}

48 
mp
 *

49 
	$mp£¨ch
()

51 
uch¨
 *
bda
;

52 
uöt
 
p
;

53 
mp
 *mp;

55 
bda
 = (
uch¨
 *)
	`P2V
(0x400);

56 i‡((
p
 = ((
bda
[0x0F] << 8) | bda[0x0E]) << 4))

58 i‡((
mp
 = 
	`mp£¨ch1
(
p
, 1024)))

59  
mp
;

63 
p
 = ((
bda
[0x14] << 8) | bda[0x13]) * 1024;

64 i‡((
mp
 = 
	`mp£¨ch1
(
p
 - 1024, 1024)))

65  
mp
;

67  
	`mp£¨ch1
(0xF0000, 0x10000);

68 
	}
}

75 
mpc⁄f
 *

76 
	$mpc⁄fig
(
mp
 **
pmp
)

78 
mpc⁄f
 *
c⁄f
;

79 
mp
 *mp;

81 i‡((
mp
 = 
	`mp£¨ch
()Ë=0 || mp->
phyßddr
 == 0)

83 
c⁄f
 = (
mpc⁄f
 *)
	`P2V
((
uöt
)
mp
->
phyßddr
);

84 i‡(
	`memcmp
(
c⁄f
, "PCMP", 4) != 0)

86 i‡(
c⁄f
->
vîsi⁄
 != 1 && conf->version != 4)

88 i‡(
	`sum
((
uch¨
 *)
c⁄f
, c⁄f->
Àngth
) != 0)

90 *
pmp
 = 
mp
;

91  
c⁄f
;

92 
	}
}

94 
	$mpöô
()

96 
uch¨
 *
p
, *
e
;

97 
ismp
;

98 
mp
 *mp;

99 
mpc⁄f
 *
c⁄f
;

100 
mµroc
 *
¥oc
;

101 
mpiﬂpic
 *
iﬂpic
;

103 i‡((
c⁄f
 = 
	`mpc⁄fig
(&
mp
)) == 0)

104 
	`∑nic
("ExpectÅoÑun onán SMP");

105 
ismp
 = 1;

106 
œpic
 = (
uöt
 *)
c⁄f
->
œpiˇddr
;

107 
p
 = (
uch¨
 *)(
c⁄f
 + 1), 
e
 = (uch¨ *)c⁄‡+ c⁄f->
Àngth
;Ö <É;)

109 *
p
)

111 
MPPROC
:

112 
¥oc
 = (
mµroc
 *)
p
;

113 i‡(
n˝u
 < 
NCPU
)

115 
˝us
[
n˝u
].
≠icid
 = 
¥oc
->apicid;

116 
n˝u
++;

118 
p
 +(
mµroc
);

120 
MPIOAPIC
:

121 
iﬂpic
 = (
mpiﬂpic
 *)
p
;

122 
iﬂpicid
 = 
iﬂpic
->
≠i˙o
;

123 
p
 +(
mpiﬂpic
);

125 
MPBUS
:

126 
MPIOINTR
:

127 
MPLINTR
:

128 
p
 += 8;

131 
ismp
 = 0;

135 i‡(!
ismp
)

136 
	`∑nic
("Didn't findá suitable machine");

138 i‡(
mp
->
im¸p
)

142 
	`outb
(0x22, 0x70);

143 
	`outb
(0x23, 
	`öb
(0x23) | 1);

145 
	}
}

	@mp.h

3 
	smp


5 
uch¨
 
	msig«tuª
[4];

6 *
	mphyßddr
;

7 
uch¨
 
	mÀngth
;

8 
uch¨
 
	m•e¸ev
;

9 
uch¨
 
	mchecksum
;

10 
uch¨
 
	mty≥
;

11 
uch¨
 
	mim¸p
;

12 
uch¨
 
	mª£rved
[3];

15 
	smpc⁄f


17 
uch¨
 
	msig«tuª
[4];

18 
ush‹t
 
	mÀngth
;

19 
uch¨
 
	mvîsi⁄
;

20 
uch¨
 
	mchecksum
;

21 
uch¨
 
	m¥odu˘
[20];

22 
uöt
 *
	m€mèbÀ
;

23 
ush‹t
 
	m€mÀngth
;

24 
ush‹t
 
	míåy
;

25 
uöt
 *
	mœpiˇddr
;

26 
ush‹t
 
	mxÀngth
;

27 
uch¨
 
	mxchecksum
;

28 
uch¨
 
	mª£rved
;

31 
	smµroc


33 
uch¨
 
	mty≥
;

34 
uch¨
 
	m≠icid
;

35 
uch¨
 
	mvîsi⁄
;

36 
uch¨
 
	mÊags
;

37 
	#MPBOOT
 0x02

38 
uch¨
 
sig«tuª
[4];

39 
uöt
 
„©uª
;

40 
uch¨
 
ª£rved
[8];

	)

43 
	smpiﬂpic


45 
uch¨
 
	mty≥
;

46 
uch¨
 
	m≠i˙o
;

47 
uch¨
 
	mvîsi⁄
;

48 
uch¨
 
	mÊags
;

49 
uöt
 *
	maddr
;

53 
	#MPPROC
 0x00

54 
	#MPBUS
 0x01

55 
	#MPIOAPIC
 0x02

56 
	#MPIOINTR
 0x03

57 
	#MPLINTR
 0x04

58 

	)

	@param.h

1 
	#NPROC
 64

2 
	#KSTACKSIZE
 4096

3 
	#NCPU
 8

4 
	#NOFILE
 16

5 
	#NFILE
 100

6 
	#NINODE
 50

7 
	#NDEV
 10

8 
	#ROOTDEV
 1

9 
	#MAXARG
 32

10 
	#MAXOPBLOCKS
 10

11 
	#LOGSIZE
 (
MAXOPBLOCKS
 * 3)

12 
	#NBUF
 (
MAXOPBLOCKS
 * 3)

13 
	#FSSIZE
 1000

	@picirq.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

3 
	~"å≠s.h
"

6 
	#IO_PIC1
 0x20

7 
	#IO_PIC2
 0xA0

8 

	)

10 
	$picöô
()

13 
	`outb
(
IO_PIC1
 + 1, 0xFF);

14 
	`outb
(
IO_PIC2
 + 1, 0xFF);

15 
	}
}

	@pipe.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"mmu.h
"

5 
	~"¥oc.h
"

6 
	~"fs.h
"

7 
	~"•ölock.h
"

8 
	~"¶ì∂ock.h
"

9 
	~"fûe.h
"

11 
	#PIPESIZE
 512

	)

13 
	spùe


15 
•ölock
 
	mlock
;

16 
	md©a
[
PIPESIZE
];

17 
uöt
 
	mƒód
;

18 
uöt
 
	mnwrôe
;

19 
	mªad›í
;

20 
	mwrôe›í
;

23 
	$pùóŒoc
(
fûe
 **
f0
, fûê**
f1
)

25 
pùe
 *
p
;

27 
p
 = 0;

28 *
f0
 = *
f1
 = 0;

29 i‡((*
f0
 = 
	`fûóŒoc
()Ë=0 || (*
f1
 = filealloc()) == 0)

30 
bad
;

31 i‡((
p
 = (
pùe
 *)
	`kÆloc
()) == 0)

32 
bad
;

33 
p
->
ªad›í
 = 1;

34 
p
->
wrôe›í
 = 1;

35 
p
->
nwrôe
 = 0;

36 
p
->
ƒód
 = 0;

37 
	`öôlock
(&
p
->
lock
, "pipe");

38 (*
f0
)->
ty≥
 = 
FD_PIPE
;

39 (*
f0
)->
ªadabÀ
 = 1;

40 (*
f0
)->
wrôabÀ
 = 0;

41 (*
f0
)->
pùe
 = 
p
;

42 (*
f1
)->
ty≥
 = 
FD_PIPE
;

43 (*
f1
)->
ªadabÀ
 = 0;

44 (*
f1
)->
wrôabÀ
 = 1;

45 (*
f1
)->
pùe
 = 
p
;

49 
bad
:

50 i‡(
p
)

51 
	`k‰ì
((*)
p
);

52 i‡(*
f0
)

53 
	`fûe˛o£
(*
f0
);

54 i‡(*
f1
)

55 
	`fûe˛o£
(*
f1
);

57 
	}
}

59 
	$pùe˛o£
(
pùe
 *
p
, 
wrôabÀ
)

61 
	`acquúe
(&
p
->
lock
);

62 i‡(
wrôabÀ
)

64 
p
->
wrôe›í
 = 0;

65 
	`wakeup
(&
p
->
ƒód
);

69 
p
->
ªad›í
 = 0;

70 
	`wakeup
(&
p
->
nwrôe
);

72 i‡(
p
->
ªad›í
 =0 &&Ö->
wrôe›í
 == 0)

74 
	`ªÀa£
(&
p
->
lock
);

75 
	`k‰ì
((*)
p
);

78 
	`ªÀa£
(&
p
->
lock
);

79 
	}
}

82 
	$pùewrôe
(
pùe
 *
p
, *
addr
, 
n
)

84 
i
;

86 
	`acquúe
(&
p
->
lock
);

87 
i
 = 0; i < 
n
; i++)

89 
p
->
nwrôe
 =p->
ƒód
 + 
PIPESIZE
)

91 i‡(
p
->
ªad›í
 =0 || 
	`my¥oc
()->
kûÀd
)

93 
	`ªÀa£
(&
p
->
lock
);

96 
	`wakeup
(&
p
->
ƒód
);

97 
	`¶ìp
(&
p
->
nwrôe
, &p->
lock
);

99 
p
->
d©a
[p->
nwrôe
++ % 
PIPESIZE
] = 
addr
[
i
];

101 
	`wakeup
(&
p
->
ƒód
);

102 
	`ªÀa£
(&
p
->
lock
);

103  
n
;

104 
	}
}

106 
	$pùîód
(
pùe
 *
p
, *
addr
, 
n
)

108 
i
;

110 
	`acquúe
(&
p
->
lock
);

111 
p
->
ƒód
 =p->
nwrôe
 &&Ö->
wrôe›í
)

113 i‡(
	`my¥oc
()->
kûÀd
)

115 
	`ªÀa£
(&
p
->
lock
);

118 
	`¶ìp
(&
p
->
ƒód
, &p->
lock
);

120 
i
 = 0; i < 
n
; i++)

122 i‡(
p
->
ƒód
 =p->
nwrôe
)

124 
addr
[
i
] = 
p
->
d©a
[p->
ƒód
++ % 
PIPESIZE
];

126 
	`wakeup
(&
p
->
nwrôe
);

127 
	`ªÀa£
(&
p
->
lock
);

128  
i
;

129 
	}
}

	@printf.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$putc
(
fd
, 
c
)

8 
	`wrôe
(
fd
, &
c
, 1);

9 
	}
}

12 
	$¥ötöt
(
fd
, 
xx
, 
ba£
, 
sgn
)

14 
digôs
[] = "0123456789ABCDEF";

15 
buf
[16];

16 
i
, 
√g
;

17 
uöt
 
x
;

19 
√g
 = 0;

20 if(
sgn
 && 
xx
 < 0){

21 
√g
 = 1;

22 
x
 = -
xx
;

24 
x
 = 
xx
;

27 
i
 = 0;

29 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

30 }(
x
 /
ba£
) != 0);

31 if(
√g
)

32 
buf
[
i
++] = '-';

34 --
i
 >= 0)

35 
	`putc
(
fd
, 
buf
[
i
]);

36 
	}
}

40 
	$¥ötf
(
fd
, c⁄° *
fmt
, ...)

42 *
s
;

43 
c
, 
i
, 
°©e
;

44 
uöt
 *
≠
;

46 
°©e
 = 0;

47 
≠
 = (
uöt
*)(*)&
fmt
 + 1;

48 
i
 = 0; 
fmt
[i]; i++){

49 
c
 = 
fmt
[
i
] & 0xff;

50 if(
°©e
 == 0){

51 if(
c
 == '%'){

52 
°©e
 = '%';

54 
	`putc
(
fd
, 
c
);

56 } if(
°©e
 == '%'){

57 if(
c
 == 'd'){

58 
	`¥ötöt
(
fd
, *
≠
, 10, 1);

59 
≠
++;

60 } if(
c
 == 'x' || c == 'p'){

61 
	`¥ötöt
(
fd
, *
≠
, 16, 0);

62 
≠
++;

63 } if(
c
 == 's'){

64 
s
 = (*)*
≠
;

65 
≠
++;

66 if(
s
 == 0)

67 
s
 = "(null)";

68 *
s
 != 0){

69 
	`putc
(
fd
, *
s
);

70 
s
++;

72 } if(
c
 == 'c'){

73 
	`putc
(
fd
, *
≠
);

74 
≠
++;

75 } if(
c
 == '%'){

76 
	`putc
(
fd
, 
c
);

79 
	`putc
(
fd
, '%');

80 
	`putc
(
fd
, 
c
);

82 
°©e
 = 0;

85 
	}
}

	@proc.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"x86.h
"

7 
	~"¥oc.h
"

8 
	~"•ölock.h
"

12 
•ölock
 
	mlock
;

13 
¥oc
 
	m¥oc
[
NPROC
];

14 } 
	g±abÀ
;

16 
¥oc
 *
	göô¥oc
;

18 
	g√xçid
 = 1;

19 
f‹kªt
();

20 
å≠ªt
();

22 
wakeup1
(*
ch™
);

24 
	$pöô
()

26 
	`öôlock
(&
±abÀ
.
lock
, "ptable");

27 
	}
}

30 
	$˝uid
()

32  
	`my˝u
(Ë- 
˝us
;

33 
	}
}

37 
˝u
 *

38 
	$my˝u
()

40 
≠icid
, 
i
;

42 i‡(
	`ªadeÊags
(Ë& 
FL_IF
)

43 
	`∑nic
("mycpu called with interruptsÉnabled\n");

45 
≠icid
 = 
	`œpicid
();

48 
i
 = 0; i < 
n˝u
; ++i)

50 i‡(
˝us
[
i
].
≠icid
 ==ápicid)

51  &
˝us
[
i
];

53 
	`∑nic
("unknownápicid\n");

54 
	}
}

58 
¥oc
 *

59 
	$my¥oc
()

61 
˝u
 *
c
;

62 
¥oc
 *
p
;

63 
	`push˛i
();

64 
c
 = 
	`my˝u
();

65 
p
 = 
c
->
¥oc
;

66 
	`p›˛i
();

67  
p
;

68 
	}
}

75 
¥oc
 *

76 
	$Ælo˝roc
()

78 
¥oc
 *
p
;

79 *
•
;

81 
	`acquúe
(&
±abÀ
.
lock
);

83 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

84 i‡(
p
->
°©e
 =
UNUSED
)

85 
found
;

87 
	`ªÀa£
(&
±abÀ
.
lock
);

90 
found
:

91 
p
->
°©e
 = 
EMBRYO
;

92 
p
->
pid
 = 
√xçid
++;

94 
	`ªÀa£
(&
±abÀ
.
lock
);

97 i‡((
p
->
k°ack
 = 
	`kÆloc
()) == 0)

99 
p
->
°©e
 = 
UNUSED
;

102 
•
 = 
p
->
k°ack
 + 
KSTACKSIZE
;

105 
•
 - *
p
->
tf
;

106 
p
->
tf
 = (
å≠‰ame
 *)
•
;

110 
•
 -= 4;

111 *(
uöt
 *)
•
 = (uöt)
å≠ªt
;

113 
•
 - *
p
->
c⁄ãxt
;

114 
p
->
c⁄ãxt
 = (c⁄ãxà*)
•
;

115 
	`mem£t
(
p
->
c⁄ãxt
, 0,  *p->context);

116 
p
->
c⁄ãxt
->
eù
 = (
uöt
)
f‹kªt
;

118  
p
;

119 
	}
}

123 
	$u£röô
()

125 
¥oc
 *
p
;

126 
_bö¨y_öôcode_°¨t
[], 
_bö¨y_öôcode_size
[];

128 
p
 = 
	`Ælo˝roc
();

130 
öô¥oc
 = 
p
;

131 i‡((
p
->
pgdú
 = 
	`£tupkvm
()) == 0)

132 
	`∑nic
("userinit: out of memory?");

133 
	`öôuvm
(
p
->
pgdú
, 
_bö¨y_öôcode_°¨t
, ()
_bö¨y_öôcode_size
);

134 
p
->
sz
 = 
PGSIZE
;

135 
	`mem£t
(
p
->
tf
, 0, (*p->tf));

136 
p
->
tf
->
cs
 = (
SEG_UCODE
 << 3Ë| 
DPL_USER
;

137 
p
->
tf
->
ds
 = (
SEG_UDATA
 << 3Ë| 
DPL_USER
;

138 
p
->
tf
->
es
 =Ö->tf->
ds
;

139 
p
->
tf
->
ss
 =Ö->tf->
ds
;

140 
p
->
tf
->
eÊags
 = 
FL_IF
;

141 
p
->
tf
->
e•
 = 
PGSIZE
;

142 
p
->
tf
->
eù
 = 0;

144 
	`ß„°r˝y
(
p
->
«me
, "initcode", (p->name));

145 
p
->
cwd
 = 
	`«mei
("/");

151 
	`acquúe
(&
±abÀ
.
lock
);

153 
p
->
°©e
 = 
RUNNABLE
;

155 
	`ªÀa£
(&
±abÀ
.
lock
);

156 
	}
}

160 
	$grow¥oc
(
n
)

162 
uöt
 
sz
;

163 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

165 
sz
 = 
cuΩroc
->sz;

166 i‡(
n
 > 0)

168 i‡((
sz
 = 
	`Ælocuvm
(
cuΩroc
->
pgdú
, sz, sz + 
n
)) == 0)

171 i‡(
n
 < 0)

173 i‡((
sz
 = 
	`dóŒocuvm
(
cuΩroc
->
pgdú
, sz, sz + 
n
)) == 0)

176 
cuΩroc
->
sz
 = sz;

177 
	`swôchuvm
(
cuΩroc
);

179 
	}
}

184 
	$f‹k
()

186 
i
, 
pid
;

187 
¥oc
 *
≈
;

188 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

191 i‡((
≈
 = 
	`Ælo˝roc
()) == 0)

197 i‡((
≈
->
pgdú
 = 
	`c›yuvm
(
cuΩroc
->pgdú, cuΩroc->
sz
)) == 0)

199 
	`k‰ì
(
≈
->
k°ack
);

200 
≈
->
k°ack
 = 0;

201 
≈
->
°©e
 = 
UNUSED
;

204 
≈
->
sz
 = 
cuΩroc
->sz;

205 
≈
->
∑ª¡
 = 
cuΩroc
;

206 *
≈
->
tf
 = *
cuΩroc
->tf;

209 
≈
->
tf
->
óx
 = 0;

211 
i
 = 0; i < 
NOFILE
; i++)

212 i‡(
cuΩroc
->
ofûe
[
i
])

213 
≈
->
ofûe
[
i
] = 
	`fûedup
(
cuΩroc
->ofile[i]);

214 
≈
->
cwd
 = 
	`idup
(
cuΩroc
->cwd);

216 
	`ß„°r˝y
(
≈
->
«me
, 
cuΩroc
->name, (curproc->name));

218 
pid
 = 
≈
->pid;

220 
	`acquúe
(&
±abÀ
.
lock
);

222 
≈
->
°©e
 = 
RUNNABLE
;

224 
	`ªÀa£
(&
±abÀ
.
lock
);

226  
pid
;

227 
	}
}

232 
	$exô
()

234 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

235 
¥oc
 *
p
;

236 
fd
;

238 i‡(
cuΩroc
 =
öô¥oc
)

239 
	`∑nic
("initÉxiting");

242 
fd
 = 0; fd < 
NOFILE
; fd++)

244 i‡(
cuΩroc
->
ofûe
[
fd
])

246 
	`fûe˛o£
(
cuΩroc
->
ofûe
[
fd
]);

247 
cuΩroc
->
ofûe
[
fd
] = 0;

251 
	`begö_›
();

252 
	`ùut
(
cuΩroc
->
cwd
);

253 
	`íd_›
();

254 
cuΩroc
->
cwd
 = 0;

256 
	`acquúe
(&
±abÀ
.
lock
);

259 
	`wakeup1
(
cuΩroc
->
∑ª¡
);

262 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

264 i‡(
p
->
∑ª¡
 =
cuΩroc
)

266 
p
->
∑ª¡
 = 
öô¥oc
;

267 i‡(
p
->
°©e
 =
ZOMBIE
)

268 
	`wakeup1
(
öô¥oc
);

273 
cuΩroc
->
°©e
 = 
ZOMBIE
;

274 
	`sched
();

275 
	`∑nic
("zombieÉxit");

276 
	}
}

280 
	$waô
()

282 
¥oc
 *
p
;

283 
havekids
, 
pid
;

284 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

286 
	`acquúe
(&
±abÀ
.
lock
);

290 
havekids
 = 0;

291 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

293 i‡(
p
->
∑ª¡
 !
cuΩroc
)

295 
havekids
 = 1;

296 i‡(
p
->
°©e
 =
ZOMBIE
)

299 
pid
 = 
p
->pid;

300 
	`k‰ì
(
p
->
k°ack
);

301 
p
->
k°ack
 = 0;

302 
	`‰ìvm
(
p
->
pgdú
);

303 
p
->
pid
 = 0;

304 
p
->
∑ª¡
 = 0;

305 
p
->
«me
[0] = 0;

306 
p
->
kûÀd
 = 0;

307 
p
->
°©e
 = 
UNUSED
;

308 
	`ªÀa£
(&
±abÀ
.
lock
);

309  
pid
;

314 i‡(!
havekids
 || 
cuΩroc
->
kûÀd
)

316 
	`ªÀa£
(&
±abÀ
.
lock
);

321 
	`¶ìp
(
cuΩroc
, &
±abÀ
.
lock
);

323 
	}
}

333 
	$scheduÀr
()

335 
¥oc
 *
p
;

336 
˝u
 *
c
 = 
	`my˝u
();

337 
c
->
¥oc
 = 0;

342 
	`°i
();

345 
	`acquúe
(&
±abÀ
.
lock
);

346 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

348 i‡(
p
->
°©e
 !
RUNNABLE
)

354 
c
->
¥oc
 = 
p
;

355 
	`swôchuvm
(
p
);

356 
p
->
°©e
 = 
RUNNING
;

358 
	`swtch
(&(
c
->
scheduÀr
), 
p
->
c⁄ãxt
);

359 
	`swôchkvm
();

363 
c
->
¥oc
 = 0;

365 
	`ªÀa£
(&
±abÀ
.
lock
);

367 
	}
}

376 
	$sched
()

378 
öã«
;

379 
¥oc
 *
p
 = 
	`my¥oc
();

381 i‡(!
	`hﬁdög
(&
±abÀ
.
lock
))

382 
	`∑nic
("schedÖtable.lock");

383 i‡(
	`my˝u
()->
n˛i
 != 1)

384 
	`∑nic
("schedÜocks");

385 i‡(
p
->
°©e
 =
RUNNING
)

386 
	`∑nic
("schedÑunning");

387 i‡(
	`ªadeÊags
(Ë& 
FL_IF
)

388 
	`∑nic
("sched interruptible");

389 
öã«
 = 
	`my˝u
()->intena;

390 
	`swtch
(&
p
->
c⁄ãxt
, 
	`my˝u
()->
scheduÀr
);

391 
	`my˝u
()->
öã«
 = intena;

392 
	}
}

395 
	$yõld
()

397 
	`acquúe
(&
±abÀ
.
lock
);

398 
	`my¥oc
()->
°©e
 = 
RUNNABLE
;

399 
	`sched
();

400 
	`ªÀa£
(&
±abÀ
.
lock
);

401 
	}
}

405 
	$f‹kªt
()

407 
fú°
 = 1;

409 
	`ªÀa£
(&
±abÀ
.
lock
);

411 i‡(
fú°
)

416 
fú°
 = 0;

417 
	`iöô
(
ROOTDEV
);

418 
	`öôlog
(
ROOTDEV
);

422 
	}
}

426 
	$¶ìp
(*
ch™
, 
•ölock
 *
lk
)

428 
¥oc
 *
p
 = 
	`my¥oc
();

430 i‡(
p
 == 0)

431 
	`∑nic
("sleep");

433 i‡(
lk
 == 0)

434 
	`∑nic
("sleep withoutÜk");

442 i‡(
lk
 !&
±abÀ
.
lock
)

444 
	`acquúe
(&
±abÀ
.
lock
);

445 
	`ªÀa£
(
lk
);

448 
p
->
ch™
 = chan;

449 
p
->
°©e
 = 
SLEEPING
;

451 
	`sched
();

454 
p
->
ch™
 = 0;

457 i‡(
lk
 !&
±abÀ
.
lock
)

459 
	`ªÀa£
(&
±abÀ
.
lock
);

460 
	`acquúe
(
lk
);

462 
	}
}

468 
	$wakeup1
(*
ch™
)

470 
¥oc
 *
p
;

472 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

473 i‡(
p
->
°©e
 =
SLEEPING
 &&Ö->
ch™
 == chan)

474 
p
->
°©e
 = 
RUNNABLE
;

475 
	}
}

478 
	$wakeup
(*
ch™
)

480 
	`acquúe
(&
±abÀ
.
lock
);

481 
	`wakeup1
(
ch™
);

482 
	`ªÀa£
(&
±abÀ
.
lock
);

483 
	}
}

488 
	$kûl
(
pid
)

490 
¥oc
 *
p
;

492 
	`acquúe
(&
±abÀ
.
lock
);

493 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

495 i‡(
p
->
pid
 ==Öid)

497 
p
->
kûÀd
 = 1;

499 i‡(
p
->
°©e
 =
SLEEPING
)

500 
p
->
°©e
 = 
RUNNABLE
;

501 
	`ªÀa£
(&
±abÀ
.
lock
);

505 
	`ªÀa£
(&
±abÀ
.
lock
);

507 
	}
}

513 
	$¥ocdump
()

515 *
°©es
[] = {

516 [
UNUSED
] "unused",

517 [
EMBRYO
] "embryo",

518 [
SLEEPING
] "sleep ",

519 [
RUNNABLE
] "runble",

520 [
RUNNING
] "run ",

521 [
ZOMBIE
] "zombie"};

522 
i
;

523 
¥oc
 *
p
;

524 *
°©e
;

525 
uöt
 
pc
[10];

527 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

529 i‡(
p
->
°©e
 =
UNUSED
)

531 i‡(
p
->
°©e
 >0 &&Ö->°©ê< 
	`NELEM
(
°©es
) && states[p->state])

532 
°©e
 = 
°©es
[
p
->state];

534 
°©e
 = "???";

535 
	`˝rötf
("%d %†%s", 
p
->
pid
, 
°©e
,Ö->
«me
);

536 i‡(
p
->
°©e
 =
SLEEPING
)

538 
	`gëˇŒîpcs
((
uöt
 *)
p
->
c⁄ãxt
->
ebp
 + 2, 
pc
);

539 
i
 = 0; i < 10 && 
pc
[i] != 0; i++)

540 
	`˝rötf
(" %p", 
pc
[
i
]);

542 
	`˝rötf
("\n");

544 
	}
}

	@proc.h

2 
	s˝u
 {

3 
uch¨
 
	m≠icid
;

4 
c⁄ãxt
 *
	mscheduÀr
;

5 
èsk°©e
 
	mts
;

6 
£gdesc
 
	mgdt
[
NSEGS
];

7 vﬁ©ûê
uöt
 
	m°¨ãd
;

8 
	mn˛i
;

9 
	möã«
;

10 
¥oc
 *
	m¥oc
;

13 
˝u
 
˝us
[
NCPU
];

14 
n˝u
;

27 
	sc⁄ãxt
 {

28 
uöt
 
	medi
;

29 
uöt
 
	mesi
;

30 
uöt
 
	mebx
;

31 
uöt
 
	mebp
;

32 
uöt
 
	meù
;

35 
	e¥oc°©e
 { 
	mUNUSED
, 
	mEMBRYO
, 
	mSLEEPING
, 
	mRUNNABLE
, 
	mRUNNING
, 
	mZOMBIE
 };

38 
	s¥oc
 {

39 
uöt
 
	msz
;

40 
pde_t
* 
	mpgdú
;

41 *
	mk°ack
;

42 
¥oc°©e
 
	m°©e
;

43 
	mpid
;

44 
¥oc
 *
	m∑ª¡
;

45 
å≠‰ame
 *
	mtf
;

46 
c⁄ãxt
 *
	mc⁄ãxt
;

47 *
	mch™
;

48 
	mkûÀd
;

49 
fûe
 *
	mofûe
[
NOFILE
];

50 
öode
 *
	mcwd
;

51 
	m«me
[16];

	@rm.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
i
;

9 i‡(
¨gc
 < 2)

11 
	`¥ötf
(2, "Usage:Ñm files...\n");

12 
	`exô
();

15 
i
 = 1; i < 
¨gc
; i++)

17 i‡(
	`u∆ök
(
¨gv
[
i
]) < 0)

19 
	`¥ötf
(2, "rm: %†ÁûedÅÿdñëe\n", 
¨gv
[
i
]);

24 
	`exô
();

25 
	}
}

	@sh.c

3 
	~"ty≥s.h
"

4 
	~"u£r.h
"

5 
	~"f˙é.h
"

8 
	#EXEC
 1

	)

9 
	#REDIR
 2

	)

10 
	#PIPE
 3

	)

11 
	#LIST
 4

	)

12 
	#BACK
 5

	)

14 
	#MAXARGS
 10

	)

16 
	scmd


18 
	mty≥
;

21 
	sexeccmd


23 
	mty≥
;

24 *
	m¨gv
[
MAXARGS
];

25 *
	mórgv
[
MAXARGS
];

28 
	sªdúcmd


30 
	mty≥
;

31 
cmd
 *
	mcmd
;

32 *
	mfûe
;

33 *
	mefûe
;

34 
	mmode
;

35 
	mfd
;

38 
	spùecmd


40 
	mty≥
;

41 
cmd
 *
	mÀ·
;

42 
cmd
 *
	mright
;

45 
	sli°cmd


47 
	mty≥
;

48 
cmd
 *
	mÀ·
;

49 
cmd
 *
	mright
;

52 
	sbackcmd


54 
	mty≥
;

55 
cmd
 *
	mcmd
;

58 
f‹k1
();

59 
∑nic
(*);

60 
cmd
 *
∑r£cmd
(*);

63 
	$runcmd
(
cmd
 *cmd)

65 
p
[2];

66 
backcmd
 *
bcmd
;

67 
execcmd
 *
ecmd
;

68 
li°cmd
 *
lcmd
;

69 
pùecmd
 *
pcmd
;

70 
ªdúcmd
 *
rcmd
;

72 i‡(
cmd
 == 0)

73 
	`exô
();

75 
cmd
->
ty≥
)

78 
	`∑nic
("runcmd");

80 
EXEC
:

81 
ecmd
 = (
execcmd
 *)
cmd
;

82 i‡(
ecmd
->
¨gv
[0] == 0)

83 
	`exô
();

84 
	`exec
(
ecmd
->
¨gv
[0],Écmd->argv);

85 
	`¥ötf
(2, "exe¯%†Áûed\n", 
ecmd
->
¨gv
[0]);

88 
REDIR
:

89 
rcmd
 = (
ªdúcmd
 *)
cmd
;

90 
	`˛o£
(
rcmd
->
fd
);

91 i‡(
	`›í
(
rcmd
->
fûe
,Ñcmd->
mode
) < 0)

93 
	`¥ötf
(2, "›í %†Áûed\n", 
rcmd
->
fûe
);

94 
	`exô
();

96 
	`runcmd
(
rcmd
->
cmd
);

99 
LIST
:

100 
lcmd
 = (
li°cmd
 *)
cmd
;

101 i‡(
	`f‹k1
() == 0)

102 
	`runcmd
(
lcmd
->
À·
);

103 
	`waô
();

104 
	`runcmd
(
lcmd
->
right
);

107 
PIPE
:

108 
pcmd
 = (
pùecmd
 *)
cmd
;

109 i‡(
	`pùe
(
p
) < 0)

110 
	`∑nic
("pipe");

111 i‡(
	`f‹k1
() == 0)

113 
	`˛o£
(1);

114 
	`dup
(
p
[1]);

115 
	`˛o£
(
p
[0]);

116 
	`˛o£
(
p
[1]);

117 
	`runcmd
(
pcmd
->
À·
);

119 i‡(
	`f‹k1
() == 0)

121 
	`˛o£
(0);

122 
	`dup
(
p
[0]);

123 
	`˛o£
(
p
[0]);

124 
	`˛o£
(
p
[1]);

125 
	`runcmd
(
pcmd
->
right
);

127 
	`˛o£
(
p
[0]);

128 
	`˛o£
(
p
[1]);

129 
	`waô
();

130 
	`waô
();

133 
BACK
:

134 
bcmd
 = (
backcmd
 *)
cmd
;

135 i‡(
	`f‹k1
() == 0)

136 
	`runcmd
(
bcmd
->
cmd
);

139 
	`exô
();

140 
	}
}

142 
	$gëcmd
(*
buf
, 
nbuf
)

144 
	`¥ötf
(2, "$ ");

145 
	`mem£t
(
buf
, 0, 
nbuf
);

146 
	`gës
(
buf
, 
nbuf
);

147 i‡(
buf
[0] == 0)

150 
	}
}

152 
	$maö
()

154 
buf
[100];

155 
fd
;

158 (
fd
 = 
	`›í
("c⁄sﬁe", 
O_RDWR
)) >= 0)

160 i‡(
fd
 >= 3)

162 
	`˛o£
(
fd
);

168 
	`gëcmd
(
buf
, (buf)) >= 0)

170 i‡(
buf
[0] == 'c' && buf[1] == 'd' && buf[2] == ' ')

173 
buf
[
	`°æí
(buf) - 1] = 0;

174 i‡(
	`chdú
(
buf
 + 3) < 0)

175 
	`¥ötf
(2, "ˇ¬Ÿ cd %s\n", 
buf
 + 3);

178 i‡(
	`f‹k1
() == 0)

179 
	`runcmd
(
	`∑r£cmd
(
buf
));

180 
	`waô
();

182 
	`exô
();

183 
	}
}

185 
	$∑nic
(*
s
)

187 
	`¥ötf
(2, "%s\n", 
s
);

188 
	`exô
();

189 
	}
}

191 
	$f‹k1
()

193 
pid
;

195 
pid
 = 
	`f‹k
();

196 i‡(
pid
 == -1)

197 
	`∑nic
("fork");

198  
pid
;

199 
	}
}

204 
cmd
 *

205 
	$execcmd
()

207 
execcmd
 *
cmd
;

209 
cmd
 = 
	`mÆloc
((*cmd));

210 
	`mem£t
(
cmd
, 0, (*cmd));

211 
cmd
->
ty≥
 = 
EXEC
;

212  (
cmd
 *)cmd;

213 
	}
}

215 
cmd
 *

216 
	$ªdúcmd
(
cmd
 *
subcmd
, *
fûe
, *
efûe
, 
mode
, 
fd
)

218 
ªdúcmd
 *
cmd
;

220 
cmd
 = 
	`mÆloc
((*cmd));

221 
	`mem£t
(
cmd
, 0, (*cmd));

222 
cmd
->
ty≥
 = 
REDIR
;

223 
cmd
->cmd = 
subcmd
;

224 
cmd
->
fûe
 = file;

225 
cmd
->
efûe
 =Éfile;

226 
cmd
->
mode
 = mode;

227 
cmd
->
fd
 = fd;

228  (
cmd
 *)cmd;

229 
	}
}

231 
cmd
 *

232 
	$pùecmd
(
cmd
 *
À·
, cmd *
right
)

234 
pùecmd
 *
cmd
;

236 
cmd
 = 
	`mÆloc
((*cmd));

237 
	`mem£t
(
cmd
, 0, (*cmd));

238 
cmd
->
ty≥
 = 
PIPE
;

239 
cmd
->
À·
 =Üeft;

240 
cmd
->
right
 =Ñight;

241  (
cmd
 *)cmd;

242 
	}
}

244 
cmd
 *

245 
	$li°cmd
(
cmd
 *
À·
, cmd *
right
)

247 
li°cmd
 *
cmd
;

249 
cmd
 = 
	`mÆloc
((*cmd));

250 
	`mem£t
(
cmd
, 0, (*cmd));

251 
cmd
->
ty≥
 = 
LIST
;

252 
cmd
->
À·
 =Üeft;

253 
cmd
->
right
 =Ñight;

254  (
cmd
 *)cmd;

255 
	}
}

257 
cmd
 *

258 
	$backcmd
(
cmd
 *
subcmd
)

260 
backcmd
 *
cmd
;

262 
cmd
 = 
	`mÆloc
((*cmd));

263 
	`mem£t
(
cmd
, 0, (*cmd));

264 
cmd
->
ty≥
 = 
BACK
;

265 
cmd
->cmd = 
subcmd
;

266  (
cmd
 *)cmd;

267 
	}
}

271 
	gwhôe•a˚
[] = " \t\r\n\v";

272 
	gsymbﬁs
[] = "<|>&;()";

274 
	$gëtokí
(**
ps
, *
es
, **
q
, **
eq
)

276 *
s
;

277 
ªt
;

279 
s
 = *
ps
;

280 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

281 
s
++;

282 i‡(
q
)

283 *
q
 = 
s
;

284 
ªt
 = *
s
;

285 *
s
)

295 
s
++;

298 
s
++;

299 i‡(*
s
 == '>')

301 
ªt
 = '+';

302 
s
++;

306 
ªt
 = 'a';

307 
s
 < 
es
 && !
	`°rchr
(
whôe•a˚
, *sË&& !°rchr(
symbﬁs
, *s))

308 
s
++;

311 i‡(
eq
)

312 *
eq
 = 
s
;

314 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

315 
s
++;

316 *
ps
 = 
s
;

317  
ªt
;

318 
	}
}

320 
	$≥ek
(**
ps
, *
es
, *
toks
)

322 *
s
;

324 
s
 = *
ps
;

325 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

326 
s
++;

327 *
ps
 = 
s
;

328  *
s
 && 
	`°rchr
(
toks
, *s);

329 
	}
}

331 
cmd
 *
∑r£löe
(**, *);

332 
cmd
 *
∑r£pùe
(**, *);

333 
cmd
 *
∑r£exec
(**, *);

334 
cmd
 *
nu…îmö©e
(cmd *);

336 
cmd
 *

337 
	$∑r£cmd
(*
s
)

339 *
es
;

340 
cmd
 *cmd;

342 
es
 = 
s
 + 
	`°æí
(s);

343 
cmd
 = 
	`∑r£löe
(&
s
, 
es
);

344 
	`≥ek
(&
s
, 
es
, "");

345 i‡(
s
 !
es
)

347 
	`¥ötf
(2, "À·ovîs: %s\n", 
s
);

348 
	`∑nic
("syntax");

350 
	`nu…îmö©e
(
cmd
);

351  
cmd
;

352 
	}
}

354 
cmd
 *

355 
	$∑r£löe
(**
ps
, *
es
)

357 
cmd
 *cmd;

359 
cmd
 = 
	`∑r£pùe
(
ps
, 
es
);

360 
	`≥ek
(
ps
, 
es
, "&"))

362 
	`gëtokí
(
ps
, 
es
, 0, 0);

363 
cmd
 = 
	`backcmd
(cmd);

365 i‡(
	`≥ek
(
ps
, 
es
, ";"))

367 
	`gëtokí
(
ps
, 
es
, 0, 0);

368 
cmd
 = 
	`li°cmd
(cmd, 
	`∑r£löe
(
ps
, 
es
));

370  
cmd
;

371 
	}
}

373 
cmd
 *

374 
	$∑r£pùe
(**
ps
, *
es
)

376 
cmd
 *cmd;

378 
cmd
 = 
	`∑r£exec
(
ps
, 
es
);

379 i‡(
	`≥ek
(
ps
, 
es
, "|"))

381 
	`gëtokí
(
ps
, 
es
, 0, 0);

382 
cmd
 = 
	`pùecmd
(cmd, 
	`∑r£pùe
(
ps
, 
es
));

384  
cmd
;

385 
	}
}

387 
cmd
 *

388 
	$∑r£ªdús
(
cmd
 *cmd, **
ps
, *
es
)

390 
tok
;

391 *
q
, *
eq
;

393 
	`≥ek
(
ps
, 
es
, "<>"))

395 
tok
 = 
	`gëtokí
(
ps
, 
es
, 0, 0);

396 i‡(
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
) != 'a')

397 
	`∑nic
("missing file forÑedirection");

398 
tok
)

401 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_RDONLY
, 0);

404 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
 | 
O_CREATE
, 1);

407 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
 | 
O_CREATE
, 1);

411  
cmd
;

412 
	}
}

414 
cmd
 *

415 
	$∑r£block
(**
ps
, *
es
)

417 
cmd
 *cmd;

419 i‡(!
	`≥ek
(
ps
, 
es
, "("))

420 
	`∑nic
("parseblock");

421 
	`gëtokí
(
ps
, 
es
, 0, 0);

422 
cmd
 = 
	`∑r£löe
(
ps
, 
es
);

423 i‡(!
	`≥ek
(
ps
, 
es
, ")"))

424 
	`∑nic
("syntax - missing )");

425 
	`gëtokí
(
ps
, 
es
, 0, 0);

426 
cmd
 = 
	`∑r£ªdús
(cmd, 
ps
, 
es
);

427  
cmd
;

428 
	}
}

430 
cmd
 *

431 
	$∑r£exec
(**
ps
, *
es
)

433 *
q
, *
eq
;

434 
tok
, 
¨gc
;

435 
execcmd
 *
cmd
;

436 
cmd
 *
ªt
;

438 i‡(
	`≥ek
(
ps
, 
es
, "("))

439  
	`∑r£block
(
ps
, 
es
);

441 
ªt
 = 
	`execcmd
();

442 
cmd
 = (
execcmd
 *)
ªt
;

444 
¨gc
 = 0;

445 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

446 !
	`≥ek
(
ps
, 
es
, "|)&;"))

448 i‡((
tok
 = 
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
)) == 0)

450 i‡(
tok
 != 'a')

451 
	`∑nic
("syntax");

452 
cmd
->
¨gv
[
¨gc
] = 
q
;

453 
cmd
->
órgv
[
¨gc
] = 
eq
;

454 
¨gc
++;

455 i‡(
¨gc
 >
MAXARGS
)

456 
	`∑nic
("too manyárgs");

457 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

459 
cmd
->
¨gv
[
¨gc
] = 0;

460 
cmd
->
órgv
[
¨gc
] = 0;

461  
ªt
;

462 
	}
}

465 
cmd
 *

466 
	$nu…îmö©e
(
cmd
 *cmd)

468 
i
;

469 
backcmd
 *
bcmd
;

470 
execcmd
 *
ecmd
;

471 
li°cmd
 *
lcmd
;

472 
pùecmd
 *
pcmd
;

473 
ªdúcmd
 *
rcmd
;

475 i‡(
cmd
 == 0)

478 
cmd
->
ty≥
)

480 
EXEC
:

481 
ecmd
 = (
execcmd
 *)
cmd
;

482 
i
 = 0; 
ecmd
->
¨gv
[i]; i++)

483 *
ecmd
->
órgv
[
i
] = 0;

486 
REDIR
:

487 
rcmd
 = (
ªdúcmd
 *)
cmd
;

488 
	`nu…îmö©e
(
rcmd
->
cmd
);

489 *
rcmd
->
efûe
 = 0;

492 
PIPE
:

493 
pcmd
 = (
pùecmd
 *)
cmd
;

494 
	`nu…îmö©e
(
pcmd
->
À·
);

495 
	`nu…îmö©e
(
pcmd
->
right
);

498 
LIST
:

499 
lcmd
 = (
li°cmd
 *)
cmd
;

500 
	`nu…îmö©e
(
lcmd
->
À·
);

501 
	`nu…îmö©e
(
lcmd
->
right
);

504 
BACK
:

505 
bcmd
 = (
backcmd
 *)
cmd
;

506 
	`nu…îmö©e
(
bcmd
->
cmd
);

509  
cmd
;

510 
	}
}

	@sleeplock.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"x86.h
"

7 
	~"memœyout.h
"

8 
	~"mmu.h
"

9 
	~"¥oc.h
"

10 
	~"•ölock.h
"

11 
	~"¶ì∂ock.h
"

13 
	$öô¶ì∂ock
(
¶ì∂ock
 *
lk
, *
«me
)

15 
	`öôlock
(&
lk
->lk, "sleepÜock");

16 
lk
->
«me
 =Çame;

17 
lk
->
locked
 = 0;

18 
lk
->
pid
 = 0;

19 
	}
}

21 
	$acquúe¶ìp
(
¶ì∂ock
 *
lk
)

23 
	`acquúe
(&
lk
->lk);

24 
lk
->
locked
)

26 
	`¶ìp
(
lk
, &lk->lk);

28 
lk
->
locked
 = 1;

29 
lk
->
pid
 = 
	`my¥oc
()->pid;

30 
	`ªÀa£
(&
lk
->lk);

31 
	}
}

33 
	$ªÀa£¶ìp
(
¶ì∂ock
 *
lk
)

35 
	`acquúe
(&
lk
->lk);

36 
lk
->
locked
 = 0;

37 
lk
->
pid
 = 0;

38 
	`wakeup
(
lk
);

39 
	`ªÀa£
(&
lk
->lk);

40 
	}
}

42 
	$hﬁdög¶ìp
(
¶ì∂ock
 *
lk
)

44 
r
;

46 
	`acquúe
(&
lk
->lk);

47 
r
 = 
lk
->
locked
 && (lk->
pid
 =
	`my¥oc
()->pid);

48 
	`ªÀa£
(&
lk
->lk);

49  
r
;

50 
	}
}

	@sleeplock.h

2 
	s¶ì∂ock


4 
uöt
 
	mlocked
;

5 
•ölock
 
	mlk
;

8 *
	m«me
;

9 
	mpid
;

	@spinlock.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"x86.h
"

7 
	~"memœyout.h
"

8 
	~"mmu.h
"

9 
	~"¥oc.h
"

10 
	~"•ölock.h
"

13 
	$öôlock
(
•ölock
 *
lk
, *
«me
)

15 
lk
->
«me
 =Çame;

16 
lk
->
locked
 = 0;

17 
lk
->
˝u
 = 0;

18 
	}
}

25 
	$acquúe
(
•ölock
 *
lk
)

27 
	`push˛i
();

28 if(
	`hﬁdög
(
lk
))

29 
	`∑nic
("acquire");

32 
	`xchg
(&
lk
->
locked
, 1) != 0)

38 
	`__sync_synchr⁄ize
();

41 
lk
->
˝u
 = 
	`my˝u
();

42 
	`gëˇŒîpcs
(&
lk
,Ük->
pcs
);

43 
	}
}

47 
	$ªÀa£
(
•ölock
 *
lk
)

49 if(!
	`hﬁdög
(
lk
))

50 
	`∑nic
("release");

52 
lk
->
pcs
[0] = 0;

53 
lk
->
˝u
 = 0;

60 
	`__sync_synchr⁄ize
();

65 
asm
 vﬁ©ûe("mov»$0, %0" : "+m" (
lk
->
locked
) : );

67 
	`p›˛i
();

68 
	}
}

72 
	$gëˇŒîpcs
(*
v
, 
uöt
 
pcs
[])

74 
uöt
 *
ebp
;

75 
i
;

77 
ebp
 = (
uöt
*)
v
 - 2;

78 
i
 = 0; i < 10; i++){

79 if(
ebp
 =0 ||Éb∞< (
uöt
*)
KERNBASE
 ||Ébp == (uint*)0xffffffff)

81 
pcs
[
i
] = 
ebp
[1];

82 
ebp
 = (
uöt
*)ebp[0];

84 ; 
i
 < 10; i++)

85 
pcs
[
i
] = 0;

86 
	}
}

90 
	$hﬁdög
(
•ölock
 *
lock
)

92 
r
;

93 
	`push˛i
();

94 
r
 = 
lock
->
locked
 &&Üock->
˝u
 =
	`my˝u
();

95 
	`p›˛i
();

96  
r
;

97 
	}
}

105 
	$push˛i
()

107 
eÊags
;

109 
eÊags
 = 
	`ªadeÊags
();

110 
	`˛i
();

111 if(
	`my˝u
()->
n˛i
 == 0)

112 
	`my˝u
()->
öã«
 = 
eÊags
 & 
FL_IF
;

113 
	`my˝u
()->
n˛i
 += 1;

114 
	}
}

117 
	$p›˛i
()

119 if(
	`ªadeÊags
()&
FL_IF
)

120 
	`∑nic
("popcli - interruptible");

121 if(--
	`my˝u
()->
n˛i
 < 0)

122 
	`∑nic
("popcli");

123 if(
	`my˝u
()->
n˛i
 =0 && my˝u()->
öã«
)

124 
	`°i
();

125 
	}
}

	@spinlock.h

2 
	s•ölock
 {

3 
uöt
 
	mlocked
;

6 *
	m«me
;

7 
˝u
 *
	m˝u
;

8 
uöt
 
	mpcs
[10];

	@stat.h

1 
	#T_DIR
 1

2 
	#T_FILE
 2

3 
	#T_DEV
 3

4 

	)

5 
	s°©


7 
	mty≥
;

8 
	mdev
;

9 
uöt
 
	möo
;

10 
	m∆ök
;

11 
uöt
 
	msize
;

	@stressfs.c

10 
	~"ty≥s.h
"

11 
	~"°©.h
"

12 
	~"u£r.h
"

13 
	~"fs.h
"

14 
	~"f˙é.h
"

17 
	$maö
(
¨gc
, *
¨gv
[])

19 
fd
, 
i
;

20 
∑th
[] = "stressfs0";

21 
d©a
[512];

23 
	`¥ötf
(1, "stressfs starting\n");

24 
	`mem£t
(
d©a
, 'a', (data));

26 
i
 = 0; i < 4; i++)

27 if(
	`f‹k
() > 0)

30 
	`¥ötf
(1, "wrôê%d\n", 
i
);

32 
∑th
[8] +
i
;

33 
fd
 = 
	`›í
(
∑th
, 
O_CREATE
 | 
O_RDWR
);

34 
i
 = 0; i < 20; i++)

36 
	`wrôe
(
fd
, 
d©a
, (data));

37 
	`˛o£
(
fd
);

39 
	`¥ötf
(1, "read\n");

41 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

42 
i
 = 0; i < 20; i++)

43 
	`ªad
(
fd
, 
d©a
, (data));

44 
	`˛o£
(
fd
);

46 
	`waô
();

48 
	`exô
();

49 
	}
}

	@string.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

5 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

7 i‡(()
d°
 % 4 =0 && 
n
 % 4 == 0)

9 
c
 &= 0xFF;

10 
	`°o¶
(
d°
, (
c
 << 24Ë| (¯<< 16Ë| (¯<< 8Ë| c, 
n
 / 4);

13 
	`°osb
(
d°
, 
c
, 
n
);

14  
d°
;

15 
	}
}

17 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
uöt
 
n
)

19 c⁄° 
uch¨
 *
s1
, *
s2
;

21 
s1
 = 
v1
;

22 
s2
 = 
v2
;

23 
n
-- > 0)

25 i‡(*
s1
 !*
s2
)

26  *
s1
 - *
s2
;

27 
s1
++, 
s2
++;

31 
	}
}

34 
	$memmove
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

36 c⁄° *
s
;

37 *
d
;

39 
s
 = 
§c
;

40 
d
 = 
d°
;

41 i‡(
s
 < 
d
 && s + 
n
 > d)

43 
s
 +
n
;

44 
d
 +
n
;

45 
n
-- > 0)

46 *--
d
 = *--
s
;

49 
n
-- > 0)

50 *
d
++ = *
s
++;

52  
d°
;

53 
	}
}

57 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

59  
	`memmove
(
d°
, 
§c
, 
n
);

60 
	}
}

62 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
uöt
 
n
)

64 
n
 > 0 && *
p
 && *∞=*
q
)

65 
n
--, 
p
++, 
q
++;

66 i‡(
n
 == 0)

68  (
uch¨
)*
p
 - (uch¨)*
q
;

69 
	}
}

72 
	$°∫˝y
(*
s
, c⁄° *
t
, 
n
)

74 *
os
;

76 
os
 = 
s
;

77 
n
-- > 0 && (*
s
++ = *
t
++) != 0)

79 
n
-- > 0)

80 *
s
++ = 0;

81  
os
;

82 
	}
}

86 
	$ß„°r˝y
(*
s
, c⁄° *
t
, 
n
)

88 *
os
;

90 
os
 = 
s
;

91 i‡(
n
 <= 0)

92  
os
;

93 --
n
 > 0 && (*
s
++ = *
t
++) != 0)

95 *
s
 = 0;

96  
os
;

97 
	}
}

99 
	$°æí
(c⁄° *
s
)

101 
n
;

103 
n
 = 0; 
s
[n];Ç++)

105  
n
;

106 
	}
}

	@swtch.S

2 #
#void 
swtch
(
c⁄ãxt
 **
ﬁd
, c⁄ãxà*
√w
);

4 #
#Savê
the
 
cuºít
 
ªgi°îs
 
⁄
Åhê
°ack
, 
¸ótög


6 #®
c⁄ãxt
, 
™d
 
ßve
 
ôs
 
addªss
 
ö
 *
ﬁd
.

7 #Swôch 
°acks
 
to
 
√w
 
™d
 
p›
 
¥eviou¶y
-
ßved
 
ªgi°îs
.

9 .
globl
 
swtch


10 
	gswtch
:

11 
movl
 4(%
e•
), %
óx


12 
	gmovl
 8(%
	ge•
), %
	gedx


14 #Savê
ﬁd
 
ˇŒì
-
ßved
 
ªgi°îs


15 
	gpushl
 %
ebp


16 
	gpushl
 %
ebx


17 
	gpushl
 %
esi


18 
	gpushl
 %
	gedi


20 #Swôch 
°acks


21 
	gmovl
 %
	ge•
, (%
	góx
)

22 
	gmovl
 %
	gedx
, %
	ge•


24 #Lﬂd 
√w
 
ˇŒì
-
ßved
 
ªgi°îs


25 
	gp›l
 %
edi


26 
	gp›l
 %
esi


27 
	gp›l
 %
ebx


28 
	gp›l
 %
ebp


29 
	gªt


	@syscall.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

8 
	~"sysˇŒ.h
"

17 
	$„tchöt
(
uöt
 
addr
, *
ù
)

19 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

21 i‡(
addr
 >
cuΩroc
->
sz
 ||áddr + 4 > curproc->sz)

23 *
ù
 = *(*)(
addr
);

25 
	}
}

30 
	$„tch°r
(
uöt
 
addr
, **
µ
)

32 *
s
, *
ï
;

33 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

35 i‡(
addr
 >
cuΩroc
->
sz
)

37 *
µ
 = (*)
addr
;

38 
ï
 = (*)
cuΩroc
->
sz
;

39 
s
 = *
µ
; s < 
ï
; s++)

41 i‡(*
s
 == 0)

42  
s
 - *
µ
;

45 
	}
}

48 
	$¨göt
(
n
, *
ù
)

50  
	`„tchöt
((
	`my¥oc
()->
tf
->
e•
Ë+ 4 + 4 * 
n
, 
ù
);

51 
	}
}

56 
	$¨g±r
(
n
, **
µ
, 
size
)

58 
i
;

59 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

61 i‡(
	`¨göt
(
n
, &
i
) < 0)

63 i‡(
size
 < 0 || (
uöt
)
i
 >
cuΩroc
->
sz
 || (uint)i + size > curproc->sz)

65 *
µ
 = (*)
i
;

67 
	}
}

73 
	$¨g°r
(
n
, **
µ
)

75 
addr
;

76 i‡(
	`¨göt
(
n
, &
addr
) < 0)

78  
	`„tch°r
(
addr
, 
µ
);

79 
	}
}

81 
sys_chdú
();

82 
sys_˛o£
();

83 
sys_dup
();

84 
sys_exec
();

85 
sys_exô
();

86 
sys_f‹k
();

87 
sys_f°©
();

88 
sys_gëpid
();

89 
sys_kûl
();

90 
sys_lök
();

91 
sys_mkdú
();

92 
sys_mknod
();

93 
sys_›í
();

94 
sys_pùe
();

95 
sys_ªad
();

96 
sys_sbrk
();

97 
sys_¶ìp
();

98 
sys_u∆ök
();

99 
sys_waô
();

100 
sys_wrôe
();

101 
sys_u±ime
();

103 (*
sysˇŒs
[])() = {

104 [
SYS_f‹k
] 
sys_f‹k
,

105 [
SYS_exô
] 
sys_exô
,

106 [
SYS_waô
] 
sys_waô
,

107 [
SYS_pùe
] 
sys_pùe
,

108 [
SYS_ªad
] 
sys_ªad
,

109 [
SYS_kûl
] 
sys_kûl
,

110 [
SYS_exec
] 
sys_exec
,

111 [
SYS_f°©
] 
sys_f°©
,

112 [
SYS_chdú
] 
sys_chdú
,

113 [
SYS_dup
] 
sys_dup
,

114 [
SYS_gëpid
] 
sys_gëpid
,

115 [
SYS_sbrk
] 
sys_sbrk
,

116 [
SYS_¶ìp
] 
sys_¶ìp
,

117 [
SYS_u±ime
] 
sys_u±ime
,

118 [
SYS_›í
] 
sys_›í
,

119 [
SYS_wrôe
] 
sys_wrôe
,

120 [
SYS_mknod
] 
sys_mknod
,

121 [
SYS_u∆ök
] 
sys_u∆ök
,

122 [
SYS_lök
] 
sys_lök
,

123 [
SYS_mkdú
] 
sys_mkdú
,

124 [
SYS_˛o£
] 
sys_˛o£
,

125 
	}
};

127 
	$sysˇŒ
()

129 
num
;

130 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

132 
num
 = 
cuΩroc
->
tf
->
óx
;

133 i‡(
num
 > 0 &&Çum < 
	`NELEM
(
sysˇŒs
) && syscalls[num])

135 
cuΩroc
->
tf
->
óx
 = 
sysˇŒs
[
num
]();

139 
	`˝rötf
("%d %s: unknown sys call %d\n",

140 
cuΩroc
->
pid
, cuΩroc->
«me
, 
num
);

141 
cuΩroc
->
tf
->
óx
 = -1;

143 
	}
}

	@syscall.h

2 
	#SYS_f‹k
 1

	)

3 
	#SYS_exô
 2

	)

4 
	#SYS_waô
 3

	)

5 
	#SYS_pùe
 4

	)

6 
	#SYS_ªad
 5

	)

7 
	#SYS_kûl
 6

	)

8 
	#SYS_exec
 7

	)

9 
	#SYS_f°©
 8

	)

10 
	#SYS_chdú
 9

	)

11 
	#SYS_dup
 10

	)

12 
	#SYS_gëpid
 11

	)

13 
	#SYS_sbrk
 12

	)

14 
	#SYS_¶ìp
 13

	)

15 
	#SYS_u±ime
 14

	)

16 
	#SYS_›í
 15

	)

17 
	#SYS_wrôe
 16

	)

18 
	#SYS_mknod
 17

	)

19 
	#SYS_u∆ök
 18

	)

20 
	#SYS_lök
 19

	)

21 
	#SYS_mkdú
 20

	)

22 
	#SYS_˛o£
 21

	)

	@sysfile.c

7 
	~"ty≥s.h
"

8 
	~"defs.h
"

9 
	~"∑øm.h
"

10 
	~"°©.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

13 
	~"fs.h
"

14 
	~"•ölock.h
"

15 
	~"¶ì∂ock.h
"

16 
	~"fûe.h
"

17 
	~"f˙é.h
"

22 
	$¨gfd
(
n
, *
pfd
, 
fûe
 **
pf
)

24 
fd
;

25 
fûe
 *
f
;

27 i‡(
	`¨göt
(
n
, &
fd
) < 0)

29 i‡(
fd
 < 0 || fd >
NOFILE
 || (
f
 = 
	`my¥oc
()->
ofûe
[fd]) == 0)

31 i‡(
pfd
)

32 *
pfd
 = 
fd
;

33 i‡(
pf
)

34 *
pf
 = 
f
;

36 
	}
}

41 
	$fdÆloc
(
fûe
 *
f
)

43 
fd
;

44 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

46 
fd
 = 0; fd < 
NOFILE
; fd++)

48 i‡(
cuΩroc
->
ofûe
[
fd
] == 0)

50 
cuΩroc
->
ofûe
[
fd
] = 
f
;

51  
fd
;

55 
	}
}

57 
	$sys_dup
()

59 
fûe
 *
f
;

60 
fd
;

62 i‡(
	`¨gfd
(0, 0, &
f
) < 0)

64 i‡((
fd
 = 
	`fdÆloc
(
f
)) < 0)

66 
	`fûedup
(
f
);

67  
fd
;

68 
	}
}

70 
	$sys_ªad
()

72 
fûe
 *
f
;

73 
n
;

74 *
p
;

76 i‡(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨g±r
(1, &
p
,Ç) < 0)

78  
	`fûîód
(
f
, 
p
, 
n
);

79 
	}
}

81 
	$sys_wrôe
()

83 
fûe
 *
f
;

84 
n
;

85 *
p
;

87 i‡(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨g±r
(1, &
p
,Ç) < 0)

89  
	`fûewrôe
(
f
, 
p
, 
n
);

90 
	}
}

92 
	$sys_˛o£
()

94 
fd
;

95 
fûe
 *
f
;

97 i‡(
	`¨gfd
(0, &
fd
, &
f
) < 0)

99 
	`my¥oc
()->
ofûe
[
fd
] = 0;

100 
	`fûe˛o£
(
f
);

102 
	}
}

104 
	$sys_f°©
()

106 
fûe
 *
f
;

107 
°©
 *
°
;

109 i‡(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨g±r
(1, (*)&
°
, (*st)) < 0)

111  
	`fûe°©
(
f
, 
°
);

112 
	}
}

115 
	$sys_lök
()

117 
«me
[
DIRSIZ
], *
√w
, *
ﬁd
;

118 
öode
 *
dp
, *
ù
;

120 i‡(
	`¨g°r
(0, &
ﬁd
Ë< 0 ||árg°r(1, &
√w
) < 0)

123 
	`begö_›
();

124 i‡((
ù
 = 
	`«mei
(
ﬁd
)) == 0)

126 
	`íd_›
();

130 
	`ûock
(
ù
);

131 i‡(
ù
->
ty≥
 =
T_DIR
)

133 
	`iu∆ockput
(
ù
);

134 
	`íd_›
();

138 
ù
->
∆ök
++;

139 
	`iupd©e
(
ù
);

140 
	`iu∆ock
(
ù
);

142 i‡((
dp
 = 
	`«meù¨ít
(
√w
, 
«me
)) == 0)

143 
bad
;

144 
	`ûock
(
dp
);

145 i‡(
dp
->
dev
 !
ù
->dev || 
	`dúlök
(dp, 
«me
, ip->
öum
) < 0)

147 
	`iu∆ockput
(
dp
);

148 
bad
;

150 
	`iu∆ockput
(
dp
);

151 
	`ùut
(
ù
);

153 
	`íd_›
();

157 
bad
:

158 
	`ûock
(
ù
);

159 
ù
->
∆ök
--;

160 
	`iupd©e
(
ù
);

161 
	`iu∆ockput
(
ù
);

162 
	`íd_›
();

164 
	}
}

168 
	$isdúem±y
(
öode
 *
dp
)

170 
off
;

171 
dúít
 
de
;

173 
off
 = 2 * (
de
); of‡< 
dp
->
size
; off += (de))

175 i‡(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

176 
	`∑nic
("isdirempty:Ñeadi");

177 i‡(
de
.
öum
 != 0)

181 
	}
}

184 
	$sys_u∆ök
()

186 
öode
 *
ù
, *
dp
;

187 
dúít
 
de
;

188 
«me
[
DIRSIZ
], *
∑th
;

189 
uöt
 
off
;

191 i‡(
	`¨g°r
(0, &
∑th
) < 0)

194 
	`begö_›
();

195 i‡((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0)

197 
	`íd_›
();

201 
	`ûock
(
dp
);

204 i‡(
	`«mecmp
(
«me
, ".") == 0 ||Çamecmp(name, "..") == 0)

205 
bad
;

207 i‡((
ù
 = 
	`dúlookup
(
dp
, 
«me
, &
off
)) == 0)

208 
bad
;

209 
	`ûock
(
ù
);

211 i‡(
ù
->
∆ök
 < 1)

212 
	`∑nic
("unlink:Çlink < 1");

213 i‡(
ù
->
ty≥
 =
T_DIR
 && !
	`isdúem±y
(ip))

215 
	`iu∆ockput
(
ù
);

216 
bad
;

219 
	`mem£t
(&
de
, 0, (de));

220 i‡(
	`wrôei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

221 
	`∑nic
("unlink: writei");

222 i‡(
ù
->
ty≥
 =
T_DIR
)

224 
dp
->
∆ök
--;

225 
	`iupd©e
(
dp
);

227 
	`iu∆ockput
(
dp
);

229 
ù
->
∆ök
--;

230 
	`iupd©e
(
ù
);

231 
	`iu∆ockput
(
ù
);

233 
	`íd_›
();

237 
bad
:

238 
	`iu∆ockput
(
dp
);

239 
	`íd_›
();

241 
	}
}

243 
öode
 *

244 
	$¸óã
(*
∑th
, 
ty≥
, 
maj‹
, 
mö‹
)

246 
öode
 *
ù
, *
dp
;

247 
«me
[
DIRSIZ
];

249 i‡((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0)

251 
	`ûock
(
dp
);

253 i‡((
ù
 = 
	`dúlookup
(
dp
, 
«me
, 0)) != 0)

255 
	`iu∆ockput
(
dp
);

256 
	`ûock
(
ù
);

257 i‡(
ty≥
 =
T_FILE
 && 
ù
->type == T_FILE)

258  
ù
;

259 
	`iu∆ockput
(
ù
);

263 i‡((
ù
 = 
	`üŒoc
(
dp
->
dev
, 
ty≥
)) == 0)

264 
	`∑nic
("create: ialloc");

266 
	`ûock
(
ù
);

267 
ù
->
maj‹
 = major;

268 
ù
->
mö‹
 = minor;

269 
ù
->
∆ök
 = 1;

270 
	`iupd©e
(
ù
);

272 i‡(
ty≥
 =
T_DIR
)

274 
dp
->
∆ök
++;

275 
	`iupd©e
(
dp
);

277 i‡(
	`dúlök
(
ù
, ".", ip->
öum
Ë< 0 || dúlök(ù, "..", 
dp
->inum) < 0)

278 
	`∑nic
("create dots");

281 i‡(
	`dúlök
(
dp
, 
«me
, 
ù
->
öum
) < 0)

282 
	`∑nic
("create: dirlink");

284 
	`iu∆ockput
(
dp
);

286  
ù
;

287 
	}
}

289 
	$sys_›í
()

291 *
∑th
;

292 
fd
, 
omode
;

293 
fûe
 *
f
;

294 
öode
 *
ù
;

296 i‡(
	`¨g°r
(0, &
∑th
Ë< 0 || 
	`¨göt
(1, &
omode
) < 0)

299 
	`begö_›
();

301 i‡(
omode
 & 
O_CREATE
)

303 
ù
 = 
	`¸óã
(
∑th
, 
T_FILE
, 0, 0);

304 i‡(
ù
 == 0)

306 
	`íd_›
();

312 i‡((
ù
 = 
	`«mei
(
∑th
)) == 0)

314 
	`íd_›
();

317 
	`ûock
(
ù
);

318 i‡(
ù
->
ty≥
 =
T_DIR
 && 
omode
 !
O_RDONLY
)

320 
	`iu∆ockput
(
ù
);

321 
	`íd_›
();

326 i‡((
f
 = 
	`fûóŒoc
()Ë=0 || (
fd
 = 
	`fdÆloc
(f)) < 0)

328 i‡(
f
)

329 
	`fûe˛o£
(
f
);

330 
	`iu∆ockput
(
ù
);

331 
	`íd_›
();

334 
	`iu∆ock
(
ù
);

335 
	`íd_›
();

337 
f
->
ty≥
 = 
FD_INODE
;

338 
f
->
ù
 = ip;

339 
f
->
off
 = 0;

340 
f
->
ªadabÀ
 = !(
omode
 & 
O_WRONLY
);

341 
f
->
wrôabÀ
 = (
omode
 & 
O_WRONLY
Ë|| (omodê& 
O_RDWR
);

342  
fd
;

343 
	}
}

345 
	$sys_mkdú
()

347 *
∑th
;

348 
öode
 *
ù
;

350 
	`begö_›
();

351 i‡(
	`¨g°r
(0, &
∑th
Ë< 0 || (
ù
 = 
	`¸óã
’©h, 
T_DIR
, 0, 0)) == 0)

353 
	`íd_›
();

356 
	`iu∆ockput
(
ù
);

357 
	`íd_›
();

359 
	}
}

361 
	$sys_mknod
()

363 
öode
 *
ù
;

364 *
∑th
;

365 
maj‹
, 
mö‹
;

367 
	`begö_›
();

368 i‡((
	`¨g°r
(0, &
∑th
)) < 0 ||

369 
	`¨göt
(1, &
maj‹
) < 0 ||

370 
	`¨göt
(2, &
mö‹
) < 0 ||

371 (
ù
 = 
	`¸óã
(
∑th
, 
T_DEV
, 
maj‹
, 
mö‹
)) == 0)

373 
	`íd_›
();

376 
	`iu∆ockput
(
ù
);

377 
	`íd_›
();

379 
	}
}

381 
	$sys_chdú
()

383 *
∑th
;

384 
öode
 *
ù
;

385 
¥oc
 *
cuΩroc
 = 
	`my¥oc
();

387 
	`begö_›
();

388 i‡(
	`¨g°r
(0, &
∑th
Ë< 0 || (
ù
 = 
	`«mei
(path)) == 0)

390 
	`íd_›
();

393 
	`ûock
(
ù
);

394 i‡(
ù
->
ty≥
 !
T_DIR
)

396 
	`iu∆ockput
(
ù
);

397 
	`íd_›
();

400 
	`iu∆ock
(
ù
);

401 
	`ùut
(
cuΩroc
->
cwd
);

402 
	`íd_›
();

403 
cuΩroc
->
cwd
 = 
ù
;

405 
	}
}

407 
	$sys_exec
()

409 *
∑th
, *
¨gv
[
MAXARG
];

410 
i
;

411 
uöt
 
u¨gv
, 
u¨g
;

413 i‡(
	`¨g°r
(0, &
∑th
Ë< 0 || 
	`¨göt
(1, (*)&
u¨gv
) < 0)

417 
	`mem£t
(
¨gv
, 0, (argv));

418 
i
 = 0;; i++)

420 i‡(
i
 >
	`NELEM
(
¨gv
))

422 i‡(
	`„tchöt
(
u¨gv
 + 4 * 
i
, (*)&
u¨g
) < 0)

424 i‡(
u¨g
 == 0)

426 
¨gv
[
i
] = 0;

429 i‡(
	`„tch°r
(
u¨g
, &
¨gv
[
i
]) < 0)

432  
	`exec
(
∑th
, 
¨gv
);

433 
	}
}

435 
	$sys_pùe
()

437 *
fd
;

438 
fûe
 *
rf
, *
wf
;

439 
fd0
, 
fd1
;

441 i‡(
	`¨g±r
(0, (*)&
fd
, 2 * (fd[0])) < 0)

443 i‡(
	`pùóŒoc
(&
rf
, &
wf
) < 0)

445 
fd0
 = -1;

446 i‡((
fd0
 = 
	`fdÆloc
(
rf
)Ë< 0 || (
fd1
 = fdÆloc(
wf
)) < 0)

448 i‡(
fd0
 >= 0)

449 
	`my¥oc
()->
ofûe
[
fd0
] = 0;

450 
	`fûe˛o£
(
rf
);

451 
	`fûe˛o£
(
wf
);

454 
fd
[0] = 
fd0
;

455 
fd
[1] = 
fd1
;

457 
	}
}

	@sysproc.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"d©e.h
"

5 
	~"∑øm.h
"

6 
	~"memœyout.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

10 
	$sys_f‹k
()

12  
	`f‹k
();

13 
	}
}

15 
	$sys_exô
()

17 
	`exô
();

19 
	}
}

21 
	$sys_waô
()

23  
	`waô
();

24 
	}
}

26 
	$sys_kûl
()

28 
pid
;

30 i‡(
	`¨göt
(0, &
pid
) < 0)

32  
	`kûl
(
pid
);

33 
	}
}

35 
	$sys_gëpid
()

37  
	`my¥oc
()->
pid
;

38 
	}
}

40 
	$sys_sbrk
()

42 
addr
;

43 
n
;

45 i‡(
	`¨göt
(0, &
n
) < 0)

47 
addr
 = 
	`my¥oc
()->
sz
;

48 i‡(
	`grow¥oc
(
n
) < 0)

50  
addr
;

51 
	}
}

53 
	$sys_¶ìp
()

55 
n
;

56 
uöt
 
ticks0
;

58 i‡(
	`¨göt
(0, &
n
) < 0)

60 
	`acquúe
(&
tick¶ock
);

61 
ticks0
 = 
ticks
;

62 
ticks
 - 
ticks0
 < 
n
)

64 i‡(
	`my¥oc
()->
kûÀd
)

66 
	`ªÀa£
(&
tick¶ock
);

69 
	`¶ìp
(&
ticks
, &
tick¶ock
);

71 
	`ªÀa£
(&
tick¶ock
);

73 
	}
}

77 
	$sys_u±ime
()

79 
uöt
 
xticks
;

81 
	`acquúe
(&
tick¶ock
);

82 
xticks
 = 
ticks
;

83 
	`ªÀa£
(&
tick¶ock
);

84  
xticks
;

85 
	}
}

	@trap.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

8 
	~"å≠s.h
"

9 
	~"•ölock.h
"

12 
g©edesc
 
	gidt
[256];

13 
uöt
 
ve˘‹s
[];

14 
•ölock
 
	gtick¶ock
;

15 
uöt
 
	gticks
;

17 
	$tvöô
()

19 
i
;

21 
i
 = 0; i < 256; i++)

22 
	`SETGATE
(
idt
[
i
], 0, 
SEG_KCODE
 << 3, 
ve˘‹s
[i], 0);

23 
	`SETGATE
(
idt
[
T_SYSCALL
], 1, 
SEG_KCODE
 << 3, 
ve˘‹s
[T_SYSCALL], 
DPL_USER
);

25 
	`öôlock
(&
tick¶ock
, "time");

26 
	}
}

28 
	$idtöô
()

30 
	`lidt
(
idt
, (idt));

31 
	}
}

34 
	$å≠
(
å≠‰ame
 *
tf
)

36 i‡(
tf
->
å≠no
 =
T_SYSCALL
)

38 i‡(
	`my¥oc
()->
kûÀd
)

39 
	`exô
();

40 
	`my¥oc
()->
tf
 =Åf;

41 
	`sysˇŒ
();

42 i‡(
	`my¥oc
()->
kûÀd
)

43 
	`exô
();

47 
tf
->
å≠no
)

49 
T_IRQ0
 + 
IRQ_TIMER
:

50 i‡(
	`˝uid
() == 0)

52 
	`acquúe
(&
tick¶ock
);

53 
ticks
++;

54 
	`wakeup
(&
ticks
);

55 
	`ªÀa£
(&
tick¶ock
);

57 
	`œpi˚oi
();

59 
T_IRQ0
 + 
IRQ_IDE
:

60 
	`ideöå
();

61 
	`œpi˚oi
();

63 
T_IRQ0
 + 
IRQ_IDE
 + 1:

66 
T_IRQ0
 + 
IRQ_KBD
:

67 
	`kbdöå
();

68 
	`œpi˚oi
();

70 
T_IRQ0
 + 
IRQ_COM1
:

71 
	`u¨töå
();

72 
	`œpi˚oi
();

74 
T_IRQ0
 + 7:

75 
T_IRQ0
 + 
IRQ_SPURIOUS
:

76 
	`˝rötf
("cpu%d: spurious interruptát %x:%x\n",

77 
	`˝uid
(), 
tf
->
cs
,Åf->
eù
);

78 
	`œpi˚oi
();

83 i‡(
	`my¥oc
(Ë=0 || (
tf
->
cs
 & 3) == 0)

86 
	`˝rötf
("unexpectedÅrap %d from cpu %dÉip %x (cr2=0x%x)\n",

87 
tf
->
å≠no
, 
	`˝uid
(),Åf->
eù
, 
	`r¸2
());

88 
	`∑nic
("trap");

91 
	`˝rötf
("pid %d %s:Årap %dÉrr %d on cpu %d "

93 
	`my¥oc
()->
pid
, my¥oc()->
«me
, 
tf
->
å≠no
,

94 
tf
->
îr
, 
	`˝uid
(),Åf->
eù
, 
	`r¸2
());

95 
	`my¥oc
()->
kûÀd
 = 1;

101 i‡(
	`my¥oc
(Ë&& my¥oc()->
kûÀd
 && (
tf
->
cs
 & 3Ë=
DPL_USER
)

102 
	`exô
();

106 i‡(
	`my¥oc
(Ë&& my¥oc()->
°©e
 =
RUNNING
 &&

107 
tf
->
å≠no
 =
T_IRQ0
 + 
IRQ_TIMER
)

108 
	`yõld
();

111 i‡(
	`my¥oc
(Ë&& my¥oc()->
kûÀd
 && (
tf
->
cs
 & 3Ë=
DPL_USER
)

112 
	`exô
();

113 
	}
}

	@trapasm.S

1 
	~"mmu.h
"

3 #ve˘‹s.
S
 
£nds
 
Æl
 
å≠s
 
hîe
.

4 .
globl
 
Æ…øps


5 
	gÆ…øps
:

6 #Buûd 
å≠
 
‰ame
.

7 
pushl
 %
ds


8 
pushl
 %
es


9 
pushl
 %
fs


10 
pushl
 %
gs


11 
pushÆ


13 #Së 
up
 
d©a
 
£gmíts
.

14 
movw
 
$
(
SEG_KDATA
<<3), %
ax


15 
	gmovw
 %
	gax
, %
ds


16 
	gmovw
 %
	gax
, %
	ges


18 #CÆ»
å≠
(
tf
), 
whîe
Åf=%
e•


19 
	gpushl
 %
e•


20 
ˇŒ
 
å≠


21 
addl
 
	g$4
, %
	ge•


23 #Rëu∫ 
ÁŒs
 
through
 
to
 
å≠ªt
...

24 .
globl
 
å≠ªt


25 
	gå≠ªt
:

26 
p›Æ


27 
p›l
 %
gs


28 
p›l
 %
fs


29 
p›l
 %
es


30 
p›l
 %
ds


31 
addl
 
$0x8
, %
	ge•
 #å≠nÿ
™d
 
îrcode


32 
	gúë


	@traps.h

4 
	#T_DIVIDE
 0

5 
	#T_DEBUG
 1

6 
	#T_NMI
 2

7 
	#T_BRKPT
 3

8 
	#T_OFLOW
 4

9 
	#T_BOUND
 5

10 
	#T_ILLOP
 6

11 
	#T_DEVICE
 7

12 
	#T_DBLFLT
 8

14 
	#T_TSS
 10

15 
	#T_SEGNP
 11

16 
	#T_STACK
 12

17 
	#T_GPFLT
 13

18 
	#T_PGFLT
 14

20 
	#T_FPERR
 16

21 
	#T_ALIGN
 17

22 
	#T_MCHK
 18

23 
	#T_SIMDERR
 19

24 

	)

27 
	#T_SYSCALL
 64

28 
	#T_DEFAULT
 500

29 

	)

30 
	#T_IRQ0
 32

31 

	)

32 
	#IRQ_TIMER
 0

	)

33 
	#IRQ_KBD
 1

	)

34 
	#IRQ_COM1
 4

	)

35 
	#IRQ_IDE
 14

	)

36 
	#IRQ_ERROR
 19

	)

37 
	#IRQ_SPURIOUS
 31

	)

	@types.h

1 
	tuöt
;

2 
	tush‹t
;

3 
	tuch¨
;

4 
uöt
 
	tpde_t
;

	@uart.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"å≠s.h
"

7 
	~"•ölock.h
"

8 
	~"¶ì∂ock.h
"

9 
	~"fs.h
"

10 
	~"fûe.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

13 
	~"x86.h
"

15 
	#COM1
 0x3f8

	)

17 
	gu¨t
;

19 
	$u¨töô
()

21 *
p
;

24 
	`outb
(
COM1
 + 2, 0);

27 
	`outb
(
COM1
 + 3, 0x80);

28 
	`outb
(
COM1
 + 0, 115200 / 9600);

29 
	`outb
(
COM1
 + 1, 0);

30 
	`outb
(
COM1
 + 3, 0x03);

31 
	`outb
(
COM1
 + 4, 0);

32 
	`outb
(
COM1
 + 1, 0x01);

35 i‡(
	`öb
(
COM1
 + 5) == 0xFF)

37 
u¨t
 = 1;

41 
	`öb
(
COM1
 + 2);

42 
	`öb
(
COM1
 + 0);

43 
	`iﬂpi˚«bÀ
(
IRQ_COM1
, 0);

46 
p
 = "xv6...\n"; *p;Ö++)

47 
	`u¨çutc
(*
p
);

48 
	}
}

50 
	$u¨çutc
(
c
)

52 
i
;

54 i‡(!
u¨t
)

56 
i
 = 0; i < 128 && !(
	`öb
(
COM1
 + 5) & 0x20); i++)

57 
	`mi¸odñay
(10);

58 
	`outb
(
COM1
 + 0, 
c
);

59 
	}
}

62 
	$u¨tgëc
()

64 i‡(!
u¨t
)

66 i‡(!(
	`öb
(
COM1
 + 5) & 0x01))

68  
	`öb
(
COM1
 + 0);

69 
	}
}

71 
	$u¨töå
()

73 
	`c⁄sﬁeöå
(
u¨tgëc
);

74 
	}
}

	@ulib.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"f˙é.h
"

4 
	~"u£r.h
"

5 
	~"x86.h
"

8 
	$°r˝y
(*
s
, c⁄° *
t
)

10 *
os
;

12 
os
 = 
s
;

13 (*
s
++ = *
t
++) != 0)

15  
os
;

16 
	}
}

18 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

20 *
p
 && *∞=*
q
)

21 
p
++, 
q
++;

22  (
uch¨
)*
p
 - (uch¨)*
q
;

23 
	}
}

25 
uöt
 
	$°æí
(c⁄° *
s
)

27 
n
;

29 
n
 = 0; 
s
[n];Ç++)

31  
n
;

32 
	}
}

35 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

37 
	`°osb
(
d°
, 
c
, 
n
);

38  
d°
;

39 
	}
}

42 
	$°rchr
(c⁄° *
s
, 
c
)

44 ; *
s
; s++)

45 i‡(*
s
 =
c
)

46  (*)
s
;

48 
	}
}

51 
	$gës
(*
buf
, 
max
)

53 
i
, 
cc
;

54 
c
;

56 
i
 = 0; i + 1 < 
max
;)

58 
cc
 = 
	`ªad
(0, &
c
, 1);

59 i‡(
cc
 < 1)

61 
buf
[
i
++] = 
c
;

62 i‡(
c
 == '\n' || c == '\r')

65 
buf
[
i
] = '\0';

66  
buf
;

67 
	}
}

69 
	$°©
(c⁄° *
n
, 
°©
 *
°
)

71 
fd
;

72 
r
;

74 
fd
 = 
	`›í
(
n
, 
O_RDONLY
);

75 i‡(
fd
 < 0)

77 
r
 = 
	`f°©
(
fd
, 
°
);

78 
	`˛o£
(
fd
);

79  
r
;

80 
	}
}

82 
	$©oi
(c⁄° *
s
)

84 
n
;

86 
n
 = 0;

87 '0' <*
s
 && *s <= '9')

88 
n
 =Ç * 10 + *
s
++ - '0';

89  
n
;

90 
	}
}

93 
	$memmove
(*
vd°
, c⁄° *
v§c
, 
n
)

95 *
d°
;

96 c⁄° *
§c
;

98 
d°
 = 
vd°
;

99 
§c
 = 
v§c
;

100 
n
-- > 0)

101 *
d°
++ = *
§c
++;

102  
vd°
;

103 
	}
}

	@umalloc.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

4 
	~"∑øm.h
"

9 
	tAlign
;

11 
	uhódî


15 
hódî
 *
	m±r
;

16 
uöt
 
	msize
;

17 } 
	ms
;

18 
Align
 
	mx
;

21 
hódî
 
	tHódî
;

23 
Hódî
 
	gba£
;

24 
Hódî
 *
	g‰ìp
;

26 
	$‰ì
(*
≠
)

28 
Hódî
 *
bp
, *
p
;

30 
bp
 = (
Hódî
 *)
≠
 - 1;

31 
p
 = 
‰ìp
; !(
bp
 >Ö && b∞<Ö->
s
.
±r
);Ö =Ö->s.ptr)

32 i‡(
p
 >p->
s
.
±r
 && (
bp
 >Ö || bp <Ö->s.ptr))

34 i‡(
bp
 + bp->
s
.
size
 =
p
->s.
±r
)

36 
bp
->
s
.
size
 +
p
->s.
±r
->s.size;

37 
bp
->
s
.
±r
 = 
p
->s.ptr->s.ptr;

40 
bp
->
s
.
±r
 = 
p
->s.ptr;

41 i‡(
p
 +Ö->
s
.
size
 =
bp
)

43 
p
->
s
.
size
 +
bp
->s.size;

44 
p
->
s
.
±r
 = 
bp
->s.ptr;

47 
p
->
s
.
±r
 = 
bp
;

48 
‰ìp
 = 
p
;

49 
	}
}

51 
Hódî
 *

52 
	$m‹ec‹e
(
uöt
 
nu
)

54 *
p
;

55 
Hódî
 *
hp
;

57 i‡(
nu
 < 4096)

58 
nu
 = 4096;

59 
p
 = 
	`sbrk
(
nu
 * (
Hódî
));

60 i‡(
p
 == (*)-1)

62 
hp
 = (
Hódî
 *)
p
;

63 
hp
->
s
.
size
 = 
nu
;

64 
	`‰ì
((*)(
hp
 + 1));

65  
‰ìp
;

66 
	}
}

69 
	$mÆloc
(
uöt
 
nbyãs
)

71 
Hódî
 *
p
, *
¥evp
;

72 
uöt
 
nunôs
;

74 
nunôs
 = (
nbyãs
 + (
Hódî
) - 1) / (Header) + 1;

75 i‡((
¥evp
 = 
‰ìp
) == 0)

77 
ba£
.
s
.
±r
 = 
‰ìp
 = 
¥evp
 = &base;

78 
ba£
.
s
.
size
 = 0;

80 
p
 = 
¥evp
->
s
.
±r
;;Örevp =Ö,Ö =Ö->s.ptr)

82 i‡(
p
->
s
.
size
 >
nunôs
)

84 i‡(
p
->
s
.
size
 =
nunôs
)

85 
¥evp
->
s
.
±r
 = 
p
->s.ptr;

88 
p
->
s
.
size
 -
nunôs
;

89 
p
 +p->
s
.
size
;

90 
p
->
s
.
size
 = 
nunôs
;

92 
‰ìp
 = 
¥evp
;

93  (*)(
p
 + 1);

95 i‡(
p
 =
‰ìp
)

96 i‡((
p
 = 
	`m‹ec‹e
(
nunôs
)) == 0)

99 
	}
}

	@user.h

1 
	g°©
;

2 
	gπcd©e
;

5 
f‹k
();

6 
	$exô
(Ë
	`__©åibuã__
((
n‹ëu∫
));

7 
	`waô
();

8 
	`pùe
(*);

9 
	`wrôe
(, const *, );

10 
	`ªad
(, *, );

11 
	`˛o£
();

12 
	`kûl
();

13 
	`exec
(*, **);

14 
	`›í
(const *, );

15 
	`mknod
(const *, , );

16 
	`u∆ök
(const *);

17 
	`f°©
(
fd
, 
°©
 *);

18 
	`lök
(const *, const *);

19 
	`mkdú
(const *);

20 
	`chdú
(const *);

21 
	`dup
();

22 
	`gëpid
();

23 *
	`sbrk
();

24 
	`¶ìp
();

25 
	`u±ime
();

28 
	`°©
(c⁄° *, 
°©
 *);

29 *
	`°r˝y
(*, const *);

30 *
	`memmove
(*, const *, );

31 *
	`°rchr
(c⁄° *, 
c
);

32 
	`°rcmp
(const *, const *);

33 
	`¥ötf
(, const *, ...);

34 *
	`gës
(*, 
max
);

35 
uöt
 
	`°æí
(const *);

36 *
	`mem£t
(*, , 
uöt
);

37 *
	`mÆloc
(
uöt
);

38 
	`‰ì
(*);

39 
	`©oi
(const *);

	@usertests.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"°©.h
"

4 
	~"u£r.h
"

5 
	~"fs.h
"

6 
	~"f˙é.h
"

7 
	~"sysˇŒ.h
"

8 
	~"å≠s.h
"

9 
	~"memœyout.h
"

11 
	gbuf
[8192];

12 
	g«me
[3];

13 *
	gechﬂrgv
[] = {"echo", "ALL", "TESTS", "PASSED", 0};

14 
	g°dout
 = 1;

17 
	$ùuâe°
()

19 
	`¥ötf
(
°dout
, "iputÅest\n");

21 i‡(
	`mkdú
("iputdir") < 0)

23 
	`¥ötf
(
°dout
, "mkdir failed\n");

24 
	`exô
();

26 i‡(
	`chdú
("iputdir") < 0)

28 
	`¥ötf
(
°dout
, "chdir iputdir failed\n");

29 
	`exô
();

31 i‡(
	`u∆ök
("../iputdir") < 0)

33 
	`¥ötf
(
°dout
, "unlink ../iputdir failed\n");

34 
	`exô
();

36 i‡(
	`chdú
("/") < 0)

38 
	`¥ötf
(
°dout
, "chdir / failed\n");

39 
	`exô
();

41 
	`¥ötf
(
°dout
, "iputÅest ok\n");

42 
	}
}

45 
	$exôùuâe°
()

47 
pid
;

49 
	`¥ötf
(
°dout
, "exitiputÅest\n");

51 
pid
 = 
	`f‹k
();

52 i‡(
pid
 < 0)

54 
	`¥ötf
(
°dout
, "fork failed\n");

55 
	`exô
();

57 i‡(
pid
 == 0)

59 i‡(
	`mkdú
("iputdir") < 0)

61 
	`¥ötf
(
°dout
, "mkdir failed\n");

62 
	`exô
();

64 i‡(
	`chdú
("iputdir") < 0)

66 
	`¥ötf
(
°dout
, "child chdir failed\n");

67 
	`exô
();

69 i‡(
	`u∆ök
("../iputdir") < 0)

71 
	`¥ötf
(
°dout
, "unlink ../iputdir failed\n");

72 
	`exô
();

74 
	`exô
();

76 
	`waô
();

77 
	`¥ötf
(
°dout
, "exitiputÅest ok\n");

78 
	}
}

91 
	$›íùuâe°
()

93 
pid
;

95 
	`¥ötf
(
°dout
, "openiputÅest\n");

96 i‡(
	`mkdú
("oidir") < 0)

98 
	`¥ötf
(
°dout
, "mkdir oidir failed\n");

99 
	`exô
();

101 
pid
 = 
	`f‹k
();

102 i‡(
pid
 < 0)

104 
	`¥ötf
(
°dout
, "fork failed\n");

105 
	`exô
();

107 i‡(
pid
 == 0)

109 
fd
 = 
	`›í
("oidú", 
O_RDWR
);

110 i‡(
fd
 >= 0)

112 
	`¥ötf
(
°dout
, "open directory for write succeeded\n");

113 
	`exô
();

115 
	`exô
();

117 
	`¶ìp
(1);

118 i‡(
	`u∆ök
("oidir") != 0)

120 
	`¥ötf
(
°dout
, "unlink failed\n");

121 
	`exô
();

123 
	`waô
();

124 
	`¥ötf
(
°dout
, "openiputÅest ok\n");

125 
	}
}

129 
	$›íã°
()

131 
fd
;

133 
	`¥ötf
(
°dout
, "openÅest\n");

134 
fd
 = 
	`›í
("echo", 0);

135 i‡(
fd
 < 0)

137 
	`¥ötf
(
°dout
, "openÉcho failed!\n");

138 
	`exô
();

140 
	`˛o£
(
fd
);

141 
fd
 = 
	`›í
("doesnotexist", 0);

142 i‡(
fd
 >= 0)

144 
	`¥ötf
(
°dout
, "open doesnotexist succeeded!\n");

145 
	`exô
();

147 
	`¥ötf
(
°dout
, "openÅest ok\n");

148 
	}
}

150 
	$wrôëe°
()

152 
fd
;

153 
i
;

155 
	`¥ötf
(
°dout
, "small fileÅest\n");

156 
fd
 = 
	`›í
("smÆl", 
O_CREATE
 | 
O_RDWR
);

157 i‡(
fd
 >= 0)

159 
	`¥ötf
(
°dout
, "creat small succeeded; ok\n");

163 
	`¥ötf
(
°dout
, "error: creat small failed!\n");

164 
	`exô
();

166 
i
 = 0; i < 100; i++)

168 i‡(
	`wrôe
(
fd
, "aaaaaaaaaa", 10) != 10)

170 
	`¥ötf
(
°dout
, "îr‹: wrôêØ %dÇew fûêÁûed\n", 
i
);

171 
	`exô
();

173 i‡(
	`wrôe
(
fd
, "bbbbbbbbbb", 10) != 10)

175 
	`¥ötf
(
°dout
, "îr‹: wrôêbb %dÇew fûêÁûed\n", 
i
);

176 
	`exô
();

179 
	`¥ötf
(
°dout
, "writes ok\n");

180 
	`˛o£
(
fd
);

181 
fd
 = 
	`›í
("smÆl", 
O_RDONLY
);

182 i‡(
fd
 >= 0)

184 
	`¥ötf
(
°dout
, "open small succeeded ok\n");

188 
	`¥ötf
(
°dout
, "error: open small failed!\n");

189 
	`exô
();

191 
i
 = 
	`ªad
(
fd
, 
buf
, 2000);

192 i‡(
i
 == 2000)

194 
	`¥ötf
(
°dout
, "read succeeded ok\n");

198 
	`¥ötf
(
°dout
, "read failed\n");

199 
	`exô
();

201 
	`˛o£
(
fd
);

203 i‡(
	`u∆ök
("small") < 0)

205 
	`¥ötf
(
°dout
, "unlink small failed\n");

206 
	`exô
();

208 
	`¥ötf
(
°dout
, "small fileÅest ok\n");

209 
	}
}

211 
	$wrôëe°1
()

213 
i
, 
fd
, 
n
;

215 
	`¥ötf
(
°dout
, "big filesÅest\n");

217 
fd
 = 
	`›í
("big", 
O_CREATE
 | 
O_RDWR
);

218 i‡(
fd
 < 0)

220 
	`¥ötf
(
°dout
, "error: creat big failed!\n");

221 
	`exô
();

224 
i
 = 0; i < 
MAXFILE
; i++)

226 ((*)
buf
)[0] = 
i
;

227 i‡(
	`wrôe
(
fd
, 
buf
, 512) != 512)

229 
	`¥ötf
(
°dout
, "îr‹: wrôêbig fûêÁûed\n", 
i
);

230 
	`exô
();

234 
	`˛o£
(
fd
);

236 
fd
 = 
	`›í
("big", 
O_RDONLY
);

237 i‡(
fd
 < 0)

239 
	`¥ötf
(
°dout
, "error: open big failed!\n");

240 
	`exô
();

243 
n
 = 0;

246 
i
 = 
	`ªad
(
fd
, 
buf
, 512);

247 i‡(
i
 == 0)

249 i‡(
n
 =
MAXFILE
 - 1)

251 
	`¥ötf
(
°dout
, "ªad o∆y %d block†‰om big", 
n
);

252 
	`exô
();

256 i‡(
i
 != 512)

258 
	`¥ötf
(
°dout
, "ªad faûed %d\n", 
i
);

259 
	`exô
();

261 i‡(((*)
buf
)[0] !
n
)

263 
	`¥ötf
(
°dout
, "read content of block %d is %d\n",

264 
n
, ((*)
buf
)[0]);

265 
	`exô
();

267 
n
++;

269 
	`˛o£
(
fd
);

270 i‡(
	`u∆ök
("big") < 0)

272 
	`¥ötf
(
°dout
, "unlink big failed\n");

273 
	`exô
();

275 
	`¥ötf
(
°dout
, "big files ok\n");

276 
	}
}

278 
	$¸óãã°
()

280 
i
, 
fd
;

282 
	`¥ötf
(
°dout
, "many creates, followed by unlinkÅest\n");

284 
«me
[0] = 'a';

285 
«me
[2] = '\0';

286 
i
 = 0; i < 52; i++)

288 
«me
[1] = '0' + 
i
;

289 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

290 
	`˛o£
(
fd
);

292 
«me
[0] = 'a';

293 
«me
[2] = '\0';

294 
i
 = 0; i < 52; i++)

296 
«me
[1] = '0' + 
i
;

297 
	`u∆ök
(
«me
);

299 
	`¥ötf
(
°dout
, "many creates, followed by unlink; ok\n");

300 
	}
}

302 
	$dúã°
()

304 
	`¥ötf
(
°dout
, "mkdirÅest\n");

306 i‡(
	`mkdú
("dir0") < 0)

308 
	`¥ötf
(
°dout
, "mkdir failed\n");

309 
	`exô
();

312 i‡(
	`chdú
("dir0") < 0)

314 
	`¥ötf
(
°dout
, "chdir dir0 failed\n");

315 
	`exô
();

318 i‡(
	`chdú
("..") < 0)

320 
	`¥ötf
(
°dout
, "chdir .. failed\n");

321 
	`exô
();

324 i‡(
	`u∆ök
("dir0") < 0)

326 
	`¥ötf
(
°dout
, "unlink dir0 failed\n");

327 
	`exô
();

329 
	`¥ötf
(
°dout
, "mkdirÅest ok\n");

330 
	}
}

332 
	$exe˘e°
()

334 
	`¥ötf
(
°dout
, "execÅest\n");

335 i‡(
	`exec
("echo", 
echﬂrgv
) < 0)

337 
	`¥ötf
(
°dout
, "execÉcho failed\n");

338 
	`exô
();

340 
	}
}

344 
	$pùe1
()

346 
fds
[2], 
pid
;

347 
£q
, 
i
, 
n
, 
cc
, 
tŸÆ
;

349 i‡(
	`pùe
(
fds
) != 0)

351 
	`¥ötf
(1, "pipe() failed\n");

352 
	`exô
();

354 
pid
 = 
	`f‹k
();

355 
£q
 = 0;

356 i‡(
pid
 == 0)

358 
	`˛o£
(
fds
[0]);

359 
n
 = 0;Ç < 5;Ç++)

361 
i
 = 0; i < 1033; i++)

362 
buf
[
i
] = 
£q
++;

363 i‡(
	`wrôe
(
fds
[1], 
buf
, 1033) != 1033)

365 
	`¥ötf
(1, "pipe1 oops 1\n");

366 
	`exô
();

369 
	`exô
();

371 i‡(
pid
 > 0)

373 
	`˛o£
(
fds
[1]);

374 
tŸÆ
 = 0;

375 
cc
 = 1;

376 (
n
 = 
	`ªad
(
fds
[0], 
buf
, 
cc
)) > 0)

378 
i
 = 0; i < 
n
; i++)

380 i‡((
buf
[
i
] & 0xffË!(
£q
++ & 0xff))

382 
	`¥ötf
(1, "pipe1 oops 2\n");

386 
tŸÆ
 +
n
;

387 
cc
 = cc * 2;

388 i‡(
cc
 > (
buf
))

389 
cc
 = (
buf
);

391 i‡(
tŸÆ
 != 5 * 1033)

393 
	`¥ötf
(1, "pùe1 o›†3ÅŸÆ %d\n", 
tŸÆ
);

394 
	`exô
();

396 
	`˛o£
(
fds
[0]);

397 
	`waô
();

401 
	`¥ötf
(1, "fork() failed\n");

402 
	`exô
();

404 
	`¥ötf
(1, "pipe1 ok\n");

405 
	}
}

408 
	$¥ìm±
()

410 
pid1
, 
pid2
, 
pid3
;

411 
pfds
[2];

413 
	`¥ötf
(1, "preempt: ");

414 
pid1
 = 
	`f‹k
();

415 i‡(
pid1
 == 0)

419 
pid2
 = 
	`f‹k
();

420 i‡(
pid2
 == 0)

424 
	`pùe
(
pfds
);

425 
pid3
 = 
	`f‹k
();

426 i‡(
pid3
 == 0)

428 
	`˛o£
(
pfds
[0]);

429 i‡(
	`wrôe
(
pfds
[1], "x", 1) != 1)

430 
	`¥ötf
(1, "preempt writeÉrror");

431 
	`˛o£
(
pfds
[1]);

436 
	`˛o£
(
pfds
[1]);

437 i‡(
	`ªad
(
pfds
[0], 
buf
, (buf)) != 1)

439 
	`¥ötf
(1, "preemptÑeadÉrror");

442 
	`˛o£
(
pfds
[0]);

443 
	`¥ötf
(1, "kill... ");

444 
	`kûl
(
pid1
);

445 
	`kûl
(
pid2
);

446 
	`kûl
(
pid3
);

447 
	`¥ötf
(1, "wait... ");

448 
	`waô
();

449 
	`waô
();

450 
	`waô
();

451 
	`¥ötf
(1, "preempt ok\n");

452 
	}
}

455 
	$exôwaô
()

457 
i
, 
pid
;

459 
i
 = 0; i < 100; i++)

461 
pid
 = 
	`f‹k
();

462 i‡(
pid
 < 0)

464 
	`¥ötf
(1, "fork failed\n");

467 i‡(
pid
)

469 i‡(
	`waô
(Ë!
pid
)

471 
	`¥ötf
(1, "wait wrongÖid\n");

477 
	`exô
();

480 
	`¥ötf
(1, "exitwait ok\n");

481 
	}
}

483 
	$mem
()

485 *
m1
, *
m2
;

486 
pid
, 
µid
;

488 
	`¥ötf
(1, "memÅest\n");

489 
µid
 = 
	`gëpid
();

490 i‡((
pid
 = 
	`f‹k
()) == 0)

492 
m1
 = 0;

493 (
m2
 = 
	`mÆloc
(10001)) != 0)

495 *(**)
m2
 = 
m1
;

496 
m1
 = 
m2
;

498 
m1
)

500 
m2
 = *(**)
m1
;

501 
	`‰ì
(
m1
);

502 
m1
 = 
m2
;

504 
m1
 = 
	`mÆloc
(1024 * 20);

505 i‡(
m1
 == 0)

507 
	`¥ötf
(1, "couldn'tállocate mem?!!\n");

508 
	`kûl
(
µid
);

509 
	`exô
();

511 
	`‰ì
(
m1
);

512 
	`¥ötf
(1, "mem ok\n");

513 
	`exô
();

517 
	`waô
();

519 
	}
}

525 
	$sh¨edfd
()

527 
fd
, 
pid
, 
i
, 
n
, 
nc
, 
≈
;

528 
buf
[10];

530 
	`¥ötf
(1, "sharedfdÅest\n");

532 
	`u∆ök
("sharedfd");

533 
fd
 = 
	`›í
("sh¨edfd", 
O_CREATE
 | 
O_RDWR
);

534 i‡(
fd
 < 0)

536 
	`¥ötf
(1, "fstests: cannot open sharedfd for writing");

539 
pid
 = 
	`f‹k
();

540 
	`mem£t
(
buf
, 
pid
 == 0 ? 'c' : 'p', (buf));

541 
i
 = 0; i < 1000; i++)

543 i‡(
	`wrôe
(
fd
, 
buf
, (buf)) != (buf))

545 
	`¥ötf
(1, "fstests: write sharedfd failed\n");

549 i‡(
pid
 == 0)

550 
	`exô
();

552 
	`waô
();

553 
	`˛o£
(
fd
);

554 
fd
 = 
	`›í
("sharedfd", 0);

555 i‡(
fd
 < 0)

557 
	`¥ötf
(1, "fstests: cannot open sharedfd forÑeading\n");

560 
nc
 = 
≈
 = 0;

561 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

563 
i
 = 0; i < (
buf
); i++)

565 i‡(
buf
[
i
] == 'c')

566 
nc
++;

567 i‡(
buf
[
i
] == 'p')

568 
≈
++;

571 
	`˛o£
(
fd
);

572 
	`u∆ök
("sharedfd");

573 i‡(
nc
 =10000 && 
≈
 == 10000)

575 
	`¥ötf
(1, "sharedfd ok\n");

579 
	`¥ötf
(1, "sh¨edfd o›†%d %d\n", 
nc
, 
≈
);

580 
	`exô
();

582 
	}
}

586 
	$fourfûes
()

588 
fd
, 
pid
, 
i
, 
j
, 
n
, 
tŸÆ
, 
pi
;

589 *
«mes
[] = {"f0", "f1", "f2", "f3"};

590 *
‚ame
;

592 
	`¥ötf
(1, "fourfilesÅest\n");

594 
pi
 = 0;Öi < 4;Öi++)

596 
‚ame
 = 
«mes
[
pi
];

597 
	`u∆ök
(
‚ame
);

599 
pid
 = 
	`f‹k
();

600 i‡(
pid
 < 0)

602 
	`¥ötf
(1, "fork failed\n");

603 
	`exô
();

606 i‡(
pid
 == 0)

608 
fd
 = 
	`›í
(
‚ame
, 
O_CREATE
 | 
O_RDWR
);

609 i‡(
fd
 < 0)

611 
	`¥ötf
(1, "create failed\n");

612 
	`exô
();

615 
	`mem£t
(
buf
, '0' + 
pi
, 512);

616 
i
 = 0; i < 12; i++)

618 i‡((
n
 = 
	`wrôe
(
fd
, 
buf
, 500)) != 500)

620 
	`¥ötf
(1, "wrôêÁûed %d\n", 
n
);

621 
	`exô
();

624 
	`exô
();

628 
pi
 = 0;Öi < 4;Öi++)

630 
	`waô
();

633 
i
 = 0; i < 2; i++)

635 
‚ame
 = 
«mes
[
i
];

636 
fd
 = 
	`›í
(
‚ame
, 0);

637 
tŸÆ
 = 0;

638 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

640 
j
 = 0; j < 
n
; j++)

642 i‡(
buf
[
j
] !'0' + 
i
)

644 
	`¥ötf
(1, "wrong char\n");

645 
	`exô
();

648 
tŸÆ
 +
n
;

650 
	`˛o£
(
fd
);

651 i‡(
tŸÆ
 != 12 * 500)

653 
	`¥ötf
(1, "wr⁄gÜígth %d\n", 
tŸÆ
);

654 
	`exô
();

656 
	`u∆ök
(
‚ame
);

659 
	`¥ötf
(1, "fourfiles ok\n");

660 
	}
}

663 
	$¸óãdñëe
()

667 
N
 = 20

669 
pid
, 
i
, 
fd
, 
pi
;

670 
«me
[32];

672 
	`¥ötf
(1, "createdeleteÅest\n");

674 
pi
 = 0;Öi < 4;Öi++)

676 
pid
 = 
	`f‹k
();

677 i‡(
pid
 < 0)

679 
	`¥ötf
(1, "fork failed\n");

680 
	`exô
();

683 i‡(
pid
 == 0)

685 
«me
[0] = 'p' + 
pi
;

686 
«me
[2] = '\0';

687 
i
 = 0; i < 
N
; i++)

689 
«me
[1] = '0' + 
i
;

690 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

691 i‡(
fd
 < 0)

693 
	`¥ötf
(1, "create failed\n");

694 
	`exô
();

696 
	`˛o£
(
fd
);

697 i‡(
i
 > 0 && (i % 2) == 0)

699 
«me
[1] = '0' + (
i
 / 2);

700 i‡(
	`u∆ök
(
«me
) < 0)

702 
	`¥ötf
(1, "unlink failed\n");

703 
	`exô
();

707 
	`exô
();

711 
pi
 = 0;Öi < 4;Öi++)

713 
	`waô
();

716 
«me
[0] =Çame[1] =Çame[2] = 0;

717 
i
 = 0; i < 
N
; i++)

719 
pi
 = 0;Öi < 4;Öi++)

721 
«me
[0] = 'p' + 
pi
;

722 
«me
[1] = '0' + 
i
;

723 
fd
 = 
	`›í
(
«me
, 0);

724 i‡((
i
 =0 || i >
N
 / 2Ë&& 
fd
 < 0)

726 
	`¥ötf
(1, "o›†¸óãdñëê%†didn'àexi°\n", 
«me
);

727 
	`exô
();

729 i‡((
i
 >1 && i < 
N
 / 2Ë&& 
fd
 >= 0)

731 
	`¥ötf
(1, "o›†¸óãdñëê%†didÉxi°\n", 
«me
);

732 
	`exô
();

734 i‡(
fd
 >= 0)

735 
	`˛o£
(
fd
);

739 
i
 = 0; i < 
N
; i++)

741 
pi
 = 0;Öi < 4;Öi++)

743 
«me
[0] = 'p' + 
i
;

744 
«me
[1] = '0' + 
i
;

745 
	`u∆ök
(
«me
);

749 
	`¥ötf
(1, "createdelete ok\n");

750 
	}
}

753 
	$u∆ökªad
()

755 
fd
, 
fd1
;

757 
	`¥ötf
(1, "unlinkreadÅest\n");

758 
fd
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

759 i‡(
fd
 < 0)

761 
	`¥ötf
(1, "create unlinkread failed\n");

762 
	`exô
();

764 
	`wrôe
(
fd
, "hello", 5);

765 
	`˛o£
(
fd
);

767 
fd
 = 
	`›í
("u∆ökªad", 
O_RDWR
);

768 i‡(
fd
 < 0)

770 
	`¥ötf
(1, "open unlinkread failed\n");

771 
	`exô
();

773 i‡(
	`u∆ök
("unlinkread") != 0)

775 
	`¥ötf
(1, "unlink unlinkread failed\n");

776 
	`exô
();

779 
fd1
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

780 
	`wrôe
(
fd1
, "yyy", 3);

781 
	`˛o£
(
fd1
);

783 i‡(
	`ªad
(
fd
, 
buf
, (buf)) != 5)

785 
	`¥ötf
(1, "unlinkreadÑead failed");

786 
	`exô
();

788 i‡(
buf
[0] != 'h')

790 
	`¥ötf
(1, "unlinkread wrong data\n");

791 
	`exô
();

793 i‡(
	`wrôe
(
fd
, 
buf
, 10) != 10)

795 
	`¥ötf
(1, "unlinkread write failed\n");

796 
	`exô
();

798 
	`˛o£
(
fd
);

799 
	`u∆ök
("unlinkread");

800 
	`¥ötf
(1, "unlinkread ok\n");

801 
	}
}

803 
	$lökã°
()

805 
fd
;

807 
	`¥ötf
(1, "linktest\n");

809 
	`u∆ök
("lf1");

810 
	`u∆ök
("lf2");

812 
fd
 = 
	`›í
("lf1", 
O_CREATE
 | 
O_RDWR
);

813 i‡(
fd
 < 0)

815 
	`¥ötf
(1, "createÜf1 failed\n");

816 
	`exô
();

818 i‡(
	`wrôe
(
fd
, "hello", 5) != 5)

820 
	`¥ötf
(1, "writeÜf1 failed\n");

821 
	`exô
();

823 
	`˛o£
(
fd
);

825 i‡(
	`lök
("lf1", "lf2") < 0)

827 
	`¥ötf
(1, "linkÜf1Üf2 failed\n");

828 
	`exô
();

830 
	`u∆ök
("lf1");

832 i‡(
	`›í
("lf1", 0) >= 0)

834 
	`¥ötf
(1, "unlinkedÜf1 but it is stillÅhere!\n");

835 
	`exô
();

838 
fd
 = 
	`›í
("lf2", 0);

839 i‡(
fd
 < 0)

841 
	`¥ötf
(1, "openÜf2 failed\n");

842 
	`exô
();

844 i‡(
	`ªad
(
fd
, 
buf
, (buf)) != 5)

846 
	`¥ötf
(1, "readÜf2 failed\n");

847 
	`exô
();

849 
	`˛o£
(
fd
);

851 i‡(
	`lök
("lf2", "lf2") >= 0)

853 
	`¥ötf
(1, "linkÜf2Üf2 succeeded! oops\n");

854 
	`exô
();

857 
	`u∆ök
("lf2");

858 i‡(
	`lök
("lf2", "lf1") >= 0)

860 
	`¥ötf
(1, "linkÇon-existant succeeded! oops\n");

861 
	`exô
();

864 i‡(
	`lök
(".", "lf1") >= 0)

866 
	`¥ötf
(1, "link .Üf1 succeeded! oops\n");

867 
	`exô
();

870 
	`¥ötf
(1, "linktest ok\n");

871 
	}
}

874 
	$c⁄¸óã
()

876 
fûe
[3];

877 
i
, 
pid
, 
n
, 
fd
;

878 
Á
[40];

881 
ush‹t
 
öum
;

882 
«me
[14];

883 } 
de
;

885 
	`¥ötf
(1, "concreateÅest\n");

886 
fûe
[0] = 'C';

887 
fûe
[2] = '\0';

888 
i
 = 0; i < 40; i++)

890 
fûe
[1] = '0' + 
i
;

891 
	`u∆ök
(
fûe
);

892 
pid
 = 
	`f‹k
();

893 i‡(
pid
 && (
i
 % 3) == 1)

895 
	`lök
("C0", 
fûe
);

897 i‡(
pid
 =0 && (
i
 % 5) == 1)

899 
	`lök
("C0", 
fûe
);

903 
fd
 = 
	`›í
(
fûe
, 
O_CREATE
 | 
O_RDWR
);

904 i‡(
fd
 < 0)

906 
	`¥ötf
(1, "c⁄¸óã cª©ê%†Áûed\n", 
fûe
);

907 
	`exô
();

909 
	`˛o£
(
fd
);

911 i‡(
pid
 == 0)

912 
	`exô
();

914 
	`waô
();

917 
	`mem£t
(
Á
, 0, (fa));

918 
fd
 = 
	`›í
(".", 0);

919 
n
 = 0;

920 
	`ªad
(
fd
, &
de
, (de)) > 0)

922 i‡(
de
.
öum
 == 0)

924 i‡(
de
.
«me
[0] == 'C' && de.name[2] == '\0')

926 
i
 = 
de
.
«me
[1] - '0';

927 i‡(
i
 < 0 || i >(
Á
))

929 
	`¥ötf
(1, "c⁄¸óã weúd fûê%s\n", 
de
.
«me
);

930 
	`exô
();

932 i‡(
Á
[
i
])

934 
	`¥ötf
(1, "c⁄¸óã du∂iˇã fûê%s\n", 
de
.
«me
);

935 
	`exô
();

937 
Á
[
i
] = 1;

938 
n
++;

941 
	`˛o£
(
fd
);

943 i‡(
n
 != 40)

945 
	`¥ötf
(1, "concreateÇotÉnough files in directoryÜisting\n");

946 
	`exô
();

949 
i
 = 0; i < 40; i++)

951 
fûe
[1] = '0' + 
i
;

952 
pid
 = 
	`f‹k
();

953 i‡(
pid
 < 0)

955 
	`¥ötf
(1, "fork failed\n");

956 
	`exô
();

958 i‡(((
i
 % 3Ë=0 && 
pid
 == 0) ||

959 ((
i
 % 3Ë=1 && 
pid
 != 0))

961 
	`˛o£
(
	`›í
(
fûe
, 0));

962 
	`˛o£
(
	`›í
(
fûe
, 0));

963 
	`˛o£
(
	`›í
(
fûe
, 0));

964 
	`˛o£
(
	`›í
(
fûe
, 0));

968 
	`u∆ök
(
fûe
);

969 
	`u∆ök
(
fûe
);

970 
	`u∆ök
(
fûe
);

971 
	`u∆ök
(
fûe
);

973 i‡(
pid
 == 0)

974 
	`exô
();

976 
	`waô
();

979 
	`¥ötf
(1, "concreate ok\n");

980 
	}
}

984 
	$löku∆ök
()

986 
pid
, 
i
;

988 
	`¥ötf
(1, "linkunlinkÅest\n");

990 
	`u∆ök
("x");

991 
pid
 = 
	`f‹k
();

992 i‡(
pid
 < 0)

994 
	`¥ötf
(1, "fork failed\n");

995 
	`exô
();

998 
x
 = (
pid
 ? 1 : 97);

999 
i
 = 0; i < 100; i++)

1001 
x
 = x * 1103515245 + 12345;

1002 i‡((
x
 % 3) == 0)

1004 
	`˛o£
(
	`›í
("x", 
O_RDWR
 | 
O_CREATE
));

1006 i‡((
x
 % 3) == 1)

1008 
	`lök
("cat", "x");

1012 
	`u∆ök
("x");

1016 i‡(
pid
)

1017 
	`waô
();

1019 
	`exô
();

1021 
	`¥ötf
(1, "linkunlink ok\n");

1022 
	}
}

1025 
	$bigdú
()

1027 
i
, 
fd
;

1028 
«me
[10];

1030 
	`¥ötf
(1, "bigdirÅest\n");

1031 
	`u∆ök
("bd");

1033 
fd
 = 
	`›í
("bd", 
O_CREATE
);

1034 i‡(
fd
 < 0)

1036 
	`¥ötf
(1, "bigdir create failed\n");

1037 
	`exô
();

1039 
	`˛o£
(
fd
);

1041 
i
 = 0; i < 500; i++)

1043 
«me
[0] = 'x';

1044 
«me
[1] = '0' + (
i
 / 64);

1045 
«me
[2] = '0' + (
i
 % 64);

1046 
«me
[3] = '\0';

1047 i‡(
	`lök
("bd", 
«me
) != 0)

1049 
	`¥ötf
(1, "bigdirÜink failed\n");

1050 
	`exô
();

1054 
	`u∆ök
("bd");

1055 
i
 = 0; i < 500; i++)

1057 
«me
[0] = 'x';

1058 
«me
[1] = '0' + (
i
 / 64);

1059 
«me
[2] = '0' + (
i
 % 64);

1060 
«me
[3] = '\0';

1061 i‡(
	`u∆ök
(
«me
) != 0)

1063 
	`¥ötf
(1, "bigdir unlink failed");

1064 
	`exô
();

1068 
	`¥ötf
(1, "bigdir ok\n");

1069 
	}
}

1071 
	$subdú
()

1073 
fd
, 
cc
;

1075 
	`¥ötf
(1, "subdirÅest\n");

1077 
	`u∆ök
("ff");

1078 i‡(
	`mkdú
("dd") != 0)

1080 
	`¥ötf
(1, "subdir mkdir dd failed\n");

1081 
	`exô
();

1084 
fd
 = 
	`›í
("dd/ff", 
O_CREATE
 | 
O_RDWR
);

1085 i‡(
fd
 < 0)

1087 
	`¥ötf
(1, "create dd/ff failed\n");

1088 
	`exô
();

1090 
	`wrôe
(
fd
, "ff", 2);

1091 
	`˛o£
(
fd
);

1093 i‡(
	`u∆ök
("dd") >= 0)

1095 
	`¥ötf
(1, "unlink dd (non-empty dir) succeeded!\n");

1096 
	`exô
();

1099 i‡(
	`mkdú
("/dd/dd") != 0)

1101 
	`¥ötf
(1, "subdir mkdir dd/dd failed\n");

1102 
	`exô
();

1105 
fd
 = 
	`›í
("dd/dd/ff", 
O_CREATE
 | 
O_RDWR
);

1106 i‡(
fd
 < 0)

1108 
	`¥ötf
(1, "create dd/dd/ff failed\n");

1109 
	`exô
();

1111 
	`wrôe
(
fd
, "FF", 2);

1112 
	`˛o£
(
fd
);

1114 
fd
 = 
	`›í
("dd/dd/../ff", 0);

1115 i‡(
fd
 < 0)

1117 
	`¥ötf
(1, "open dd/dd/../ff failed\n");

1118 
	`exô
();

1120 
cc
 = 
	`ªad
(
fd
, 
buf
, (buf));

1121 i‡(
cc
 !2 || 
buf
[0] != 'f')

1123 
	`¥ötf
(1, "dd/dd/../ff wrong content\n");

1124 
	`exô
();

1126 
	`˛o£
(
fd
);

1128 i‡(
	`lök
("dd/dd/ff", "dd/dd/ffff") != 0)

1130 
	`¥ötf
(1, "link dd/dd/ff dd/dd/ffff failed\n");

1131 
	`exô
();

1134 i‡(
	`u∆ök
("dd/dd/ff") != 0)

1136 
	`¥ötf
(1, "unlink dd/dd/ff failed\n");

1137 
	`exô
();

1139 i‡(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0)

1141 
	`¥ötf
(1, "open (unlinked) dd/dd/ff succeeded\n");

1142 
	`exô
();

1145 i‡(
	`chdú
("dd") != 0)

1147 
	`¥ötf
(1, "chdir dd failed\n");

1148 
	`exô
();

1150 i‡(
	`chdú
("dd/../../dd") != 0)

1152 
	`¥ötf
(1, "chdir dd/../../dd failed\n");

1153 
	`exô
();

1155 i‡(
	`chdú
("dd/../../../dd") != 0)

1157 
	`¥ötf
(1, "chdir dd/../../dd failed\n");

1158 
	`exô
();

1160 i‡(
	`chdú
("./..") != 0)

1162 
	`¥ötf
(1, "chdir ./.. failed\n");

1163 
	`exô
();

1166 
fd
 = 
	`›í
("dd/dd/ffff", 0);

1167 i‡(
fd
 < 0)

1169 
	`¥ötf
(1, "open dd/dd/ffff failed\n");

1170 
	`exô
();

1172 i‡(
	`ªad
(
fd
, 
buf
, (buf)) != 2)

1174 
	`¥ötf
(1, "read dd/dd/ffff wrongÜen\n");

1175 
	`exô
();

1177 
	`˛o£
(
fd
);

1179 i‡(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0)

1181 
	`¥ötf
(1, "open (unlinked) dd/dd/ff succeeded!\n");

1182 
	`exô
();

1185 i‡(
	`›í
("dd/ff/ff", 
O_CREATE
 | 
O_RDWR
) >= 0)

1187 
	`¥ötf
(1, "create dd/ff/ff succeeded!\n");

1188 
	`exô
();

1190 i‡(
	`›í
("dd/xx/ff", 
O_CREATE
 | 
O_RDWR
) >= 0)

1192 
	`¥ötf
(1, "create dd/xx/ff succeeded!\n");

1193 
	`exô
();

1195 i‡(
	`›í
("dd", 
O_CREATE
) >= 0)

1197 
	`¥ötf
(1, "create dd succeeded!\n");

1198 
	`exô
();

1200 i‡(
	`›í
("dd", 
O_RDWR
) >= 0)

1202 
	`¥ötf
(1, "open ddÑdwr succeeded!\n");

1203 
	`exô
();

1205 i‡(
	`›í
("dd", 
O_WRONLY
) >= 0)

1207 
	`¥ötf
(1, "open dd wronly succeeded!\n");

1208 
	`exô
();

1210 i‡(
	`lök
("dd/ff/ff", "dd/dd/xx") == 0)

1212 
	`¥ötf
(1, "link dd/ff/ff dd/dd/xx succeeded!\n");

1213 
	`exô
();

1215 i‡(
	`lök
("dd/xx/ff", "dd/dd/xx") == 0)

1217 
	`¥ötf
(1, "link dd/xx/ff dd/dd/xx succeeded!\n");

1218 
	`exô
();

1220 i‡(
	`lök
("dd/ff", "dd/dd/ffff") == 0)

1222 
	`¥ötf
(1, "link dd/ff dd/dd/ffff succeeded!\n");

1223 
	`exô
();

1225 i‡(
	`mkdú
("dd/ff/ff") == 0)

1227 
	`¥ötf
(1, "mkdir dd/ff/ff succeeded!\n");

1228 
	`exô
();

1230 i‡(
	`mkdú
("dd/xx/ff") == 0)

1232 
	`¥ötf
(1, "mkdir dd/xx/ff succeeded!\n");

1233 
	`exô
();

1235 i‡(
	`mkdú
("dd/dd/ffff") == 0)

1237 
	`¥ötf
(1, "mkdir dd/dd/ffff succeeded!\n");

1238 
	`exô
();

1240 i‡(
	`u∆ök
("dd/xx/ff") == 0)

1242 
	`¥ötf
(1, "unlink dd/xx/ff succeeded!\n");

1243 
	`exô
();

1245 i‡(
	`u∆ök
("dd/ff/ff") == 0)

1247 
	`¥ötf
(1, "unlink dd/ff/ff succeeded!\n");

1248 
	`exô
();

1250 i‡(
	`chdú
("dd/ff") == 0)

1252 
	`¥ötf
(1, "chdir dd/ff succeeded!\n");

1253 
	`exô
();

1255 i‡(
	`chdú
("dd/xx") == 0)

1257 
	`¥ötf
(1, "chdir dd/xx succeeded!\n");

1258 
	`exô
();

1261 i‡(
	`u∆ök
("dd/dd/ffff") != 0)

1263 
	`¥ötf
(1, "unlink dd/dd/ff failed\n");

1264 
	`exô
();

1266 i‡(
	`u∆ök
("dd/ff") != 0)

1268 
	`¥ötf
(1, "unlink dd/ff failed\n");

1269 
	`exô
();

1271 i‡(
	`u∆ök
("dd") == 0)

1273 
	`¥ötf
(1, "unlinkÇon-empty dd succeeded!\n");

1274 
	`exô
();

1276 i‡(
	`u∆ök
("dd/dd") < 0)

1278 
	`¥ötf
(1, "unlink dd/dd failed\n");

1279 
	`exô
();

1281 i‡(
	`u∆ök
("dd") < 0)

1283 
	`¥ötf
(1, "unlink dd failed\n");

1284 
	`exô
();

1287 
	`¥ötf
(1, "subdir ok\n");

1288 
	}
}

1291 
	$bigwrôe
()

1293 
fd
, 
sz
;

1295 
	`¥ötf
(1, "bigwriteÅest\n");

1297 
	`u∆ök
("bigwrite");

1298 
sz
 = 499; sz < 12 * 512; sz += 471)

1300 
fd
 = 
	`›í
("bigwrôe", 
O_CREATE
 | 
O_RDWR
);

1301 i‡(
fd
 < 0)

1303 
	`¥ötf
(1, "cannot create bigwrite\n");

1304 
	`exô
();

1306 
i
;

1307 
i
 = 0; i < 2; i++)

1309 
cc
 = 
	`wrôe
(
fd
, 
buf
, 
sz
);

1310 i‡(
cc
 !
sz
)

1312 
	`¥ötf
(1, "wrôe(%dËªà%d\n", 
sz
, 
cc
);

1313 
	`exô
();

1316 
	`˛o£
(
fd
);

1317 
	`u∆ök
("bigwrite");

1320 
	`¥ötf
(1, "bigwrite ok\n");

1321 
	}
}

1323 
	$bigfûe
()

1325 
fd
, 
i
, 
tŸÆ
, 
cc
;

1327 
	`¥ötf
(1, "bigfileÅest\n");

1329 
	`u∆ök
("bigfile");

1330 
fd
 = 
	`›í
("bigfûe", 
O_CREATE
 | 
O_RDWR
);

1331 i‡(
fd
 < 0)

1333 
	`¥ötf
(1, "cannot create bigfile");

1334 
	`exô
();

1336 
i
 = 0; i < 20; i++)

1338 
	`mem£t
(
buf
, 
i
, 600);

1339 i‡(
	`wrôe
(
fd
, 
buf
, 600) != 600)

1341 
	`¥ötf
(1, "write bigfile failed\n");

1342 
	`exô
();

1345 
	`˛o£
(
fd
);

1347 
fd
 = 
	`›í
("bigfile", 0);

1348 i‡(
fd
 < 0)

1350 
	`¥ötf
(1, "cannot open bigfile\n");

1351 
	`exô
();

1353 
tŸÆ
 = 0;

1354 
i
 = 0;; i++)

1356 
cc
 = 
	`ªad
(
fd
, 
buf
, 300);

1357 i‡(
cc
 < 0)

1359 
	`¥ötf
(1, "read bigfile failed\n");

1360 
	`exô
();

1362 i‡(
cc
 == 0)

1364 i‡(
cc
 != 300)

1366 
	`¥ötf
(1, "shortÑead bigfile\n");

1367 
	`exô
();

1369 i‡(
buf
[0] !
i
 / 2 || buf[299] != i / 2)

1371 
	`¥ötf
(1, "read bigfile wrong data\n");

1372 
	`exô
();

1374 
tŸÆ
 +
cc
;

1376 
	`˛o£
(
fd
);

1377 i‡(
tŸÆ
 != 20 * 600)

1379 
	`¥ötf
(1, "read bigfile wrongÅotal\n");

1380 
	`exô
();

1382 
	`u∆ök
("bigfile");

1384 
	`¥ötf
(1, "bigfileÅest ok\n");

1385 
	}
}

1387 
	$fouπìn
()

1389 
fd
;

1392 
	`¥ötf
(1, "fourteenÅest\n");

1394 i‡(
	`mkdú
("12345678901234") != 0)

1396 
	`¥ötf
(1, "mkdir 12345678901234 failed\n");

1397 
	`exô
();

1399 i‡(
	`mkdú
("12345678901234/123456789012345") != 0)

1401 
	`¥ötf
(1, "mkdir 12345678901234/123456789012345 failed\n");

1402 
	`exô
();

1404 
fd
 = 
	`›í
("123456789012345/123456789012345/123456789012345", 
O_CREATE
);

1405 i‡(
fd
 < 0)

1407 
	`¥ötf
(1, "create 123456789012345/123456789012345/123456789012345 failed\n");

1408 
	`exô
();

1410 
	`˛o£
(
fd
);

1411 
fd
 = 
	`›í
("12345678901234/12345678901234/12345678901234", 0);

1412 i‡(
fd
 < 0)

1414 
	`¥ötf
(1, "open 12345678901234/12345678901234/12345678901234 failed\n");

1415 
	`exô
();

1417 
	`˛o£
(
fd
);

1419 i‡(
	`mkdú
("12345678901234/12345678901234") == 0)

1421 
	`¥ötf
(1, "mkdir 12345678901234/12345678901234 succeeded!\n");

1422 
	`exô
();

1424 i‡(
	`mkdú
("123456789012345/12345678901234") == 0)

1426 
	`¥ötf
(1, "mkdir 12345678901234/123456789012345 succeeded!\n");

1427 
	`exô
();

1430 
	`¥ötf
(1, "fourteen ok\n");

1431 
	}
}

1433 
	$rmdŸ
()

1435 
	`¥ötf
(1, "rmdotÅest\n");

1436 i‡(
	`mkdú
("dots") != 0)

1438 
	`¥ötf
(1, "mkdir dots failed\n");

1439 
	`exô
();

1441 i‡(
	`chdú
("dots") != 0)

1443 
	`¥ötf
(1, "chdir dots failed\n");

1444 
	`exô
();

1446 i‡(
	`u∆ök
(".") == 0)

1448 
	`¥ötf
(1, "rm . worked!\n");

1449 
	`exô
();

1451 i‡(
	`u∆ök
("..") == 0)

1453 
	`¥ötf
(1, "rm .. worked!\n");

1454 
	`exô
();

1456 i‡(
	`chdú
("/") != 0)

1458 
	`¥ötf
(1, "chdir / failed\n");

1459 
	`exô
();

1461 i‡(
	`u∆ök
("dots/.") == 0)

1463 
	`¥ötf
(1, "unlink dots/. worked!\n");

1464 
	`exô
();

1466 i‡(
	`u∆ök
("dots/..") == 0)

1468 
	`¥ötf
(1, "unlink dots/.. worked!\n");

1469 
	`exô
();

1471 i‡(
	`u∆ök
("dots") != 0)

1473 
	`¥ötf
(1, "unlink dots failed!\n");

1474 
	`exô
();

1476 
	`¥ötf
(1, "rmdot ok\n");

1477 
	}
}

1479 
	$dúfûe
()

1481 
fd
;

1483 
	`¥ötf
(1, "dir vs file\n");

1485 
fd
 = 
	`›í
("dúfûe", 
O_CREATE
);

1486 i‡(
fd
 < 0)

1488 
	`¥ötf
(1, "create dirfile failed\n");

1489 
	`exô
();

1491 
	`˛o£
(
fd
);

1492 i‡(
	`chdú
("dirfile") == 0)

1494 
	`¥ötf
(1, "chdir dirfile succeeded!\n");

1495 
	`exô
();

1497 
fd
 = 
	`›í
("dirfile/xx", 0);

1498 i‡(
fd
 >= 0)

1500 
	`¥ötf
(1, "create dirfile/xx succeeded!\n");

1501 
	`exô
();

1503 
fd
 = 
	`›í
("dúfûe/xx", 
O_CREATE
);

1504 i‡(
fd
 >= 0)

1506 
	`¥ötf
(1, "create dirfile/xx succeeded!\n");

1507 
	`exô
();

1509 i‡(
	`mkdú
("dirfile/xx") == 0)

1511 
	`¥ötf
(1, "mkdir dirfile/xx succeeded!\n");

1512 
	`exô
();

1514 i‡(
	`u∆ök
("dirfile/xx") == 0)

1516 
	`¥ötf
(1, "unlink dirfile/xx succeeded!\n");

1517 
	`exô
();

1519 i‡(
	`lök
("README", "dirfile/xx") == 0)

1521 
	`¥ötf
(1, "linkÅo dirfile/xx succeeded!\n");

1522 
	`exô
();

1524 i‡(
	`u∆ök
("dirfile") != 0)

1526 
	`¥ötf
(1, "unlink dirfile failed!\n");

1527 
	`exô
();

1530 
fd
 = 
	`›í
(".", 
O_RDWR
);

1531 i‡(
fd
 >= 0)

1533 
	`¥ötf
(1, "open . for writing succeeded!\n");

1534 
	`exô
();

1536 
fd
 = 
	`›í
(".", 0);

1537 i‡(
	`wrôe
(
fd
, "x", 1) > 0)

1539 
	`¥ötf
(1, "write . succeeded!\n");

1540 
	`exô
();

1542 
	`˛o£
(
fd
);

1544 
	`¥ötf
(1, "dir vs file OK\n");

1545 
	}
}

1548 
	$úef
()

1550 
i
, 
fd
;

1552 
	`¥ötf
(1, "empty fileÇame\n");

1555 
i
 = 0; i < 50 + 1; i++)

1557 i‡(
	`mkdú
("irefd") != 0)

1559 
	`¥ötf
(1, "mkdir irefd failed\n");

1560 
	`exô
();

1562 i‡(
	`chdú
("irefd") != 0)

1564 
	`¥ötf
(1, "chdir irefd failed\n");

1565 
	`exô
();

1568 
	`mkdú
("");

1569 
	`lök
("README", "");

1570 
fd
 = 
	`›í
("", 
O_CREATE
);

1571 i‡(
fd
 >= 0)

1572 
	`˛o£
(
fd
);

1573 
fd
 = 
	`›í
("xx", 
O_CREATE
);

1574 i‡(
fd
 >= 0)

1575 
	`˛o£
(
fd
);

1576 
	`u∆ök
("xx");

1579 
	`chdú
("/");

1580 
	`¥ötf
(1, "empty fileÇame OK\n");

1581 
	}
}

1586 
	$f‹kã°
()

1588 
n
, 
pid
;

1590 
	`¥ötf
(1, "forkÅest\n");

1592 
n
 = 0;Ç < 1000;Ç++)

1594 
pid
 = 
	`f‹k
();

1595 i‡(
pid
 < 0)

1597 i‡(
pid
 == 0)

1598 
	`exô
();

1601 i‡(
n
 == 1000)

1603 
	`¥ötf
(1, "fork claimedÅo work 1000Åimes!\n");

1604 
	`exô
();

1607 ; 
n
 > 0;Ç--)

1609 i‡(
	`waô
() < 0)

1611 
	`¥ötf
(1, "wait stoppedÉarly\n");

1612 
	`exô
();

1616 i‡(
	`waô
() != -1)

1618 
	`¥ötf
(1, "wait gotÅoo many\n");

1619 
	`exô
();

1622 
	`¥ötf
(1, "forkÅest OK\n");

1623 
	}
}

1625 
	$sbrkã°
()

1627 
fds
[2], 
pid
, 
pids
[10], 
µid
;

1628 *
a
, *
b
, *
c
, *
œ°addr
, *
ﬁdbrk
, *
p
, 
s¸©ch
;

1629 
uöt
 
amt
;

1631 
	`¥ötf
(
°dout
, "sbrkÅest\n");

1632 
ﬁdbrk
 = 
	`sbrk
(0);

1635 
a
 = 
	`sbrk
(0);

1636 
i
;

1637 
i
 = 0; i < 5000; i++)

1639 
b
 = 
	`sbrk
(1);

1640 i‡(
b
 !
a
)

1642 
	`¥ötf
(
°dout
, "sbrkÅe° faûed %d %x %x\n", 
i
, 
a
, 
b
);

1643 
	`exô
();

1645 *
b
 = 1;

1646 
a
 = 
b
 + 1;

1648 
pid
 = 
	`f‹k
();

1649 i‡(
pid
 < 0)

1651 
	`¥ötf
(
°dout
, "sbrkÅest fork failed\n");

1652 
	`exô
();

1654 
c
 = 
	`sbrk
(1);

1655 
c
 = 
	`sbrk
(1);

1656 i‡(
c
 !
a
 + 1)

1658 
	`¥ötf
(
°dout
, "sbrkÅest failedÖost-fork\n");

1659 
	`exô
();

1661 i‡(
pid
 == 0)

1662 
	`exô
();

1663 
	`waô
();

1666 
	#BIG
 (100 * 1024 * 1024)

	)

1667 
a
 = 
	`sbrk
(0);

1668 
amt
 = (
BIG
Ë- (
uöt
)
a
;

1669 
p
 = 
	`sbrk
(
amt
);

1670 i‡(
p
 !
a
)

1672 
	`¥ötf
(
°dout
, "sbrkÅest failedÅo grow bigáddress space;ÉnoughÖhys mem?\n");

1673 
	`exô
();

1675 
œ°addr
 = (*)(
BIG
 - 1);

1676 *
œ°addr
 = 99;

1679 
a
 = 
	`sbrk
(0);

1680 
c
 = 
	`sbrk
(-4096);

1681 i‡(
c
 == (*)0xffffffff)

1683 
	`¥ötf
(
°dout
, "sbrk couldÇot deallocate\n");

1684 
	`exô
();

1686 
c
 = 
	`sbrk
(0);

1687 i‡(
c
 !
a
 - 4096)

1689 
	`¥ötf
(
°dout
, "sbrk dóŒoˇti⁄Örodu˚d wr⁄gáddªss,á %x c %x\n", 
a
, 
c
);

1690 
	`exô
();

1694 
a
 = 
	`sbrk
(0);

1695 
c
 = 
	`sbrk
(4096);

1696 i‡(
c
 !
a
 || 
	`sbrk
(0) !=á + 4096)

1698 
	`¥ötf
(
°dout
, "sbrkÑe-Æloˇti⁄ faûed,á %x c %x\n", 
a
, 
c
);

1699 
	`exô
();

1701 i‡(*
œ°addr
 == 99)

1704 
	`¥ötf
(
°dout
, "sbrk de-allocation didn'tÑeally deallocate\n");

1705 
	`exô
();

1708 
a
 = 
	`sbrk
(0);

1709 
c
 = 
	`sbrk
(-(sbrk(0Ë- 
ﬁdbrk
));

1710 i‡(
c
 !
a
)

1712 
	`¥ötf
(
°dout
, "sbrk downsizêÁûed,á %x c %x\n", 
a
, 
c
);

1713 
	`exô
();

1717 
a
 = (*)(
KERNBASE
);á < (*)(KERNBASE + 2000000);á += 50000)

1719 
µid
 = 
	`gëpid
();

1720 
pid
 = 
	`f‹k
();

1721 i‡(
pid
 < 0)

1723 
	`¥ötf
(
°dout
, "fork failed\n");

1724 
	`exô
();

1726 i‡(
pid
 == 0)

1728 
	`¥ötf
(
°dout
, "o›†couldÑód %x = %x\n", 
a
, *a);

1729 
	`kûl
(
µid
);

1730 
	`exô
();

1732 
	`waô
();

1737 i‡(
	`pùe
(
fds
) != 0)

1739 
	`¥ötf
(1, "pipe() failed\n");

1740 
	`exô
();

1742 
i
 = 0; i < (
pids
) / (pids[0]); i++)

1744 i‡((
pids
[
i
] = 
	`f‹k
()) == 0)

1747 
	`sbrk
(
BIG
 - (
uöt
)sbrk(0));

1748 
	`wrôe
(
fds
[1], "x", 1);

1751 
	`¶ìp
(1000);

1753 i‡(
pids
[
i
] != -1)

1754 
	`ªad
(
fds
[0], &
s¸©ch
, 1);

1758 
c
 = 
	`sbrk
(4096);

1759 
i
 = 0; i < (
pids
) / (pids[0]); i++)

1761 i‡(
pids
[
i
] == -1)

1763 
	`kûl
(
pids
[
i
]);

1764 
	`waô
();

1766 i‡(
c
 == (*)0xffffffff)

1768 
	`¥ötf
(
°dout
, "failed sbrkÜeaked memory\n");

1769 
	`exô
();

1772 i‡(
	`sbrk
(0Ë> 
ﬁdbrk
)

1773 
	`sbrk
(-(sbrk(0Ë- 
ﬁdbrk
));

1775 
	`¥ötf
(
°dout
, "sbrkÅest OK\n");

1776 
	}
}

1778 
	$vÆid©eöt
(*
p
)

1780 
ªs
;

1781 
	`asm
("mov %%esp, %%ebx\n\t"

1785 : "˜"(
ªs
)

1786 : "a"(
SYS_¶ìp
), "n"(
T_SYSCALL
), "c"(
p
)

1788 
	}
}

1790 
	$vÆid©ëe°
()

1792 
hi
, 
pid
;

1793 
uöt
 
p
;

1795 
	`¥ötf
(
°dout
, "validateÅest\n");

1796 
hi
 = 1100 * 1024;

1798 
p
 = 0;Ö <(
uöt
)
hi
;Ö += 4096)

1800 i‡((
pid
 = 
	`f‹k
()) == 0)

1803 
	`vÆid©eöt
((*)
p
);

1804 
	`exô
();

1806 
	`¶ìp
(0);

1807 
	`¶ìp
(0);

1808 
	`kûl
(
pid
);

1809 
	`waô
();

1812 i‡(
	`lök
("nosuchfûe", (*)
p
) != -1)

1814 
	`¥ötf
(
°dout
, "link shouldÇot succeed\n");

1815 
	`exô
();

1819 
	`¥ötf
(
°dout
, "validate ok\n");

1820 
	}
}

1823 
	gunöô
[10000];

1824 
	$bs°e°
()

1826 
i
;

1828 
	`¥ötf
(
°dout
, "bssÅest\n");

1829 
i
 = 0; i < (
unöô
); i++)

1831 i‡(
unöô
[
i
] != '\0')

1833 
	`¥ötf
(
°dout
, "bssÅest failed\n");

1834 
	`exô
();

1837 
	`¥ötf
(
°dout
, "bssÅest ok\n");

1838 
	}
}

1843 
	$big¨gã°
()

1845 
pid
, 
fd
;

1847 
	`u∆ök
("bigarg-ok");

1848 
pid
 = 
	`f‹k
();

1849 i‡(
pid
 == 0)

1851 *
¨gs
[
MAXARG
];

1852 
i
;

1853 
i
 = 0; i < 
MAXARG
 - 1; i++)

1854 
¨gs
[
i
] = "bigargsÅest: failed\n ";

1855 
¨gs
[
MAXARG
 - 1] = 0;

1856 
	`¥ötf
(
°dout
, "bigargÅest\n");

1857 
	`exec
("echo", 
¨gs
);

1858 
	`¥ötf
(
°dout
, "bigargÅest ok\n");

1859 
fd
 = 
	`›í
("big¨g-ok", 
O_CREATE
);

1860 
	`˛o£
(
fd
);

1861 
	`exô
();

1863 i‡(
pid
 < 0)

1865 
	`¥ötf
(
°dout
, "bigargtest: fork failed\n");

1866 
	`exô
();

1868 
	`waô
();

1869 
fd
 = 
	`›í
("bigarg-ok", 0);

1870 i‡(
fd
 < 0)

1872 
	`¥ötf
(
°dout
, "bigargÅest failed!\n");

1873 
	`exô
();

1875 
	`˛o£
(
fd
);

1876 
	`u∆ök
("bigarg-ok");

1877 
	}
}

1881 
	$fsfuŒ
()

1883 
nfûes
;

1884 
fsblocks
 = 0;

1886 
	`¥ötf
(1, "fsfullÅest\n");

1888 
nfûes
 = 0;;Çfiles++)

1890 
«me
[64];

1891 
«me
[0] = 'f';

1892 
«me
[1] = '0' + 
nfûes
 / 1000;

1893 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

1894 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

1895 
«me
[4] = '0' + (
nfûes
 % 10);

1896 
«me
[5] = '\0';

1897 
	`¥ötf
(1, "wrôög %s\n", 
«me
);

1898 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

1899 i‡(
fd
 < 0)

1901 
	`¥ötf
(1, "›í %†Áûed\n", 
«me
);

1904 
tŸÆ
 = 0;

1907 
cc
 = 
	`wrôe
(
fd
, 
buf
, 512);

1908 i‡(
cc
 < 512)

1910 
tŸÆ
 +
cc
;

1911 
fsblocks
++;

1913 
	`¥ötf
(1, "wrŸê%d byãs\n", 
tŸÆ
);

1914 
	`˛o£
(
fd
);

1915 i‡(
tŸÆ
 == 0)

1919 
nfûes
 >= 0)

1921 
«me
[64];

1922 
«me
[0] = 'f';

1923 
«me
[1] = '0' + 
nfûes
 / 1000;

1924 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

1925 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

1926 
«me
[4] = '0' + (
nfûes
 % 10);

1927 
«me
[5] = '\0';

1928 
	`u∆ök
(
«me
);

1929 
nfûes
--;

1932 
	`¥ötf
(1, "fsfullÅest finished\n");

1933 
	}
}

1935 
	$uio
()

1937 
	#RTC_ADDR
 0x70

	)

1938 
	#RTC_DATA
 0x71

	)

1940 
ush‹t
 
p‹t
 = 0;

1941 
uch¨
 
vÆ
 = 0;

1942 
pid
;

1944 
	`¥ötf
(1, "uioÅest\n");

1945 
pid
 = 
	`f‹k
();

1946 i‡(
pid
 == 0)

1948 
p‹t
 = 
RTC_ADDR
;

1949 
vÆ
 = 0x09;

1951 
asm
 vﬁ©ûe("outb %0,%1" ::"a"(
vÆ
), "d"(
p‹t
));

1952 
p‹t
 = 
RTC_DATA
;

1953 
asm
 volatile("inb %1,%0"

1954 : "˜"(
vÆ
)

1955 : "d"(
p‹t
));

1956 
	`¥ötf
(1, "uio: uio succeeded;Åest FAILED\n");

1957 
	`exô
();

1959 i‡(
pid
 < 0)

1961 
	`¥ötf
(1, "fork failed\n");

1962 
	`exô
();

1964 
	`waô
();

1965 
	`¥ötf
(1, "uioÅest done\n");

1966 
	}
}

1968 
	$¨g±e°
()

1970 
fd
;

1971 
fd
 = 
	`›í
("öô", 
O_RDONLY
);

1972 i‡(
fd
 < 0)

1974 
	`¥ötf
(2, "open failed\n");

1975 
	`exô
();

1977 
	`ªad
(
fd
, 
	`sbrk
(0) - 1, -1);

1978 
	`˛o£
(
fd
);

1979 
	`¥ötf
(1, "argÅestÖassed\n");

1980 
	}
}

1982 
	gønd°©e
 = 1;

1984 
	$ønd
()

1986 
ønd°©e
 =Ñandstate * 1664525 + 1013904223;

1987  
ønd°©e
;

1988 
	}
}

1990 
	$maö
(
¨gc
, *
¨gv
[])

1992 
	`¥ötf
(1, "usertests starting\n");

1994 i‡(
	`›í
("usertests.ran", 0) >= 0)

1996 
	`¥ötf
(1, "alreadyÑan userÅests --Ñebuild fs.img\n");

1997 
	`exô
();

1999 
	`˛o£
(
	`›í
("u£πe°s.øn", 
O_CREATE
));

2001 
	`¨g±e°
();

2002 
	`¸óãdñëe
();

2003 
	`löku∆ök
();

2004 
	`c⁄¸óã
();

2005 
	`fourfûes
();

2006 
	`sh¨edfd
();

2008 
	`big¨gã°
();

2009 
	`bigwrôe
();

2010 
	`big¨gã°
();

2011 
	`bs°e°
();

2012 
	`sbrkã°
();

2013 
	`vÆid©ëe°
();

2015 
	`›íã°
();

2016 
	`wrôëe°
();

2017 
	`wrôëe°1
();

2018 
	`¸óãã°
();

2020 
	`›íùuâe°
();

2021 
	`exôùuâe°
();

2022 
	`ùuâe°
();

2024 
	`mem
();

2025 
	`pùe1
();

2026 
	`¥ìm±
();

2027 
	`exôwaô
();

2029 
	`rmdŸ
();

2030 
	`fouπìn
();

2031 
	`bigfûe
();

2032 
	`subdú
();

2033 
	`lökã°
();

2034 
	`u∆ökªad
();

2035 
	`dúfûe
();

2036 
	`úef
();

2037 
	`f‹kã°
();

2038 
	`bigdú
();

2040 
	`uio
();

2042 
	`exe˘e°
();

2044 
	`exô
();

2045 
	}
}

	@usys.S

1 
	~"sysˇŒ.h
"

2 
	~"å≠s.h
"

4 
	#SYSCALL
(
«me
) \

5 .
globl
 
«me
; \

6 
«me
: \

7 
movl
 
$SYS_
 ## 
«me
, %
óx
; \

8 
$T_SYSCALL
; \

9 
ªt


	)

11 
	$SYSCALL
(
f‹k
)

12 
	$SYSCALL
(
exô
)

13 
	$SYSCALL
(
waô
)

14 
	$SYSCALL
(
pùe
)

15 
	$SYSCALL
(
ªad
)

16 
	$SYSCALL
(
wrôe
)

17 
	$SYSCALL
(
˛o£
)

18 
	$SYSCALL
(
kûl
)

19 
	$SYSCALL
(
exec
)

20 
	$SYSCALL
(
›í
)

21 
	$SYSCALL
(
mknod
)

22 
	$SYSCALL
(
u∆ök
)

23 
	$SYSCALL
(
f°©
)

24 
	$SYSCALL
(
lök
)

25 
	$SYSCALL
(
mkdú
)

26 
	$SYSCALL
(
chdú
)

27 
	$SYSCALL
(
dup
)

28 
	$SYSCALL
(
gëpid
)

29 
	$SYSCALL
(
sbrk
)

30 
	$SYSCALL
(
¶ìp
)

31 
	`SYSCALL
(
u±ime
)

	@vm.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"defs.h
"

4 
	~"x86.h
"

5 
	~"memœyout.h
"

6 
	~"mmu.h
"

7 
	~"¥oc.h
"

8 
	~"ñf.h
"

10 
d©a
[];

11 
pde_t
 *
	gkpgdú
;

15 
	$£göô
()

17 
˝u
 *
c
;

23 
c
 = &
˝us
[
	`˝uid
()];

24 
c
->
gdt
[
SEG_KCODE
] = 
	`SEG
(
STA_X
 | 
STA_R
, 0, 0xffffffff, 0);

25 
c
->
gdt
[
SEG_KDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 0);

26 
c
->
gdt
[
SEG_UCODE
] = 
	`SEG
(
STA_X
 | 
STA_R
, 0, 0xffffffff, 
DPL_USER
);

27 
c
->
gdt
[
SEG_UDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 
DPL_USER
);

28 
	`lgdt
(
c
->
gdt
, (c->gdt));

29 
	}
}

34 
±e_t
 *

35 
	$wÆkpgdú
(
pde_t
 *
pgdú
, c⁄° *
va
, 
Æloc
)

37 
pde_t
 *
pde
;

38 
±e_t
 *
pgèb
;

40 
pde
 = &
pgdú
[
	`PDX
(
va
)];

41 i‡(*
pde
 & 
PTE_P
)

43 
pgèb
 = (
±e_t
 *)
	`P2V
(
	`PTE_ADDR
(*
pde
));

47 i‡(!
Æloc
 || (
pgèb
 = (
±e_t
 *)
	`kÆloc
()) == 0)

50 
	`mem£t
(
pgèb
, 0, 
PGSIZE
);

54 *
pde
 = 
	`V2P
(
pgèb
Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_U
;

56  &
pgèb
[
	`PTX
(
va
)];

57 
	}
}

63 
	$m≠∑ges
(
pde_t
 *
pgdú
, *
va
, 
uöt
 
size
, uöà
∑
, 
≥rm
)

65 *
a
, *
œ°
;

66 
±e_t
 *
±e
;

68 
a
 = (*)
	`PGROUNDDOWN
((
uöt
)
va
);

69 
œ°
 = (*)
	`PGROUNDDOWN
(((
uöt
)
va
Ë+ 
size
 - 1);

72 i‡((
±e
 = 
	`wÆkpgdú
(
pgdú
, 
a
, 1)) == 0)

74 i‡(*
±e
 & 
PTE_P
)

75 
	`∑nic
("remap");

76 *
±e
 = 
∑
 | 
≥rm
 | 
PTE_P
;

77 i‡(
a
 =
œ°
)

79 
a
 +
PGSIZE
;

80 
∑
 +
PGSIZE
;

83 
	}
}

108 
	skm≠


110 *
	mvút
;

111 
uöt
 
	mphys_°¨t
;

112 
uöt
 
	mphys_íd
;

113 
	m≥rm
;

114 } 
	gkm≠
[] = {

115 {(*)
KERNBASE
, 0, 
EXTMEM
, 
PTE_W
},

116 {(*)
KERNLINK
, 
V2P
(KERNLINK), V2P(
d©a
), 0},

117 {(*)
d©a
, 
V2P
(d©a), 
PHYSTOP
, 
PTE_W
},

118 {(*)
DEVSPACE
, DEVSPACE, 0, 
PTE_W
},

122 
pde_t
 *

123 
	$£tupkvm
()

125 
pde_t
 *
pgdú
;

126 
km≠
 *
k
;

128 i‡((
pgdú
 = (
pde_t
 *)
	`kÆloc
()) == 0)

130 
	`mem£t
(
pgdú
, 0, 
PGSIZE
);

131 i‡(
	`P2V
(
PHYSTOP
Ë> (*)
DEVSPACE
)

132 
	`∑nic
("PHYSTOPÅoo high");

133 
k
 = 
km≠
; k < &km≠[
	`NELEM
(kmap)]; k++)

134 i‡(
	`m≠∑ges
(
pgdú
, 
k
->
vút
, k->
phys_íd
 - k->
phys_°¨t
,

135 (
uöt
)
k
->
phys_°¨t
, k->
≥rm
) < 0)

137 
	`‰ìvm
(
pgdú
);

140  
pgdú
;

141 
	}
}

145 
	$kvmÆloc
()

147 
kpgdú
 = 
	`£tupkvm
();

148 
	`swôchkvm
();

149 
	}
}

153 
	$swôchkvm
()

155 
	`l¸3
(
	`V2P
(
kpgdú
));

156 
	}
}

159 
	$swôchuvm
(
¥oc
 *
p
)

161 i‡(
p
 == 0)

162 
	`∑nic
("switchuvm:ÇoÖrocess");

163 i‡(
p
->
k°ack
 == 0)

164 
	`∑nic
("switchuvm:Ço kstack");

165 i‡(
p
->
pgdú
 == 0)

166 
	`∑nic
("switchuvm:ÇoÖgdir");

168 
	`push˛i
();

169 
	`my˝u
()->
gdt
[
SEG_TSS
] = 
	`SEG16
(
STS_T32A
, &my˝u()->
ts
,

170 (
	`my˝u
()->
ts
) - 1, 0);

171 
	`my˝u
()->
gdt
[
SEG_TSS
].
s
 = 0;

172 
	`my˝u
()->
ts
.
ss0
 = 
SEG_KDATA
 << 3;

173 
	`my˝u
()->
ts
.
e•0
 = (
uöt
)
p
->
k°ack
 + 
KSTACKSIZE
;

176 
	`my˝u
()->
ts
.
iomb
 = (
ush‹t
)0xFFFF;

177 
	`…r
(
SEG_TSS
 << 3);

178 
	`l¸3
(
	`V2P
(
p
->
pgdú
));

179 
	`p›˛i
();

180 
	}
}

184 
	$öôuvm
(
pde_t
 *
pgdú
, *
öô
, 
uöt
 
sz
)

186 *
mem
;

188 i‡(
sz
 >
PGSIZE
)

189 
	`∑nic
("inituvm: moreÅhanáÖage");

190 
mem
 = 
	`kÆloc
();

191 
	`mem£t
(
mem
, 0, 
PGSIZE
);

192 
	`m≠∑ges
(
pgdú
, 0, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
 | 
PTE_U
);

193 
	`memmove
(
mem
, 
öô
, 
sz
);

194 
	}
}

198 
	$lﬂduvm
(
pde_t
 *
pgdú
, *
addr
, 
öode
 *
ù
, 
uöt
 
off£t
, uöà
sz
)

200 
uöt
 
i
, 
∑
, 
n
;

201 
±e_t
 *
±e
;

203 i‡((
uöt
)
addr
 % 
PGSIZE
 != 0)

204 
	`∑nic
("loaduvm:áddr must beÖageáligned");

205 
i
 = 0; i < 
sz
; i +
PGSIZE
)

207 i‡((
±e
 = 
	`wÆkpgdú
(
pgdú
, 
addr
 + 
i
, 0)) == 0)

208 
	`∑nic
("loaduvm:áddress shouldÉxist");

209 
∑
 = 
	`PTE_ADDR
(*
±e
);

210 i‡(
sz
 - 
i
 < 
PGSIZE
)

211 
n
 = 
sz
 - 
i
;

213 
n
 = 
PGSIZE
;

214 i‡(
	`ªadi
(
ù
, 
	`P2V
(
∑
), 
off£t
 + 
i
, 
n
) !=Ç)

218 
	}
}

222 
	$Ælocuvm
(
pde_t
 *
pgdú
, 
uöt
 
ﬁdsz
, uöà
√wsz
)

224 *
mem
;

225 
uöt
 
a
;

227 i‡(
√wsz
 >
KERNBASE
)

229 i‡(
√wsz
 < 
ﬁdsz
)

230  
ﬁdsz
;

232 
a
 = 
	`PGROUNDUP
(
ﬁdsz
);

233 ; 
a
 < 
√wsz
;á +
PGSIZE
)

235 
mem
 = 
	`kÆloc
();

236 i‡(
mem
 == 0)

238 
	`˝rötf
("allocuvm out of memory\n");

239 
	`dóŒocuvm
(
pgdú
, 
√wsz
, 
ﬁdsz
);

242 
	`mem£t
(
mem
, 0, 
PGSIZE
);

243 i‡(
	`m≠∑ges
(
pgdú
, (*)
a
, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
 | 
PTE_U
) < 0)

245 
	`˝rötf
("allocuvm out of memory (2)\n");

246 
	`dóŒocuvm
(
pgdú
, 
√wsz
, 
ﬁdsz
);

247 
	`k‰ì
(
mem
);

251  
√wsz
;

252 
	}
}

258 
	$dóŒocuvm
(
pde_t
 *
pgdú
, 
uöt
 
ﬁdsz
, uöà
√wsz
)

260 
±e_t
 *
±e
;

261 
uöt
 
a
, 
∑
;

263 i‡(
√wsz
 >
ﬁdsz
)

264  
ﬁdsz
;

266 
a
 = 
	`PGROUNDUP
(
√wsz
);

267 ; 
a
 < 
ﬁdsz
;á +
PGSIZE
)

269 
±e
 = 
	`wÆkpgdú
(
pgdú
, (*)
a
, 0);

270 i‡(!
±e
)

271 
a
 = 
	`PGADDR
(
	`PDX
◊Ë+ 1, 0, 0Ë- 
PGSIZE
;

272 i‡((*
±e
 & 
PTE_P
) != 0)

274 
∑
 = 
	`PTE_ADDR
(*
±e
);

275 i‡(
∑
 == 0)

276 
	`∑nic
("kfree");

277 *
v
 = 
	`P2V
(
∑
);

278 
	`k‰ì
(
v
);

279 *
±e
 = 0;

282  
√wsz
;

283 
	}
}

287 
	$‰ìvm
(
pde_t
 *
pgdú
)

289 
uöt
 
i
;

291 i‡(
pgdú
 == 0)

292 
	`∑nic
("freevm:ÇoÖgdir");

293 
	`dóŒocuvm
(
pgdú
, 
KERNBASE
, 0);

294 
i
 = 0; i < 
NPDENTRIES
; i++)

296 i‡(
pgdú
[
i
] & 
PTE_P
)

298 *
v
 = 
	`P2V
(
	`PTE_ADDR
(
pgdú
[
i
]));

299 
	`k‰ì
(
v
);

302 
	`k‰ì
((*)
pgdú
);

303 
	}
}

307 
	$˛óΩãu
(
pde_t
 *
pgdú
, *
uva
)

309 
±e_t
 *
±e
;

311 
±e
 = 
	`wÆkpgdú
(
pgdú
, 
uva
, 0);

312 i‡(
±e
 == 0)

313 
	`∑nic
("clearpteu");

314 *
±e
 &~
PTE_U
;

315 
	}
}

319 
pde_t
 *

320 
	$c›yuvm
(
pde_t
 *
pgdú
, 
uöt
 
sz
)

322 
pde_t
 *
d
;

323 
±e_t
 *
±e
;

324 
uöt
 
∑
, 
i
, 
Êags
;

325 *
mem
;

327 i‡((
d
 = 
	`£tupkvm
()) == 0)

329 
i
 = 0; i < 
sz
; i +
PGSIZE
)

331 i‡((
±e
 = 
	`wÆkpgdú
(
pgdú
, (*)
i
, 0)) == 0)

332 
	`∑nic
("copyuvm:Öte shouldÉxist");

333 i‡(!(*
±e
 & 
PTE_P
))

334 
	`∑nic
("copyuvm:ÖageÇotÖresent");

335 
∑
 = 
	`PTE_ADDR
(*
±e
);

336 
Êags
 = 
	`PTE_FLAGS
(*
±e
);

337 i‡((
mem
 = 
	`kÆloc
()) == 0)

338 
bad
;

339 
	`memmove
(
mem
, (*)
	`P2V
(
∑
), 
PGSIZE
);

340 i‡(
	`m≠∑ges
(
d
, (*)
i
, 
PGSIZE
, 
	`V2P
(
mem
), 
Êags
) < 0)

342 
	`k‰ì
(
mem
);

343 
bad
;

346  
d
;

348 
bad
:

349 
	`‰ìvm
(
d
);

351 
	}
}

356 
	$uva2ka
(
pde_t
 *
pgdú
, *
uva
)

358 
±e_t
 *
±e
;

360 
±e
 = 
	`wÆkpgdú
(
pgdú
, 
uva
, 0);

361 i‡((*
±e
 & 
PTE_P
) == 0)

363 i‡((*
±e
 & 
PTE_U
) == 0)

365  (*)
	`P2V
(
	`PTE_ADDR
(*
±e
));

366 
	}
}

371 
	$c›yout
(
pde_t
 *
pgdú
, 
uöt
 
va
, *
p
, uöà
Àn
)

373 *
buf
, *
∑0
;

374 
uöt
 
n
, 
va0
;

376 
buf
 = (*)
p
;

377 
Àn
 > 0)

379 
va0
 = (
uöt
)
	`PGROUNDDOWN
(
va
);

380 
∑0
 = 
	`uva2ka
(
pgdú
, (*)
va0
);

381 i‡(
∑0
 == 0)

383 
n
 = 
PGSIZE
 - (
va
 - 
va0
);

384 i‡(
n
 > 
Àn
)

385 
n
 = 
Àn
;

386 
	`memmove
(
∑0
 + (
va
 - 
va0
), 
buf
, 
n
);

387 
Àn
 -
n
;

388 
buf
 +
n
;

389 
va
 = 
va0
 + 
PGSIZE
;

392 
	}
}

	@wc.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	gbuf
[512];

7 
	$wc
(
fd
, *
«me
)

9 
i
, 
n
;

10 
l
, 
w
, 
c
, 
öw‹d
;

12 
l
 = 
w
 = 
c
 = 0;

13 
öw‹d
 = 0;

14 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

16 
i
 = 0; i < 
n
; i++)

18 
c
++;

19 i‡(
buf
[
i
] == '\n')

20 
l
++;

21 i‡(
	`°rchr
(" \r\t\n\v", 
buf
[
i
]))

22 
öw‹d
 = 0;

23 i‡(!
öw‹d
)

25 
w
++;

26 
öw‹d
 = 1;

30 i‡(
n
 < 0)

32 
	`¥ötf
(1, "wc:ÑeadÉrror\n");

33 
	`exô
();

35 
	`¥ötf
(1, "%d %d %d %s\n", 
l
, 
w
, 
c
, 
«me
);

36 
	}
}

38 
	$maö
(
¨gc
, *
¨gv
[])

40 
fd
, 
i
;

42 i‡(
¨gc
 <= 1)

44 
	`wc
(0, "");

45 
	`exô
();

48 
i
 = 1; i < 
¨gc
; i++)

50 i‡((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0)

52 
	`¥ötf
(1, "wc: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

53 
	`exô
();

55 
	`wc
(
fd
, 
¨gv
[
i
]);

56 
	`˛o£
(
fd
);

58 
	`exô
();

59 
	}
}

	@x86.h

3 
ölöe
 
uch¨


4 
	$öb
(
ush‹t
 
p‹t
)

6 
uch¨
 
d©a
;

8 
asm
 volatile("in %1,%0"

9 : "˜"(
d©a
)

10 : "d"(
p‹t
));

11  
d©a
;

12 
	}
}

14 
ölöe
 

15 
	$ö¶
(
p‹t
, *
addr
, 
˙t
)

17 
asm
 volatile("cld;Ñep insl"

18 : "=D"(
addr
), "=c"(
˙t
)

19 : "d"(
p‹t
), "0"(
addr
), "1"(
˙t
)

21 
	}
}

23 
ölöe
 

24 
	$outb
(
ush‹t
 
p‹t
, 
uch¨
 
d©a
)

26 
asm
 volatile("out %0,%1"

28 : "a"(
d©a
), "d"(
p‹t
));

29 
	}
}

31 
ölöe
 

32 
	$outw
(
ush‹t
 
p‹t
, ush‹à
d©a
)

34 
asm
 volatile("out %0,%1"

36 : "a"(
d©a
), "d"(
p‹t
));

37 
	}
}

39 
ölöe
 

40 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
)

42 
asm
 volatile("cld;Ñep outsl"

43 : "=S"(
addr
), "=c"(
˙t
)

44 : "d"(
p‹t
), "0"(
addr
), "1"(
˙t
)

46 
	}
}

48 
ölöe
 

49 
	$°osb
(*
addr
, 
d©a
, 
˙t
)

51 
asm
 volatile("cld;Ñep stosb"

52 : "=D"(
addr
), "=c"(
˙t
)

53 : "0"(
addr
), "1"(
˙t
), "a"(
d©a
)

55 
	}
}

57 
ölöe
 

58 
	$°o¶
(*
addr
, 
d©a
, 
˙t
)

60 
asm
 volatile("cld;Ñep stosl"

61 : "=D"(
addr
), "=c"(
˙t
)

62 : "0"(
addr
), "1"(
˙t
), "a"(
d©a
)

64 
	}
}

66 
	g£gdesc
;

68 
ölöe
 

69 
	$lgdt
(
£gdesc
 *
p
, 
size
)

71 vﬁ©ûê
ush‹t
 
pd
[3];

73 
pd
[0] = 
size
 - 1;

74 
pd
[1] = (
uöt
)
p
;

75 
pd
[2] = (
uöt
)
p
 >> 16;

77 
asm
 volatile("lgdt (%0)"

79 : "r"(
pd
));

80 
	}
}

82 
	gg©edesc
;

84 
ölöe
 

85 
	$lidt
(
g©edesc
 *
p
, 
size
)

87 vﬁ©ûê
ush‹t
 
pd
[3];

89 
pd
[0] = 
size
 - 1;

90 
pd
[1] = (
uöt
)
p
;

91 
pd
[2] = (
uöt
)
p
 >> 16;

93 
asm
 volatile("lidt (%0)"

95 : "r"(
pd
));

96 
	}
}

98 
ölöe
 

99 
	$…r
(
ush‹t
 
£l
)

101 
asm
 volatile("ltr %0"

103 : "r"(
£l
));

104 
	}
}

106 
ölöe
 
uöt


107 
	$ªadeÊags
()

109 
uöt
 
eÊags
;

110 
asm
 volatile("pushfl;Öopl %0"

111 : "Ù"(
eÊags
));

112  
eÊags
;

113 
	}
}

115 
ölöe
 

116 
	$lﬂdgs
(
ush‹t
 
v
)

118 
asm
 volatile("movw %0, %%gs"

120 : "r"(
v
));

121 
	}
}

123 
ölöe
 

124 
	$˛i
()

126 
asm
 volatile("cli");

127 
	}
}

129 
ölöe
 

130 
	$°i
()

132 
asm
 volatile("sti");

133 
	}
}

135 
ölöe
 
uöt


136 
	$xchg
(vﬁ©ûê
uöt
 *
addr
, uöà
√wvÆ
)

138 
uöt
 
ªsu…
;

141 
asm
 volatile("lock; xchgl %0, %1"

142 : "+m"(*
addr
), "˜"(
ªsu…
)

143 : "1"(
√wvÆ
)

145  
ªsu…
;

146 
	}
}

148 
ölöe
 
uöt


149 
	$r¸2
()

151 
uöt
 
vÆ
;

152 
asm
 volatile("movl %%cr2,%0"

153 : "Ù"(
vÆ
));

154  
vÆ
;

155 
	}
}

157 
ölöe
 

158 
	$l¸3
(
uöt
 
vÆ
)

160 
asm
 volatile("movl %0,%%cr3"

162 : "r"(
vÆ
));

163 
	}
}

168 
	så≠‰ame


171 
uöt
 
	medi
;

172 
uöt
 
	mesi
;

173 
uöt
 
	mebp
;

174 
uöt
 
	m€•
;

175 
uöt
 
	mebx
;

176 
uöt
 
	medx
;

177 
uöt
 
	mecx
;

178 
uöt
 
	móx
;

181 
ush‹t
 
	mgs
;

182 
ush‹t
 
	m∑ddög1
;

183 
ush‹t
 
	mfs
;

184 
ush‹t
 
	m∑ddög2
;

185 
ush‹t
 
	mes
;

186 
ush‹t
 
	m∑ddög3
;

187 
ush‹t
 
	mds
;

188 
ush‹t
 
	m∑ddög4
;

189 
uöt
 
	må≠no
;

192 
uöt
 
	mîr
;

193 
uöt
 
	meù
;

194 
ush‹t
 
	mcs
;

195 
ush‹t
 
	m∑ddög5
;

196 
uöt
 
	meÊags
;

199 
uöt
 
	me•
;

200 
ush‹t
 
	mss
;

201 
ush‹t
 
	m∑ddög6
;

	@zombie.c

4 
	~"ty≥s.h
"

5 
	~"°©.h
"

6 
	~"u£r.h
"

8 
	$maö
()

10 i‡(
	`f‹k
() > 0)

11 
	`¶ìp
(5);

12 
	`exô
();

13 
	}
}

	@
1
.
0
75
590
asm.h
bio.c
bootasm.S
bootmain.c
buf.h
cat.c
console.c
date.h
defs.h
echo.c
elf.h
entry.S
entryother.S
exec.c
fcntl.h
file.c
file.h
forktest.c
fs.c
fs.h
grep.c
ide.c
init.c
initcode.S
ioapic.c
kalloc.c
kbd.c
kbd.h
kill.c
lapic.c
ln.c
log.c
ls.c
main.c
memide.c
memlayout.h
mkdir.c
mkfs.c
mmu.h
mp.c
mp.h
param.h
picirq.c
pipe.c
printf.c
proc.c
proc.h
rm.c
sh.c
sleeplock.c
sleeplock.h
spinlock.c
spinlock.h
stat.h
stressfs.c
string.c
swtch.S
syscall.c
syscall.h
sysfile.c
sysproc.c
trap.c
trapasm.S
traps.h
types.h
uart.c
ulib.c
umalloc.c
user.h
usertests.c
usys.S
vm.c
wc.c
x86.h
zombie.c
